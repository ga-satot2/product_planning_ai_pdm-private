# 決済後連携確認ポイント

## 概要

明和・ライブズ販売において、クラウドサインで締結した契約書を手作業でアップロードした後のシステム連携について、確認した内容とオペレーション手順をまとめます。

---

## 決済オペレーション上の不安と解決方法

### 不安点

1. **契約書アップロード後、ステータスが自動的に更新されない**
2. **MANAGE連携の前提条件（`ArticleManagementContract`の作成）が満たされない可能性がある**
3. **決済完了処理が正常に実行されるか不明**

### 解決方法（根本さん確認済み）

#### 作業手順

1. **クラウドサインで売契締結後**
2. **契約ページで契約書アップ**
   - 契約詳細ページから契約書をアップロード
3. **案件ページで申込（社内手続）の結果登録をすることで、契約報告を流してもらう**
   - 活動結果として「契約」を登録すると、ステータスが`loan_preparation`（ローン準備中）に更新される

**注意**: 決済予定日にウォッチが必要

---

## 確認済みの処理フロー

### 1. 契約書アップロード → FLOW連携

1. **契約書アップロード**: クラウドサインで締結した契約書を手作業でAGNTにアップロード
   - コントローラー: `repositories/backend/verdandi/app/controllers/contract_files_controller.rb`
   - 処理: 契約書ファイルをS3にアップロードし、`ContractFile`レコードを作成
   - **ステータス更新は行われない**

2. **FLOW側のデータ取得**: FLOW側がAGNTからデータを取得する方式
   - API: `repositories/tools/flow_by_renosy/app/controllers/api/customer_settlements_controller.rb`
   - タイミング: **買主決済日の翌日17時にバッチが走る**との認識（実装箇所は未確認）

3. **FLOW→AGNT連携**: 決済完了時にFLOW側からAGNTに通知
   - API: `repositories/backend/verdandi/app/controllers/flow_by_renosy_api/v1/contracts/update_status_to_paids_controller.rb`
   - ジョブ: `UpdateContractStatusToPaidJob` → `Flow::Contract.to_paid`で契約ステータスを`paid`に更新
   - 条件: `closable?`が`true`（`loan_preparation`または`loan_judgment`の時）

### 2. FLOW→MANAGE連携

1. **トリガー**: FLOW側の`Sale`のステータスが`checking_statement`から`statement_checked`に遷移
2. **処理**: `Sale#update_manage_contract_data` → `UpdateManageContractDataJob`
3. **送信**: MANAGE側の`/api/v1/contracts/#{supplier_article_id}/update_with_flow_data`にPATCHリクエスト
4. **受信データ**: `overhead_fee`, `overhead_fee_discount_amount`, `etc_expenses_payment_type`

### 3. AGNT→MANAGE連携（物件データ・オーナーデータ作成）

- **実装箇所**: `repositories/backend/tech_after/app/models/contract.rb:67-121` - `Contract.sync_contracts_from_agnt`
- **処理内容**:
  1. `Agnt::Contract.settlement_federate_target`で決済済み契約を取得（今月決済済みで、まだMANAGEに連携されていない契約）
  2. 各契約について：
     - **Owner（オーナー）を作成または取得**: `Owner.find_or_initialize_by(customer_id: consul_customer.id)`
     - **OwnerArticle（物件データ）を作成または取得**: `OwnerArticle.search_or_new_by`
     - **Contract（契約データ）を作成または取得**: `search_contract_id`
     - **RentalManagementContract（賃貸管理契約）を作成または更新**: `TechConsulRentalManagementContract.search_id_and_update`
- **トリガー**: このメソッドがどこから呼び出されるかは未確認（バッチ処理やrakeタスクの可能性）
- **注意**: この処理は決済済み（`paid`ステータス）の契約に対して実行される

**契約書ファイルの有無について（確認済み）**:
- **結論**: 賃貸管理委託契約書がアップロードされていなくても、MANAGEに連携される
- **理由**: `Contract.sync_contracts_from_agnt`の処理では、契約書ファイルの有無をチェックしていない
- **処理の流れ**: AGNTの契約情報（`consul_contract`）から直接データを取得してMANAGEに連携するため、契約書ファイルがアップロードされていなくても連携される
- **注意点**: 契約書ファイルは後続の処理（ドキュメントインポート等）で使用される可能性があるが、MANAGE連携自体には必須ではない

**要確認**: 
1. `Contract.sync_contracts_from_agnt`がどこから呼び出されるか（バッチ処理、rakeタスク、手動実行等）
2. 実行タイミング（決済日の翌日17時？）
3. 根本さんが言っていた「MANAGE連携ボタン」がこの処理を手動実行するものか

### 4. 契約ステータス遷移

- **`applied`（申込受付）**: 初期状態
- **`loan_preparation`（ローン準備中）**: 契約報告（活動結果登録）で「契約」を登録すると自動的に更新される
- **`paid`（決済済み）**: 決済完了時にFLOW側から通知が来て自動的に更新される

---

## 決済完了処理のトリガー

### トリガー条件

`repositories/tools/flow_by_renosy/app/models/sale.rb:654-661` - `settlement_linkable?`メソッド

1. `customer_settlement_date`（買主決済日）が存在する
2. `Time.zone.today >= customer_settlement_date`（買主決済日が今日以降）
3. `article.settlement_operation.received`（入金済み）
4. `procurement.payoff_and_accounting_status.value >= payoff_paid`（精算・会計ステータスが精算済み以上）

### `customer_settlement_date`の保存場所

- `repositories/tools/flow_by_renosy/db/schema.rb:636` - `sales`テーブルの`customer_settlement_date`カラム（コメント: "買主決済日"）
- **SUPPLIERのarticleにある買主決済予定日との関係**: 未確認（`customer_settlement_date`がどこから設定されるか不明）

---

## 不明点（技術者確認が必要）

### 1. FLOW側のバッチ処理スケジュール

- **買主決済日の翌日17時にバッチが走る**との認識だが、実装箇所（whenever、cron等）が未確認
- バッチ処理の実装箇所（ジョブファイル）が不明

### 2. `customer_settlement_date`の設定元

- `customer_settlement_date`（買主決済日）がどこから設定されるか不明
- SUPPLIERのarticleにある買主決済予定日から設定されるか、または別の方法で設定されるか

### 3. MANAGE連携ボタンの詳細動作（要確認）

- **根本さんの認識**: AGNT上の契約書の右側にある確認ボタンを押すとMANAGE連携される
- **コード上の確認結果**:
  - AGNTの契約詳細ページには「MANAGE連携」という名前のボタンは存在しない
  - 契約書の確認ボタンは存在するが、`ContractFile#confirm`メソッドは`is_confirmed`フラグを更新するだけで、MANAGE連携の処理は含まれていない
- **MANAGE側の実装**: `Contract.sync_contracts_from_agnt`メソッドが存在し、決済済み契約から物件データ・オーナーデータを作成する処理が実装されている
  - `Agnt::Contract.settlement_federate_target`で決済済み契約を取得
  - `Owner`、`OwnerArticle`、`Contract`、`RentalManagementContract`を作成または更新
- **バッチ処理の有無**: `Contract.sync_contracts_from_agnt`の呼び出し元が未確認（バッチ処理やrakeタスクの可能性）

**バッチ処理がソースコードから確認できない理由**:
1. **システムのcron設定**: `/etc/cron.d/`など、アプリケーション外のシステム設定ファイルに直接設定されている可能性
2. **外部のジョブスケジューラー**: AWS Batch、Jenkins、GitHub Actions、CircleCIなどの外部システムで実行されている可能性
3. **別のリポジトリ**: インフラ管理用の別リポジトリ（Terraform、Ansible、Chef等）に設定がある可能性
4. **手動実行**: Railsコンソールやrakeタスクとして手動実行されている可能性
5. **whenever/cron設定ファイルの不在**: `config/schedule.rb`や`config/initializers/whenever.rb`がリポジトリに含まれていない、または別の場所にある可能性

- **要確認**: 
  1. `Contract.sync_contracts_from_agnt`がどこから呼び出されるか（バッチ処理、rakeタスク、手動実行等）
  2. 根本さんが言っていた「MANAGE連携ボタン」がこの処理を手動実行するものか
  3. 実行タイミング（決済日の翌日17時？）
  4. バッチ処理の設定場所（システムのcron設定、外部ジョブスケジューラー、別リポジトリ等）

---

## 参考資料

- [販売プロセス手順書](../3_executing/sales_process.md)
- [論点調査結果](../2_planning/investigation_results.md)
- [プロダクト要件定義書](../2_planning/product_requirements.md)
