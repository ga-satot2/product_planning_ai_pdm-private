# 契約書確認チェックボックス有効化条件

## 概要

AGNTの契約ページで契約書を手動アップロードした後、「確認」チェックボックスが有効にならない場合の原因と解決方法をまとめます。

---

## 確認チェックボックスが有効になる条件

### 実装箇所

- **ビュー**: `repositories/backend/verdandi/app/views/contracts/_contract_files.erb:55-71`
- **モデル**: `repositories/backend/verdandi/app/models/contract_file.rb:113-115` - `can_confirm?`メソッド

### 必須条件（すべて満たす必要がある）

1. **契約ステータスが`CONTRACTED_STATUS`に含まれている**
   - `loan_preparation`（ローン準備中）
   - `loan_judgment`（ローン審査中）
   - `payment_process`（決済手続き中）
   - `paid`（決済済み）
   - **含まれないステータス**: `applied`（申込受付）、`contract_preparation`（契約準備中）

2. **ユーザーが`loan_staff`権限を持っている**
   - `current_user.loan_staff`が`true`である必要がある
   - `tech_consul_user_loan_staff`が`true`、または`tech_consul_user_sales_type`が`appointer`、`closer`、`supporter`のいずれか

3. **ファイルがまだ確認されていない**
   - `is_confirmed`が`false`である必要がある

4. **ファイルが電子契約で使用予定のファイルではない**
   - `is_digital_contract_expectation_file`が`false`である必要がある
   - 手動アップロードしたファイルは通常`false`なので、この条件は問題ないことが多い

---

## 確認チェックボックスが有効にならない原因

### 1. 契約ステータスが`CONTRACTED_STATUS`に含まれていない

**症状**: 「確認」列が表示されない、またはチェックボックスが無効化されている

**原因**: 契約ステータスが`applied`（申込受付）や`contract_preparation`（契約準備中）のまま

**解決方法**:
- 案件ページで申込（社内手続）の結果登録をすることで、契約報告を流してもらう
- 活動結果として「契約」を登録すると、ステータスが`loan_preparation`（ローン準備中）に更新される

### 2. ユーザーが`loan_staff`権限を持っていない

**症状**: 「確認」列は表示されるが、チェックボックスが無効化されている（グレーアウト）

**原因**: ログインしているユーザーが`loan_staff`権限を持っていない

**解決方法**:
- `loan_staff`権限を持つユーザーに切り替える
- または、ユーザーの権限設定を確認する

### 3. ファイルが既に確認済み

**症状**: チェックボックスがチェック済みで、変更できない

**原因**: `is_confirmed`が`true`になっている

**解決方法**:
- 既に確認済みのため、追加の操作は不要

### 4. ファイルが電子契約で使用予定のファイル

**症状**: チェックボックスが無効化されている

**原因**: `is_digital_contract_expectation_file`が`true`になっている

**解決方法**:
- 手動アップロードしたファイルは通常`false`なので、この原因は稀
- 電子契約で使用予定のファイルは確認できない仕様

---

## コード実装詳細

### ビューの実装

```erb
<% if Contract::CONTRACTED_STATUS.include?(@contract.status.value) %>
  <th>確認</th>
<% end %>

<% if Contract::CONTRACTED_STATUS.include?(@contract.status.value) %>
  <td class="text-center">
    <% if current_user.loan_staff %>
      <%= button_to file.present? ? file.confirm_text : '確認',
                    file.present? ? contract_file_path(file) : '#',
                    method: :patch,
                    class: "btn btn-success",
                    form: { data: { turbo: true } },
                    disabled: file.present? ? !file.can_confirm? : true %>
    <% else %>
      <%= check_box_tag(:is_confirmed,
                        false,
                        file.present? ? file.is_confirmed : false,
                        disabled: true) %>
    <% end %>
  </td>
<% end %>
```

### モデルの実装

```ruby
def can_confirm?
  !is_confirmed && !is_digital_contract_expectation_file
end
```

### 契約ステータスの定義

```ruby
CONTRACTED_STATUS = [
  Contract.status.loan_preparation.value,    # ローン準備中
  Contract.status.loan_judgment.value,       # ローン審査中
  Contract.status.payment_process.value,    # 決済手続き中
  Contract.status.paid.value                # 決済済み
].freeze
```

---

## 確認手順

1. **契約ステータスを確認**
   - 契約詳細ページで現在のステータスを確認
   - `applied`や`contract_preparation`の場合は、契約報告を実行する

2. **ユーザー権限を確認**
   - ログインしているユーザーが`loan_staff`権限を持っているか確認
   - 権限がない場合は、権限を持つユーザーに切り替える

3. **ファイルの状態を確認**
   - ファイルが既に確認済みでないか確認
   - `is_digital_contract_expectation_file`が`true`でないか確認（通常は`false`）

---

## 参考資料

- [決済後連携確認ポイント](./決済後連携確認ポイント.md)
