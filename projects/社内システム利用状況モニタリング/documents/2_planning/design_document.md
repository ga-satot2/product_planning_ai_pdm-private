# 社内システム利用状況モニタリング Chrome拡張機能 設計書

**プロジェクト**: 社内システム利用状況モニタリング  
**作成日**: 2026-01-13  
**バージョン**: v1.0

---

## 1. システム概要

### 1.1 目的
社内向けシステムの利用状況をモニタリングするため、Chrome拡張機能を使用してアクティブなタブの滞在時間を計測し、利用データを収集・分析できるシステムを構築する。

### 1.2 背景・課題
- 社内システムの利用状況が可視化されていない
- どのシステムがどの程度使われているか把握できない
- システム改善のためのデータが不足している
- ユーザーの作業効率を定量的に評価できない

### 1.3 主要機能
1. **タブ滞在時間計測**: アクティブなタブの滞在時間を自動計測
2. **URLフィルタリング**: 社内システムのURLのみを対象に計測
3. **データ収集・保存**: 計測データをローカルストレージに保存
4. **利用状況可視化**: ポップアップUIで利用状況を表示
5. **データエクスポート**: CSV/JSON形式でデータをエクスポート
6. **設定管理**: 監視対象URLの設定、計測開始/停止の制御

### 1.4 対象ユーザー
- 社内システム管理者
- プロダクトマネージャー
- データ分析担当者

---

## 2. システム構成

### 2.1 主要コンポーネント

#### 2.1.1 バックグラウンドスクリプト (Background Script)
- **役割**: タブの状態監視、滞在時間計測、データ管理
- **技術**: Service Worker (Manifest V3)
- **主要機能**:
  - タブのアクティブ状態の監視
  - 滞在時間の計測と記録
  - データの永続化（chrome.storage API）
  - 設定の管理

#### 2.1.2 ポップアップUI (Popup)
- **役割**: 利用状況の表示、設定変更、データエクスポート
- **技術**: HTML + CSS + JavaScript (Vanilla JS)
- **主要機能**:
  - 本日の利用時間表示
  - システム別利用時間ランキング
  - 設定画面への遷移
  - データエクスポート機能

#### 2.1.3 オプションページ (Options Page)
- **役割**: 拡張機能の詳細設定
- **技術**: HTML + CSS + JavaScript
- **主要機能**:
  - 監視対象URLの設定（正規表現対応）
  - 計測開始/停止の制御
  - データリセット機能
  - プライバシー設定

#### 2.1.4 コンテンツスクリプト (Content Script)
- **役割**: ページ内での追加機能（将来的な拡張用）
- **技術**: JavaScript
- **主要機能**:
  - ページタイトルの取得
  - ページ遷移の検知（SPA対応）

### 2.2 技術スタック

| カテゴリ | 技術 | バージョン |
|---------|------|-----------|
| **拡張機能API** | Chrome Extensions API (Manifest V3) | Latest |
| **ストレージ** | chrome.storage.local | - |
| **フロントエンド** | HTML5, CSS3, Vanilla JavaScript (ES6+) | - |
| **ビルドツール** | なし（必要に応じてwebpack等） | - |
| **データ形式** | JSON, CSV | - |

### 2.3 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────┐
│                    Chrome Browser                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────────┐      ┌──────────────────┐        │
│  │  Popup UI        │      │  Options Page    │        │
│  │  (表示・操作)     │      │  (設定管理)       │        │
│  └────────┬─────────┘      └────────┬─────────┘        │
│           │                          │                   │
│           └──────────┬───────────────┘                   │
│                      │                                    │
│           ┌──────────▼──────────┐                        │
│           │  Background Script  │                        │
│           │  (Service Worker)   │                        │
│           │  - タブ監視         │                        │
│           │  - 時間計測         │                        │
│           │  - データ管理       │                        │
│           └──────────┬──────────┘                        │
│                      │                                    │
│           ┌──────────▼──────────┐                        │
│           │  chrome.storage    │                        │
│           │  (ローカル保存)     │                        │
│           └────────────────────┘                        │
│                                                          │
│  ┌──────────────────────────────────────────────┐      │
│  │  Content Script (将来の拡張用)                │      │
│  └──────────────────────────────────────────────┘      │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 3. データモデル

### 3.1 データ構造

#### 3.1.1 セッション記録 (Session Record)
```typescript
interface SessionRecord {
  id: string;                    // セッションID (UUID)
  url: string;                   // ページURL
  domain: string;                 // ドメイン名
  title: string;                 // ページタイトル
  startTime: number;              // 開始時刻 (Unix timestamp)
  endTime: number | null;         // 終了時刻 (null = アクティブ中)
  duration: number;               // 滞在時間 (秒)
  date: string;                   // 日付 (YYYY-MM-DD)
  timestamp: number;              // 記録時刻 (Unix timestamp)
}
```

#### 3.1.2 日次集計データ (Daily Summary)
```typescript
interface DailySummary {
  date: string;                   // 日付 (YYYY-MM-DD)
  totalTime: number;              // 合計利用時間 (秒)
  sessionCount: number;           // セッション数
  domains: {                      // ドメイン別集計
    [domain: string]: {
      totalTime: number;          // 合計時間
      sessionCount: number;       // セッション数
      urls: {                     // URL別集計
        [url: string]: {
          totalTime: number;
          sessionCount: number;
        }
      }
    }
  }
}
```

#### 3.1.3 設定データ (Settings)
```typescript
interface Settings {
  enabled: boolean;               // 計測有効/無効
  targetUrls: string[];          // 監視対象URLパターン (正規表現)
  excludedUrls: string[];        // 除外URLパターン (正規表現)
  minDuration: number;           // 最小記録時間 (秒、これ以下は記録しない)
  autoExport: boolean;            // 自動エクスポート有効/無効
  exportInterval: number;        // エクスポート間隔 (日)
  privacyMode: boolean;          // プライバシーモード (詳細URLを記録しない)
}
```

### 3.2 ストレージ構造

#### chrome.storage.local のデータ構造
```json
{
  "sessions": {
    "2026-01-13": [
      {
        "id": "uuid-1",
        "url": "https://example.com/page1",
        "domain": "example.com",
        "title": "Page Title",
        "startTime": 1705123456789,
        "endTime": 1705123500000,
        "duration": 43211,
        "date": "2026-01-13",
        "timestamp": 1705123500000
      }
    ]
  },
  "settings": {
    "enabled": true,
    "targetUrls": [
      "^https://.*\\.example\\.com",
      "^https://.*\\.internal\\.company\\.com"
    ],
    "excludedUrls": [
      "^https://.*\\.example\\.com/login"
    ],
    "minDuration": 5,
    "autoExport": false,
    "exportInterval": 7,
    "privacyMode": false
  },
  "lastExportDate": "2026-01-06",
  "version": "1.0.0"
}
```

---

## 4. 主要機能仕様

### 4.1 タブ滞在時間計測

#### 4.1.1 計測ロジック
1. **タブアクティブ検知**
   - `chrome.tabs.onActivated` イベントでタブ切り替えを検知
   - アクティブになったタブのURLを取得

2. **URLフィルタリング**
   - 設定された `targetUrls` パターンと照合
   - 一致する場合のみ計測対象とする
   - `excludedUrls` に一致する場合は除外

3. **時間計測**
   - タブがアクティブになった時刻を記録（`startTime`）
   - タブが非アクティブになった時刻を記録（`endTime`）
   - `duration = endTime - startTime` を計算

4. **最小時間フィルタ**
   - `minDuration` 未満のセッションは記録しない（誤操作や誤タブ切り替えを除外）

#### 4.1.2 エッジケース対応
- **ブラウザ終了**: `chrome.runtime.onSuspend` で最後のセッションを保存
- **タブ閉鎖**: `chrome.tabs.onRemoved` でセッションを終了
- **URL変更**: `chrome.tabs.onUpdated` でURL変更を検知し、新しいセッションを開始
- **SPA遷移**: Content Scriptで `pushState` / `replaceState` を監視（将来実装）

### 4.2 データ収集・保存

#### 4.2.1 保存タイミング
- セッション終了時に即座に保存
- 日次集計データは日付変更時に生成
- ストレージ容量を考慮し、古いデータは自動アーカイブ

#### 4.2.2 データ保存場所の検討事項 ⚠️ 要議論

データ保存場所は設計上の重要な判断ポイントです。以下に選択肢とそれぞれの特徴を整理します。

##### 選択肢1: chrome.storage.local（現在の設計）

**特徴**:
- ローカルストレージに保存（ユーザーのPC内のみ）
- 容量制限: 約10MB（警告なし）、最大推奨5MB
- データはブラウザ再インストール時に削除される可能性あり
- 外部送信なし（プライバシー保護）

**メリット**:
- ✅ 実装が簡単
- ✅ プライバシー保護（ローカルのみ）
- ✅ 外部サーバー不要
- ✅ オフライン動作

**デメリット**:
- ❌ 容量制限（長期利用時に不足の可能性）
- ❌ データ消失リスク（ブラウザ再インストール等）
- ❌ 複数デバイス間で同期不可
- ❌ 集約・分析が困難（各ユーザーから手動エクスポートが必要）

**適用ケース**:
- 個人利用のみ
- プライバシーを最優先
- 短期間の利用（数ヶ月程度）

---

##### 選択肢2: chrome.storage.sync

**特徴**:
- Googleアカウント経由で複数デバイス間で同期
- 容量制限: 約100KB（警告なし）、最大推奨8KB/アイテム
- データはGoogleアカウントに紐づく

**メリット**:
- ✅ 複数デバイス間で同期可能
- ✅ データ消失リスクが低い
- ✅ 実装が比較的簡単

**デメリット**:
- ❌ 容量制限が厳しい（100KBは短期間で不足）
- ❌ Googleアカウント必須
- ❌ 集約・分析が困難

**適用ケース**:
- 複数デバイスで利用する個人ユーザー
- 小容量データのみ

---

##### 選択肢3: IndexedDB

**特徴**:
- ブラウザ内の大容量データベース
- 容量制限: ブラウザ・ディスク容量による（通常数GB可能）
- 構造化データの保存に適している

**メリット**:
- ✅ 大容量データに対応
- ✅ 高速なクエリ処理
- ✅ ローカル保存（プライバシー保護）

**デメリット**:
- ❌ 実装が複雑
- ❌ データ消失リスク（ブラウザ再インストール等）
- ❌ 複数デバイス間で同期不可
- ❌ 集約・分析が困難

**適用ケース**:
- 長期利用（1年以上）
- 大量データの保存が必要
- ローカルでの分析機能が必要

---

##### 選択肢4: 外部サーバー（社内API）

**特徴**:
- 社内サーバーまたはクラウドサービスにデータを送信
- 全ユーザーのデータを集約可能
- リアルタイム分析・レポート生成が可能

**メリット**:
- ✅ データ集約・分析が容易
- ✅ データ消失リスクが低い
- ✅ リアルタイムレポート生成
- ✅ バックアップ・復旧が容易

**デメリット**:
- ❌ プライバシー懸念（ユーザーの同意が必要）
- ❌ サーバー構築・運用コスト
- ❌ ネットワーク接続必須
- ❌ セキュリティ対策が必要

**適用ケース**:
- 組織全体での利用状況分析が必要
- リアルタイムモニタリングが必要
- データ分析・レポート機能が重要

**技術的実装**:
- REST API エンドポイント
- 認証（OAuth 2.0 / API Key）
- データ暗号化（HTTPS必須）

---

##### 選択肢5: Google Drive / Google Sheets（ハイブリッド）

**特徴**:
- ローカルで計測、定期的にGoogle Drive/Sheetsにエクスポート
- Google Apps Scriptで自動集計・分析
- 既存のGoogleワークスペース環境を活用

**メリット**:
- ✅ 既存インフラ活用（コスト削減）
- ✅ データ集約が比較的容易
- ✅ ユーザーが自分のデータを管理可能
- ✅ 手動エクスポートの自動化

**デメリット**:
- ❌ Googleアカウント必須
- ❌ リアルタイム性は低い（定期エクスポート）
- ❌ プライバシー設定の管理が必要

**適用ケース**:
- 既にGoogleワークスペースを利用している組織
- コストを抑えたい
- リアルタイム性は不要

**技術的実装**:
- Google Drive API / Google Sheets API
- Google Apps Script（自動集計）
- 定期エクスポート機能（日次/週次）

---

##### 選択肢6: ハイブリッド（ローカル + オプション送信）

**特徴**:
- 基本はローカル保存（chrome.storage.local または IndexedDB）
- ユーザーが選択的に外部サーバーに送信可能
- 送信データの範囲をユーザーが制御

**メリット**:
- ✅ プライバシーと利便性のバランス
- ✅ ユーザーが選択可能
- ✅ 段階的な導入が可能

**デメリット**:
- ❌ 実装が複雑
- ❌ ユーザー設定の管理が必要

**適用ケース**:
- プライバシーとデータ分析の両立が必要
- 段階的な導入を検討

---

#### 4.2.3 推奨アプローチ（検討案）

**Phase 1（MVP）**: chrome.storage.local
- 実装が簡単で迅速に開発可能
- プライバシー保護を最優先
- ユーザーテストで要件を確認

**Phase 2（拡張）**: 要件に応じて選択
- **データ集約が必要** → 外部サーバー または Google Sheets連携
- **大容量データ** → IndexedDB
- **複数デバイス同期** → chrome.storage.sync（小容量データのみ）

**検討すべき質問**:
1. データを集約して分析する必要があるか？
2. リアルタイムで利用状況を把握する必要があるか？
3. プライバシーと利便性のどちらを優先するか？
4. 既存のインフラ（Googleワークスペース等）を活用できるか？
5. サーバー構築・運用の予算・リソースはあるか？

#### 4.2.4 データ管理（chrome.storage.localの場合）

- **保持期間**: デフォルト90日（設定可能）
- **自動クリーンアップ**: 90日を超えたデータは自動削除
- **バックアップ**: エクスポート機能で手動バックアップ可能
- **容量管理**: 5MBを超える場合は古いデータから自動削除

### 4.3 利用状況可視化

#### 4.3.1 ポップアップUI表示内容
- **本日の合計利用時間**: 今日の全システム合計時間
- **システム別利用時間**: ドメイン別の利用時間ランキング
- **アクティブセッション**: 現在アクティブなタブの情報
- **クイックアクション**: 設定、エクスポートへのリンク

#### 4.3.2 グラフ表示（将来実装）
- 時間帯別利用状況
- 週次/月次トレンド
- システム別利用割合（円グラフ）

### 4.4 データエクスポート

#### 4.4.1 エクスポート形式
- **CSV形式**: Excel等で開ける形式
  - 列: 日付, URL, ドメイン, タイトル, 開始時刻, 終了時刻, 滞在時間(秒), 滞在時間(分)
- **JSON形式**: プログラム処理用
  - 完全なセッションデータを含む

#### 4.4.2 エクスポート範囲
- 全期間
- 指定期間（開始日〜終了日）
- 本日のみ
- 先週
- 先月

### 4.5 設定管理

#### 4.5.1 監視対象URL設定
- 正規表現パターンでURLを指定
- 複数パターンの追加・削除
- パターンのテスト機能（URL入力でマッチ確認）

#### 4.5.2 プライバシー設定
- **プライバシーモード**: 詳細URLを記録せず、ドメインのみ記録
- **データリセット**: 全データの削除
- **計測停止**: 一時的に計測を停止

---

## 5. UI/UX設計

### 5.1 ポップアップUI

#### 5.1.1 レイアウト
```
┌─────────────────────────────┐
│  📊 利用状況モニター         │
├─────────────────────────────┤
│                              │
│  本日の合計利用時間           │
│  ⏱️  3時間 45分              │
│                              │
│  ────────────────────────    │
│                              │
│  システム別利用時間          │
│  1. example.com     2h 30m   │
│  2. internal.com    1h 15m   │
│                              │
│  ────────────────────────    │
│                              │
│  現在アクティブ:              │
│  example.com/page1           │
│  ⏱️  5分 23秒                │
│                              │
│  ────────────────────────    │
│                              │
│  [設定] [エクスポート]        │
│                              │
└─────────────────────────────┘
```

#### 5.1.2 デザイン方針
- **シンプルで見やすい**: 重要な情報を一目で把握
- **色使い**: 時間は緑、警告はオレンジ、エラーは赤
- **レスポンシブ**: ポップアップサイズに最適化（400x600px推奨）

### 5.2 オプションページ

#### 5.2.1 レイアウト
- **タブ形式**: 「基本設定」「URL設定」「データ管理」「プライバシー」
- **設定項目**: 各項目に説明文を表示
- **プレビュー**: URLパターンのテスト機能

---

## 6. セキュリティ・プライバシー考慮事項

### 6.1 データプライバシー
- **ローカル保存のみ**: データはユーザーのローカルストレージにのみ保存
- **外部送信なし**: データを外部サーバーに送信しない
- **暗号化**: 機密情報が含まれる場合は暗号化を検討（将来実装）

### 6.2 権限管理
- **最小権限の原則**: 必要最小限のChrome API権限のみ要求
  - `tabs`: タブ情報の取得
  - `storage`: データの保存
  - `activeTab`: アクティブタブの情報取得

### 6.3 ユーザー制御
- **オプトアウト**: いつでも計測を停止可能
- **データ削除**: ユーザーが任意のタイミングでデータを削除可能
- **透明性**: 何を記録しているか明確に表示

### 6.4 コンプライアンス
- **個人情報保護**: 個人を特定できる情報は記録しない
- **社内ポリシー準拠**: 社内のプライバシーポリシーに準拠

---

## 7. 実装計画

### 7.1 開発フェーズ

#### Phase 1: 基本機能実装（MVP）
- [ ] Manifest V3の基本構造作成
- [ ] バックグラウンドスクリプトでタブ監視
- [ ] 基本的な時間計測機能
- [ ] ローカルストレージへの保存
- [ ] シンプルなポップアップUI

**期間**: 1-2週間

#### Phase 2: 設定・フィルタリング機能
- [ ] オプションページの実装
- [ ] URLパターン設定機能
- [ ] フィルタリングロジック
- [ ] 設定の永続化

**期間**: 1週間

#### Phase 3: データ可視化・エクスポート
- [ ] ポップアップUIの拡張
- [ ] 日次集計機能
- [ ] CSV/JSONエクスポート機能
- [ ] データ管理機能（削除、リセット）

**期間**: 1-2週間

#### Phase 4: 高度な機能（将来実装）
- [ ] グラフ表示機能
- [ ] SPA対応（Content Script）
- [ ] 自動エクスポート機能
- [ ] データ分析機能

**期間**: 2-3週間

### 7.2 ファイル構成

```
chrome-extension/
├── manifest.json              # 拡張機能マニフェスト
├── icons/                     # アイコンファイル
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
├── background/
│   └── service-worker.js      # バックグラウンドスクリプト
├── popup/
│   ├── popup.html
│   ├── popup.css
│   └── popup.js
├── options/
│   ├── options.html
│   ├── options.css
│   └── options.js
├── content/
│   └── content-script.js      # コンテンツスクリプト（将来用）
├── lib/
│   ├── storage.js             # ストレージ管理ユーティリティ
│   ├── time-calculator.js     # 時間計算ユーティリティ
│   └── url-matcher.js         # URLマッチングユーティリティ
└── README.md
```

### 7.3 技術的考慮事項

#### 7.3.1 Manifest V3対応
- Service Workerを使用（Background Pageの代わり）
- イベントリスナーの適切な管理
- メッセージパッシングの実装

#### 7.3.2 パフォーマンス
- ストレージへの書き込み頻度を最適化
- 大量データの処理時のメモリ使用量に注意
- バックグラウンドスクリプトの効率的な実装

#### 7.3.3 ブラウザ互換性
- Chrome専用（Manifest V3はChromeのみ対応）
- 将来的にEdge対応を検討

---

## 8. テスト計画

### 8.1 単体テスト
- URLマッチングロジック
- 時間計算ロジック
- データ保存・読み込み機能

### 8.2 統合テスト
- タブ切り替え時の計測精度
- 複数タブでの動作確認
- ブラウザ再起動時のデータ保持

### 8.3 ユーザーテスト
- 実際の社内システムでの動作確認
- パフォーマンステスト
- プライバシー懸念の確認

---

## 9. 運用・保守

### 9.1 ログ・モニタリング
- エラーログの記録
- パフォーマンスメトリクスの収集

### 9.2 アップデート計画
- バージョン管理
- 自動アップデート機能
- データ移行（バージョンアップ時）

### 9.3 サポート
- ユーザーマニュアルの作成
- FAQの整備
- フィードバック収集機能

---

## 10. リスク・課題

### 10.1 技術的リスク
- **Manifest V3の制約**: Service Workerのライフサイクル管理が複雑
- **ストレージ容量**: 大量データの保存時の容量制限（chrome.storage.localは約5-10MB）
- **パフォーマンス**: 長時間使用時のメモリ使用量
- **データ消失リスク**: ブラウザ再インストール、拡張機能のアンインストール時にデータが失われる可能性

### 10.2 プライバシーリスク
- **ユーザーの懸念**: 監視されることへの抵抗感
- **データ漏洩**: ローカルデータのセキュリティ
- **外部送信時のリスク**: サーバー送信を選択した場合のデータ保護

### 10.3 データ保存に関する課題 ⚠️ 要議論

#### 10.3.1 データ集約の必要性
- **課題**: ローカル保存のみでは、組織全体の利用状況を把握できない
- **影響**: システム改善の意思決定に必要なデータが不足
- **検討事項**: 
  - データ集約が必要か？
  - どの程度の粒度で集約するか？（個人レベル？部署レベル？）
  - 集約データの用途は？

#### 10.3.2 データ保持期間
- **課題**: ローカル保存の場合、容量制限により長期データの保持が困難
- **影響**: 長期トレンド分析ができない
- **検討事項**:
  - どの程度の期間のデータが必要か？
  - アーカイブ機能は必要か？

#### 10.3.3 バックアップ・復旧
- **課題**: ローカル保存の場合、データ消失時の復旧が困難
- **影響**: 重要なデータが失われる可能性
- **検討事項**:
  - 自動バックアップ機能は必要か？
  - バックアップ先はどこか？（Google Drive、外部サーバー等）

### 10.4 対策
- 透明性の確保（何を記録しているか明確に）
- オプトアウト機能の充実
- セキュリティベストプラクティスの遵守
- **データ保存方針の明確化**: ユーザーに保存場所と用途を明示
- **段階的導入**: MVPでローカル保存から開始し、要件に応じて拡張

---

## 11. 議論・決定が必要な事項

### 11.1 データ保存場所 ⚠️ 優先度高

**現状**: chrome.storage.local を想定（MVP）

**検討事項**:
1. データ集約・分析の必要性
   - 組織全体の利用状況を把握する必要があるか？
   - リアルタイムで利用状況を把握する必要があるか？

2. プライバシーと利便性のバランス
   - プライバシーを最優先するか？
   - データ分析の利便性を優先するか？

3. インフラ・コスト
   - サーバー構築・運用の予算・リソースはあるか？
   - 既存のインフラ（Googleワークスペース等）を活用できるか？

4. データ保持期間・容量
   - どの程度の期間のデータが必要か？
   - どの程度のデータ量が想定されるか？

**選択肢の比較**: セクション4.2.2を参照

**推奨**: Phase 1（MVP）は chrome.storage.local で開始し、要件を確認してから Phase 2 で拡張

---

### 11.2 その他の議論事項

- **ユーザー同意**: データ収集に対する明示的な同意は必要か？
- **データ匿名化**: 個人を特定できない形でのデータ集約は可能か？
- **利用目的の明確化**: データをどのような目的で使用するか？

---

## 12. 参考資料

### 12.1 Chrome拡張機能ドキュメント
- [Chrome Extensions API](https://developer.chrome.com/docs/extensions/reference/)
- [Manifest V3 Migration Guide](https://developer.chrome.com/docs/extensions/mv3/intro/)
- [Service Workers in Extensions](https://developer.chrome.com/docs/extensions/mv3/service_workers/)
- [chrome.storage API](https://developer.chrome.com/docs/extensions/reference/storage/)
- [IndexedDB API](https://developer.mozilla.org/ja/docs/Web/API/IndexedDB_API)

### 12.2 データ保存に関する参考資料
- [Chrome Storage API 容量制限](https://developer.chrome.com/docs/extensions/reference/storage/#property-local)
- [IndexedDB ベストプラクティス](https://developer.mozilla.org/ja/docs/Web/API/IndexedDB_API/Basic_Concepts_Behind_IndexedDB)

### 12.3 関連プロジェクト
- 社内システム一覧
- 既存のモニタリングツール

---

**文書バージョン**: v1.1  
**最終更新**: 2026-01-13  
**次回レビュー予定**: データ保存場所の決定後
