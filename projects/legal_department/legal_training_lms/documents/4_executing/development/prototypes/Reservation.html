<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äºˆç´„ç”³ã—è¾¼ã¿ - æ³•å‹™ç ”ä¿®LMS</title>
  <?!= include('Stylesheet'); ?>
</head>
<body>
  <?!= include('Header'); ?>
  
  <div class="container">
    <div class="page-header">
      <h1>ç ”ä¿®äºˆç´„</h1>
      <p>å‚åŠ å¸Œæœ›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    </div>
    
    <? if (course) { ?>
      <div class="course-summary">
        <h2><?= course.name ?></h2>
        <p><?= course.description || 'ç ”ä¿®ã®èª¬æ˜' ?></p>
        <div class="course-meta">
          <span class="badge"><?= course.groupId ?></span>
        </div>
      </div>
      
      <? if (sessions && sessions.length > 0) { ?>
        <div class="sessions-list">
          <h3>ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§</h3>
          <form id="reservationForm" onsubmit="handleReservation(event)">
            <? for (var i = 0; i < sessions.length; i++) { ?>
              <? var session = sessions[i]; ?>
              <? var isFull = (session.currentParticipants || 0) >= 50; ?>
              
              <div class="session-card <?= isFull ? 'session-full' : '' ?>" data-event-id="<?= session.eventId || '' ?>">
                <div class="session-radio">
                  <input 
                    type="radio" 
                    name="sessionId" 
                    value="<?= session.id ?>" 
                    data-event-id="<?= session.eventId || '' ?>"
                    id="session-<?= i ?>"
                    <?= isFull ? 'disabled' : '' ?>
                    required
                  >
                </div>
                <label for="session-<?= i ?>" class="session-label">
                  <div class="session-info">
                    <div class="session-name"><?= session.sessionName ?></div>
                    <div class="session-datetime">
                      ğŸ“… <?= formatDate(session.scheduledDate) ?>
                      ğŸ•’ <?= session.startTime ?> ã€œ <?= session.endTime ?>
                    </div>
                    <div class="session-location">
                      ğŸ“ <?= session.meetingRoomId || 'ä¼šè­°å®¤æœªå®š' ?>
                    </div>
                  </div>
                  <div class="session-capacity">
                    <span class="capacity-text">
                      <?= session.currentParticipants || 0 ?> / 50 å
                    </span>
                    <? if (isFull) { ?>
                      <span class="badge badge-danger">æº€å¸­</span>
                    <? } else { ?>
                      <span class="badge badge-success">ç©ºãã‚ã‚Š</span>
                    <? } ?>
                  </div>
                </label>
              </div>
            <? } ?>
            
            <div class="form-actions">
              <button type="submit" class="btn btn-primary btn-large">äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</button>
              <a href="<?= baseUrl ? baseUrl + '?page=courses' : '?page=courses' ?>" class="btn btn-secondary">ã‚³ãƒ¼ã‚¹ä¸€è¦§ã«æˆ»ã‚‹</a>
            </div>
          </form>
        </div>
      <? } else { ?>
        <div class="alert alert-warning">
          <strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</strong>
          <p>ã“ã®ã‚³ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å¾Œã»ã©å†åº¦ç¢ºèªã™ã‚‹ã‹ã€ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã‚·ãƒ¼ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ URLã‹ã‚‰äºˆç´„ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
      <? } ?>
    <? } else { ?>
      <div class="alert alert-danger">
        <strong>ã‚³ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</strong>
        <p><a href="<?= baseUrl ? baseUrl + '?page=courses' : '?page=courses' ?>">ã‚³ãƒ¼ã‚¹ä¸€è¦§</a>ã‹ã‚‰é¸æŠã—ç›´ã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    <? } ?>
  </div>
  
  <?!= include('Footer'); ?>
  
  <script>
    function formatDate(date) {
      if (!date) return '-';
      var d = new Date(date);
      return d.toLocaleDateString('ja-JP', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        weekday: 'short' 
      });
    }
    
    function handleReservation(event) {
      event.preventDefault();
      var formData = new FormData(event.target);
      var sessionId = formData.get('sessionId');
      if (!sessionId) {
        alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      var checked = event.target.querySelector('input[name="sessionId"]:checked');
      var eventId = checked && checked.getAttribute('data-event-id') ? checked.getAttribute('data-event-id') : '';
      if (!confirm('ã“ã®äºˆç´„ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      var submitBtn = event.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'é€ä¿¡ä¸­...';
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            alert('äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ');
            window.location.href = '?page=mypage';
          } else {
            alert(response.message || 'äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ');
            submitBtn.disabled = false;
            submitBtn.textContent = 'äºˆç´„ã‚’ç¢ºå®šã™ã‚‹';
          }
        })
        .withFailureHandler(function(error) {
          alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
          submitBtn.disabled = false;
          submitBtn.textContent = 'äºˆç´„ã‚’ç¢ºå®šã™ã‚‹';
        })
        .handleCreateReservation({ action: 'create_reservation', sessionId: sessionId, eventId: eventId });
    }
  </script>
</body>
</html>
