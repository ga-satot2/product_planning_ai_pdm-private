# エラートラブルシューティングガイド

**プロジェクト**: 法務研修LMSシステム  
**作成日**: 2025-11-19  
**目的**: `refreshAttendeeStatus`と`editHandler`関数のエラー原因を特定・解決する

---

## 📋 エラー状況

### 発生しているエラー

- **関数名**: `refreshAttendeeStatus`, `editHandler`
- **エラー状態**: 過去7日間で10回実行、すべて失敗
- **スクリプトID**: `1DiZUSkJU_Z4Yc0bBcNgOUH3iqHux8xnSS7qILL5YZMfKgw86QeMvx0S-`
- **実行履歴**: https://script.google.com/home/projects/1DiZUSkJU_Z4Yc0bBcNgOUH3iqHux8xnSS7qILL5YZMfKgw86QeMvx0S-/executions

---

## 🔍 エラー原因の特定方法

### Step 1: 実行ログを確認

1. **Google Apps Scriptエディタを開く**
   - https://script.google.com/d/1DiZUSkJU_Z4Yc0bBcNgOUH3iqHux8xnSS7qILL5YZMfKgw86QeMvx0S-/edit

2. **実行履歴を確認**
   - 左メニュー「実行数」（時計アイコン）をクリック
   - 失敗した実行をクリックして詳細を確認

3. **ログを確認**
   - 左メニュー「ログ」（リストアイコン）をクリック
   - エラーメッセージを確認

### Step 2: よくあるエラー原因

#### 1. Utils関数が定義されていない（ReferenceError: Utils is not defined）

**エラーメッセージ例**:
- `ReferenceError: Utils is not defined`
- `Utils 関数が定義されていません。LMSUtils.gs が読み込まれているか確認してください。`

**原因**:
- Google Apps Scriptでは、ファイルの読み込み順序が重要です
- `sheet.gs`が`LMSUtils.gs`より先に読み込まれると、`Utils()`関数がまだ定義されていないためエラーが発生します

**解決方法**:
- ✅ **修正済み**: `sheet.gs`を遅延初期化方式に変更しました（2025-11-19）
- `Utils()`関数の呼び出しを`getUtils()`関数経由に変更し、実行時に初期化されるようにしました
- これにより、ファイルの読み込み順序に関係なく動作するようになりました

**確認方法**:
1. Google Apps Scriptエディタで`sheet.gs`を開く
2. 15行目付近で`getUtils()`関数が定義されているか確認
3. `const utils = Utils();`の直接呼び出しが残っていないか確認

#### 2. カレンダーIDが設定されていない、または無効

**エラーメッセージ例**:
- `Calendar IDが設定されていません。`
- `カレンダーが見つかりません。カレンダーIDを確認してください: ...`

**確認方法**:
1. Google Apps Scriptエディタで「プロジェクトの設定」（⚙️）をクリック
2. 「スクリプトプロパティ」セクションを確認
3. `CALENDAR_ID`が設定されているか確認

**解決方法**:
1. Google Calendarでカレンダーを開く
2. カレンダー設定 → 「カレンダーの統合」→ 「カレンダーID」をコピー
3. スクリプトプロパティに`CALENDAR_ID`として設定

#### 3. シート名が存在しない

**エラーメッセージ例**:
- `Sheet not found: 予約一覧`
- `Sheet not found: 参加情報`
- `必要なシートが見つかりません: ...`

**確認方法**:
1. スプレッドシートを開く
2. 以下のシートが存在するか確認:
   - `予約一覧`（`sheets.events.name`）
   - `参加情報`（`sheets.attendees.name`）
   - `ダッシュボード`（`sheets.dashboard.name`）

**解決方法**:
- シート名が異なる場合は、`LMSUtils.gs`の`getConfig()`内の`sheets`設定を確認・修正
- または、スプレッドシートのシート名を設定に合わせる

#### 4. カレンダーへのアクセス権限がない

**エラーメッセージ例**:
- `カレンダーの取得に失敗しました: ...`
- `カレンダーが見つかりません。カレンダーIDを確認してください: ...`

**確認方法**:
1. Google Calendarでカレンダーを開く
2. カレンダー設定 → 「共有設定」を確認
3. スクリプトを実行するユーザーにアクセス権限があるか確認

**解決方法**:
- カレンダーの共有設定で、スクリプトを実行するユーザーに「変更」または「閲覧」権限を付与

#### 5. スプレッドシートへのアクセス権限がない

**エラーメッセージ例**:
- `シートの取得に失敗しました: ...`
- `必要なシートが見つかりません: ...`

**確認方法**:
1. スプレッドシートを開く
2. 「共有」ボタンをクリック
3. スクリプトを実行するユーザーにアクセス権限があるか確認

**解決方法**:
- スプレッドシートの共有設定で、スクリプトを実行するユーザーに「編集者」または「閲覧者」権限を付与

#### 6. イベントオブジェクトが無効（`editHandler`のみ）

**エラーメッセージ例**:
- `editHandler: イベントオブジェクトが無効です`
- `editHandler: シートを取得できませんでした`

**確認方法**:
- トリガーが正しく設定されているか確認

**解決方法**:
1. Google Apps Scriptエディタで「トリガー」（時計アイコン）をクリック
2. `editHandler`関数に対する「編集時」トリガーが設定されているか確認
3. 設定されていない場合は、トリガーを追加

---

## 🛠️ 修正内容

### 追加したエラーハンドリング

1. **`refreshAttendeeStatus`関数**:
   - `try-catch`ブロックで全体を囲む
   - カレンダー取得時のエラーハンドリング
   - シート取得時のエラーハンドリング
   - 詳細なエラーログ出力

2. **`editHandler`関数**:
   - `try-catch`ブロックで全体を囲む
   - イベントオブジェクトの検証
   - シート取得時のエラーハンドリング
   - 詳細なエラーログ出力

### エラーログの確認方法

修正後のコードでは、エラー発生時に以下のようなログが出力されます：

```
refreshAttendeeStatus: エラーが発生しました: [エラーメッセージ]
エラースタック: [スタックトレース]
```

または

```
カレンダーの取得に失敗しました: [エラーメッセージ]
カレンダーID: [設定されているカレンダーID]
```

---

## 📝 次のステップ

1. **修正したコードを確認**
   - エラーハンドリングが追加されたコードを確認
   - `clasp push`でアップロード済み

2. **実行ログを確認**
   - 次回実行時に詳細なエラーメッセージがログに記録される
   - ログから具体的なエラー原因を特定

3. **エラー原因に応じて対処**
   - 上記の「よくあるエラー原因」を参照
   - 必要に応じて設定を修正

---

## 🔗 関連ドキュメント

- [README.md](../README.md) - プロジェクト概要
- [CLASP_SETUP.md](./CLASP_SETUP.md) - claspセットアップガイド
- [GOOGLE_API_SETUP.md](./GOOGLE_API_SETUP.md) - Google APIセットアップガイド

---

**作成者**: プロダクト企画チーム  
**最終更新**: 2025-11-19（Utils関数の遅延初期化対応を追加）

