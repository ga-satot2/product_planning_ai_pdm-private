# テストセットアップ・実行ガイド

**最終更新**: 2025年12月26日  
**目的**: テスト環境のセットアップから実行までの包括的なガイド

---

## 📋 目次

1. [フォーム側プロジェクトテストセットアップ](#フォーム側プロジェクトテストセットアップ)
2. [テスト用EventID登録ガイド](#テスト用eventid登録ガイド)
3. [テスト用パラメータの取得方法](#テスト用パラメータの取得方法)
4. [テスト実行手順](#テスト実行手順)

---

## フォーム側プロジェクトテストセットアップ

### 概要

フォーム側プロジェクトはGoogleフォームにバインドされているため、`clasp`での直接プッシュが困難です。  
テスト関数を手動でコピー&ペーストする方法を説明します。

### テスト関数ファイル

**ファイル**: `form_tests.gs`  
**場所**: `stock/projects/legal_department/legal_training_lms/documents/4_executing/development/prototypes/form_tests.gs`

### 手動セットアップ手順

#### 1. フォーム側プロジェクトを開く

1. Googleフォームを開く: https://docs.google.com/forms/d/1zdRfVLnbtfh0dxNLk8Cz5ItYDPuEqjbukGYpfsg5WQo/edit
2. 「⋮」（三点メニュー）→「スクリプトエディタ」をクリック
3. Apps Scriptエディタが開きます

#### 2. テスト関数を追加

1. Apps Scriptエディタで「+」（ファイルを追加）をクリック
2. 「スクリプト」を選択
3. ファイル名を「form_tests」に変更
4. `form_tests.gs`の内容をコピー&ペースト

#### 3. テスト関数の実行

1. 関数選択ドロップダウンから`testAllFormFunctions`を選択
2. 「実行」ボタンをクリック
3. 実行ログを確認

### テスト関数一覧

#### 統合テスト関数

- **`testAllFormFunctions()`**: すべてのフォーム側関数をテストする統合関数

#### 個別テスト関数

1. **`testRebuildDependencies()`**: `rebuildTrainingForm()`の依存関数をテスト（既存）
2. **`testGetScheduledCourses()`**: `getScheduledCourses()`をテスト
3. **`testOpenSourceSpreadsheet()`**: `openSourceSpreadsheet()`をテスト
4. **`testUpdateAttendeeStatus()`**: `updateAttendeeStatus()`をテスト
5. **`testListAllTriggers()`**: `listAllTriggers()`をテスト
6. **`testClearBrokenTriggers()`**: `clearBrokenTriggers()`をテスト
7. **`testAutoRebuildFormOnSchedule()`**: `autoRebuildFormOnSchedule()`の依存関数をテスト
8. **`testOnFormSubmit()`**: `onFormSubmit()`をモックイベントでテスト

### トラブルシューティング

#### エラー: "Utils ライブラリが読み込まれていません"

**原因**: `LMSUtils.gs`ライブラリがフォーム側プロジェクトに追加されていません。

**解決策**:
1. Apps Scriptエディタで「ライブラリ」をクリック
2. 「ライブラリを追加」をクリック
3. ライブラリID `1tjRFSbY1AuGmhEsKEgcBSLMJzaMYORdnIRApv6VhYkKOIswtD_EN9DtQ` を入力
4. 「追加」をクリック

#### エラー: "スプレッドシートが取得できませんでした"

**原因**: スクリプトプロパティに`SPREADSHEET_ID`または`SPREADSHEET_URL`が設定されていません。

**解決策**:
1. Apps Scriptエディタで「プロジェクトの設定」→「スクリプトプロパティ」を開く
2. `SPREADSHEET_ID`または`SPREADSHEET_URL`を追加
3. 値: `1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE`（スプレッドシートID）

### 参考情報

- フォーム側プロジェクトID: `1zdRfVLnbtfh0dxNLk8Cz5ItYDPuEqjbukGYpfsg5WQo`
- フォームURL: https://docs.google.com/forms/d/1zdRfVLnbtfh0dxNLk8Cz5ItYDPuEqjbukGYpfsg5WQo/edit
- スプレッドシートID: `1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE`
- LMSUtilsライブラリID: `1tjRFSbY1AuGmhEsKEgcBSLMJzaMYORdnIRApv6VhYkKOIswtD_EN9DtQ`

---

## テスト用EventID登録ガイド

### 📍 登録場所

テスト用EventIDは、**予約一覧シート**の**列H（イベントID列）**に登録します。

#### 予約一覧シートの構造

| 列 | ヘッダー名 | 説明 |
|----|-----------|------|
| A | 予約ID | 予約の一意識別子（自動採番） |
| B | コースID | コース一覧との関連（FY26-XX-XX形式） |
| C | 予約名 | コース名 |
| D | コース案内 | コース説明 |
| E | 日程 | 開催日 |
| F | 開始日時 | 開始時刻 |
| G | 完了日時 | 終了時刻 |
| **H** | **イベントID** | **Google CalendarイベントID** ← **ここに登録** |
| I | 最大参加者数 | 定員 |
| J | 現在の参加者数 | 現在の予約数 |
| K | ステータス | 予約ステータス |

---

### 🔧 登録方法

#### 方法1: `createTestEvent()`関数を使用（推奨）

**最も簡単な方法**です。この関数を実行すると、カレンダーにイベントを作成し、**自動的に予約一覧シートにも登録**されます。

##### 手順

1. **Apps Scriptエディタを開く**
   - スプレッドシートから「拡張機能」→「Apps Script」を選択
   - URL: `https://docs.google.com/spreadsheets/d/1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE/edit`

2. **`createTestEvent()`関数を実行**
   - 関数選択ドロップダウンから`createTestEvent`を選択
   - 「実行」ボタンをクリック

3. **実行ログを確認**
   - 実行ログに以下の情報が表示されます：
     ```
     ✅ イベント作成成功！
     完全なeventId: hvqdc7k9t1d96clvbq5nvk6jks@google.com
     短いeventId: hvqdc7k9t1d96clvbq5nvk6jks
     ✅ スプレッドシートにも登録しました（行: 86）
     ```

4. **予約一覧シートを確認**
   - スプレッドシートの「予約一覧」シートを開く
   - 最終行に新しい行が追加され、列HにeventIdが登録されていることを確認

##### 注意事項

- `createTestEvent()`を実行すると、**実際のGoogleカレンダーにテスト用イベントが作成**されます
- テストが終わったら、カレンダーからイベントを削除することを推奨します
- スプレッドシートへの登録に失敗した場合は、エラーメッセージが表示されます

---

#### 方法2: 手動で登録

既存のeventIdを手動で登録する場合の手順です。

##### 手順

1. **スプレッドシートを開く**
   - URL: `https://docs.google.com/spreadsheets/d/1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE/edit`

2. **「予約一覧」シートを開く**

3. **新しい行を追加**
   - 最終行の次の行に新しい行を追加

4. **必要な情報を入力**
   - **列A（予約ID）**: 行番号（例: 86）
   - **列B（コースID）**: 任意のコースID（例: `FY26-TEST-01`）
   - **列C（予約名）**: コース名（例: `[テスト] 継続研修テストイベント`）
   - **列D（コース案内）**: コース説明（任意）
   - **列E（日程）**: 開催日（例: `2025/12/27`）
   - **列F（開始日時）**: 開始時刻（例: `15:00`）
   - **列G（完了日時）**: 終了時刻（例: `16:00`）
   - **列H（イベントID）**: **テスト用eventId** ← **ここに登録**
   - **列I（最大参加者数）**: 定員（例: `10`）
   - **列J（現在の参加者数）**: 現在の予約数（例: `0`）
   - **列K（ステータス）**: ステータス（例: `予約受付中`）

##### eventIdの形式

eventIdは以下のいずれかの形式で登録できます：

1. **短い形式**（推奨）: `hvqdc7k9t1d96clvbq5nvk6jks`
2. **完全な形式**: `hvqdc7k9t1d96clvbq5nvk6jks@google.com`
3. **URL形式**: `https://www.google.com/calendar/event?eid=hvqdc7k9t1d96clvbq5nvk6jks`

**注意**: コードは自動的に形式を変換して処理しますが、**短い形式（@google.comの前の部分のみ）**を推奨します。

---

### 🔍 登録確認方法

#### `getTestData()`関数で確認

1. **Apps Scriptエディタで`getTestData()`を実行**
   - 関数選択ドロップダウンから`getTestData`を選択
   - 「実行」ボタンをクリック

2. **実行ログを確認**
   - 以下のように表示されれば、eventIdが正しく登録されています：
     ```
     取得したeventId一覧（1件）:
     1. eventId: hvqdc7k9t1d96clvbq5nvk6jks
       コース名: [テスト] 継続研修テストイベント
       URL: hvqdc7k9t1d96clvbq5nvk6jks
     ```
   - 0件の場合は、eventIdが登録されていません：
     ```
     取得したeventId一覧（0件）:
     ```

#### スプレッドシートで直接確認

1. **「予約一覧」シートを開く**
2. **列H（イベントID列）を確認**
   - 空欄でない行があれば、eventIdが登録されています
   - 空欄の場合は、eventIdが登録されていません

---

### ⚠️ よくある問題と解決方法

#### 問題1: `getTestData()`でeventIdが0件取得される

**原因**:
- 予約一覧シートの列H（イベントID列）が空欄
- eventIdの形式が正しくない

**解決方法**:
1. 予約一覧シートの列Hを確認
2. 空欄の場合は、`createTestEvent()`を実行するか、手動でeventIdを登録
3. eventIdの形式を確認（短い形式を推奨）

#### 問題2: `createTestEvent()`でスプレッドシートへの登録に失敗する

**原因**:
- スプレッドシートへのアクセス権限がない
- シート名が正しくない

**解決方法**:
1. スプレッドシートへのアクセス権限を確認
2. 実行ログのエラーメッセージを確認
3. 手動でeventIdを登録する（方法2を参照）

#### 問題3: `testChangeReservation()`で2つ目のeventIdが必要

**原因**:
- 予約変更テストには、2つの異なるeventIdが必要

**解決方法**:
1. `createTestEvent()`を2回実行して、2つのテスト用イベントを作成
2. または、既存のeventIdを2つ使用
3. `getTestData()`で2つ以上のeventIdが取得できることを確認

---

## テスト用パラメータの取得方法

### 📋 概要

パラメータが必要な関数をテストするには、実際のスプレッドシートから取得したデータを使用する必要があります。

---

### 🔍 テストに必要なパラメータの取得方法

#### 1. `findEventInfoByEventId(eventId, utilsInstance)`

**必要なパラメータ:**
- `eventId`: カレンダーイベントID（文字列）
- `utilsInstance`: `getUtils()`で取得したUtilsインスタンス（オプション）

**取得方法:**
1. スプレッドシートの「予約一覧」シートを開く
2. 「EVENT_URL」列から実際のイベントURLを確認
3. イベントURLから`eventId`を抽出（`eid=`パラメータから取得、またはURL全体）

**テスト用コード例:**
```javascript
function testFindEventInfoByEventId() {
  try {
    const utils = getUtils();
    
    // 方法1: スプレッドシートから実際のeventIdを取得
    const eventsSheet = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName('予約一覧'); // シート名を確認
    const lastRow = eventsSheet.getLastRow();
    
    // EVENT_URL列からeventIdを取得
    for (let i = 2; i <= lastRow; i++) {
      const eventUrl = eventsSheet.getRange(i, EVENT_URL_COLUMN).getValue();
      if (eventUrl && eventUrl.indexOf('eid=') !== -1) {
        const eventId = utils.eventIdFromURL(eventUrl);
        Logger.log(`テスト用eventId: ${eventId}`);
        
        // テスト実行
        const eventInfo = findEventInfoByEventId(eventId, utils);
        if (eventInfo) {
          Logger.log(`✅ イベント情報取得成功: ${JSON.stringify(eventInfo)}`);
          return eventInfo;
        }
      }
    }
    
    Logger.log('⚠️ 有効なeventIdが見つかりませんでした');
    return null;
  } catch (error) {
    Logger.log(`❌ エラー: ${error.toString()}`);
    return null;
  }
}
```

---

#### 2. `cancelReservation(email, eventId)`

**必要なパラメータ:**
- `email`: 参加者のメールアドレス（文字列）
- `eventId`: カレンダーイベントID（文字列）

**取得方法:**
1. スプレッドシートの「参加情報」シートを開く
2. 「メールアドレス」列から実際のメールアドレスを確認
3. 「予約一覧」シートから実際の`eventId`を取得

**テスト用コード例:**
```javascript
function testCancelReservation() {
  try {
    // 実際のメールアドレスとeventIdを設定
    const testEmail = 't_sato2@ga-tech.co.jp'; // 実際のメールアドレスに変更
    const testEventId = '実際のeventId'; // 上記のtestFindEventInfoByEventId()で取得したeventIdを使用
    
    Logger.log(`cancelReservation(${testEmail}, ${testEventId})を実行中...`);
    const result = cancelReservation(testEmail, testEventId);
    
    if (result) {
      Logger.log('✅ cancelReservation()成功');
    } else {
      Logger.log('❌ cancelReservation()失敗');
    }
    
    return result;
  } catch (error) {
    Logger.log(`❌ エラー: ${error.toString()}`);
    return false;
  }
}
```

---

#### 3. `changeReservation(email, oldEventId, newEventId)`

**必要なパラメータ:**
- `email`: 参加者のメールアドレス（文字列）
- `oldEventId`: 変更前のカレンダーイベントID（文字列）
- `newEventId`: 変更後のカレンダーイベントID（文字列）

**取得方法:**
1. スプレッドシートの「参加情報」シートからメールアドレスを取得
2. 「予約一覧」シートから2つの異なる`eventId`を取得（同じコースの異なる日時など）

**テスト用コード例:**
```javascript
function testChangeReservation() {
  try {
    // 実際のメールアドレスとeventIdを設定
    const testEmail = 't_sato2@ga-tech.co.jp'; // 実際のメールアドレスに変更
    const oldEventId = '変更前のeventId'; // 実際のeventIdに変更
    const newEventId = '変更後のeventId'; // 実際のeventIdに変更
    
    Logger.log(`changeReservation(${testEmail}, ${oldEventId}, ${newEventId})を実行中...`);
    const result = changeReservation(testEmail, oldEventId, newEventId);
    
    if (result) {
      Logger.log('✅ changeReservation()成功');
    } else {
      Logger.log('❌ changeReservation()失敗');
    }
    
    return result;
  } catch (error) {
    Logger.log(`❌ エラー: ${error.toString()}`);
    return false;
  }
}
```

---

#### 4. `markAttendeeAsReserved(email, eventId, utilsInstance)`

**必要なパラメータ:**
- `email`: 参加者のメールアドレス（文字列）
- `eventId`: カレンダーイベントID（文字列）
- `utilsInstance`: `getUtils()`で取得したUtilsインスタンス（オプション）

**取得方法:**
- 上記の`cancelReservation`と同じ方法で取得

**テスト用コード例:**
```javascript
function testMarkAttendeeAsReserved() {
  try {
    const utils = getUtils();
    const testEmail = 't_sato2@ga-tech.co.jp'; // 実際のメールアドレスに変更
    const testEventId = '実際のeventId'; // 実際のeventIdに変更
    
    Logger.log(`markAttendeeAsReserved(${testEmail}, ${testEventId})を実行中...`);
    markAttendeeAsReserved(testEmail, testEventId, utils);
    Logger.log('✅ markAttendeeAsReserved()実行完了');
  } catch (error) {
    Logger.log(`❌ エラー: ${error.toString()}`);
  }
}
```

---

#### 5. `markAttendeeAsUnreserved(email, eventId, utilsInstance)`

**必要なパラメータ:**
- `email`: 参加者のメールアドレス（文字列）
- `eventId`: カレンダーイベントID（文字列）
- `utilsInstance`: `getUtils()`で取得したUtilsインスタンス（オプション）

**取得方法:**
- 上記の`cancelReservation`と同じ方法で取得

**テスト用コード例:**
```javascript
function testMarkAttendeeAsUnreserved() {
  try {
    const utils = getUtils();
    const testEmail = 't_sato2@ga-tech.co.jp'; // 実際のメールアドレスに変更
    const testEventId = '実際のeventId'; // 実際のeventIdに変更
    
    Logger.log(`markAttendeeAsUnreserved(${testEmail}, ${testEventId})を実行中...`);
    markAttendeeAsUnreserved(testEmail, testEventId, utils);
    Logger.log('✅ markAttendeeAsUnreserved()実行完了');
  } catch (error) {
    Logger.log(`❌ エラー: ${error.toString()}`);
  }
}
```

---

### 📝 実際のデータを取得するヘルパー関数

以下の関数をApps Scriptエディタで実行すると、テストに使える実際のデータを取得できます：

```javascript
/**
 * テスト用の実際のデータを取得する関数
 */
function getTestData() {
  try {
    const utils = getUtils();
    const config = getConfig();
    const sheets = getSheets();
    
    // 予約一覧シートからeventIdを取得
    const eventsSheet = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName(sheets.events.name);
    const lastRow = eventsSheet.getLastRow();
    
    const eventIds = [];
    for (let i = sheets.events.rows.FIRST; i <= lastRow; i++) {
      const eventUrl = eventsSheet.getRange(i, sheets.events.columns.EVENT_URL).getValue();
      if (eventUrl && eventUrl.indexOf('eid=') !== -1) {
        const eventId = utils.eventIdFromURL(eventUrl);
        const courseName = eventsSheet.getRange(i, sheets.events.columns.COURSE_NAME).getValue();
        eventIds.push({
          eventId: eventId,
          courseName: courseName,
          eventUrl: eventUrl
        });
      }
    }
    
    Logger.log(`取得したeventId一覧（${eventIds.length}件）:`);
    eventIds.forEach((item, index) => {
      Logger.log(`${index + 1}. eventId: ${item.eventId}, コース名: ${item.courseName}`);
    });
    
    // 参加情報シートからメールアドレスを取得
    const attendeesSheet = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName(sheets.attendees.name);
    const attendeesLastRow = attendeesSheet.getLastRow();
    
    const emails = [];
    for (let i = sheets.attendees.rows.FIRST; i <= attendeesLastRow; i++) {
      const email = attendeesSheet.getRange(i, sheets.attendees.columns.EMAIL).getValue();
      if (email && email.indexOf('@') !== -1) {
        emails.push(email);
      }
    }
    
    Logger.log(`取得したメールアドレス一覧（${emails.length}件）:`);
    emails.forEach((email, index) => {
      Logger.log(`${index + 1}. ${email}`);
    });
    
    return {
      eventIds: eventIds,
      emails: emails
    };
  } catch (error) {
    Logger.log(`❌ エラー: ${error.toString()}`);
    return null;
  }
}
```

---

### ⚠️ 注意事項

1. **実際のデータを使用するテスト**
   - テスト実行時は、実際のカレンダーイベントやスプレッドシートのデータが変更されます
   - テスト用のデータを使用するか、テスト後に手動で元に戻す必要があります

2. **権限の確認**
   - カレンダーへのアクセス権限が必要です
   - スプレッドシートへの編集権限が必要です

3. **テストの順序**
   - `markAttendeeAsReserved()` → `markAttendeeAsUnreserved()` の順でテストすると、データを元に戻せます
   - `cancelReservation()` → `addGuestToCalendarEvent()` の順でテストすると、予約を削除してから再追加できます

---

## テスト実行手順

### 📋 テスト実行前の準備

#### 1. Apps Scriptエディタにアクセス

**スプレッドシート側プロジェクト**:
- URL: https://script.google.com/d/1DiZUSkJU_Z4Yc0bBcNgOUH3iqHux8xnSS7qILL5YZMfKgw86QeMvx0S-/edit

#### 2. テスト用データの準備

テスト実行前に、テスト用イベントを作成します：

1. 関数選択ドロップダウンから`createTestEvent`を選択
2. 「実行」ボタンをクリック
3. 実行ログで`eventId`を確認

#### 3. スクリプトプロパティの確認

以下のプロパティが設定されていることを確認：
- `CALENDAR_ID`: GoogleカレンダーのID
- `SLACK_WEBHOOK_URL`: Slack通知用のWebhook URL（オプション）

---

### 🧪 テスト実行手順

#### 方法1: Playwrightを使った自動テスト実行（推奨）

**すべてのテストを自動実行し、カバレッジ100%を目指す場合**：

##### 前提条件

1. **Python 3.7以上**がインストールされていること
2. **Playwright**がインストールされていること
   ```bash
   pip install playwright
   playwright install chromium
   ```
3. **Chromeプロファイル**が設定されていること（初回のみ）
   - スクリプト実行時に自動的に`~/.playwright_chrome_profile`が作成されます
   - Googleアカウントでログイン済みである必要があります

##### 全テストの自動実行

```bash
cd stock/projects/legal_department/legal_training_lms/documents/4_executing/development/prototypes
python3 scripts/run_all_tests.py
```

**実行内容**:
- 33個のテスト関数を自動的に実行
- 実行ログを自動取得・解析
- テスト結果をJSONレポートとして保存
- 成功/失敗/不明のサマリーを表示

**出力**:
- コンソール: 実行進捗とサマリー
- レポート: `logs/test_report_YYYYMMDD_HHMMSS.json`
- ログ: `logs/playwright_test_<関数名>_YYYYMMDD_HHMMSS.log`

##### 失敗したテストのみ再実行

```bash
python3 scripts/run_failed_tests.py
```

**実行内容**:
- 前回の実行で失敗したテストのみを再実行
- 長時間実行されるテスト（`testRebuildDependencies`、`testUpdateDashboardAfterReservation`など）には自動的に長い待機時間を設定

**改善点（2026年1月15日更新）**:
- 長時間実行されるテストへの対応（待機時間を90秒に延長）
- 「読み込んでいます...」で終わっているログの検出と完了待機
- リトライ回数を5回に増加
- 完了メッセージの検出ロジックを改善

##### トラブルシューティング

**エラー: "関数選択に失敗"**
- `tests.gs`ファイルが正しく開かれているか確認
- ブラウザが完全に読み込まれるまで待機時間を延長

**エラー: "ログ取得失敗"**
- 実行ログパネルが開かれているか確認
- 長時間実行されるテストの場合は、待機時間が自動的に延長されます

**エラー: "結果不明または失敗"**
- ログファイル（`logs/playwright_test_<関数名>_*.log`）を確認
- テストが実際に完了しているか、Apps Scriptエディタで手動確認

---

#### 方法2: 統合テストの実行（手動）

すべてのテストを一括実行する場合：

1. 関数選択ドロップダウンから`testAllUntestedFunctions`を選択
2. 「実行」ボタンをクリック
3. 実行ログを確認

**実行されるテスト**:
- `testRefreshAttendeeStatus()`
- `testHandleReservationFormSubmit()`
- `testOnCreatingSchedule()`
- `testOnDashboardAction()`
- `testEditHandler()`
- `testEnhancedFunctions()`
- `testCalendarEnhancedFunctions()`
- `testReservationChangeFunctions()`
- `testChangeReservation()`（修正版）
- `testImportReservationData()`（コメントアウト）

---

#### 方法3: 個別テストの実行

各テストを個別に実行する場合：

##### 1. 予約変更機能のテスト

```javascript
// 関数選択: testChangeReservation
// 実行
```

**注意**: このテストは2つ目のeventIdを自動生成します。

##### 2. カレンダー連携機能のテスト

```javascript
// 関数選択: testCalendarEnhancedFunctions
// 実行
```

**実行されるテスト**:
- `updateCalendarEvent()` - イベントタイトルの更新（元に戻す処理あり）
- `handleCancellation()` - キャンセル処理（状態を元に戻す処理あり）

##### 3. データインポート機能のテスト

```javascript
// 関数選択: testImportReservationData
// 実行
```

**⚠️ 注意**: このテストは実際のデータをインポートします。実行前に確認してください。

---

### ✅ テスト結果の確認

#### 実行ログの確認方法

1. Apps Scriptエディタで「実行ログ」を開く
2. 各テストの実行結果を確認：
   - ✅: テスト成功
   - ⚠️: 警告（期待値と異なるが、エラーではない）
   - ❌: エラーが発生

#### 期待される結果

##### 正常系テスト（100%）

すべてのテストが以下のように完了することを確認：

- ✅ `testChangeReservation()` - 予約変更テスト完了
- ✅ `testCalendarEnhancedFunctions()` - カレンダー連携テスト完了
  - ✅ `updateCalendarEvent()` - イベント更新成功
  - ✅ `handleCancellation()` - キャンセル処理成功
- ✅ `testImportReservationData()` - データインポートテスト関数追加済み

---

### 🔧 トラブルシューティング

#### エラー: "テスト用データが取得できませんでした"

**原因**: `createTestEvent()`が実行されていない、またはテスト用イベントが存在しない

**解決策**:
1. `createTestEvent()`を実行してテスト用イベントを作成
2. `getTestData()`を実行してテスト用データが取得できることを確認

#### エラー: "CALENDAR_ID が未設定です"

**原因**: スクリプトプロパティに`CALENDAR_ID`が設定されていない

**解決策**:
1. Apps Scriptエディタで「プロジェクトの設定」→「スクリプトプロパティ」を開く
2. `CALENDAR_ID`を追加
3. 値: GoogleカレンダーのID

#### エラー: "イベントが見つかりません"

**原因**: テスト用イベントが削除された、またはeventIdが正しくない

**解決策**:
1. `createTestEvent()`を再実行して新しいテスト用イベントを作成
2. `getTestData()`でeventIdを確認

#### エラー: "2つ目のeventIdが見つかりません"

**原因**: `testChangeReservation()`で2つ目のeventIdが必要だが、存在しない

**解決策**:
- 修正版の`testChangeReservation()`は自動的に2つ目のeventIdを生成します
- それでもエラーが出る場合は、`createTestEvent()`を2回実行して2つのテスト用イベントを作成

---

### 📊 テストカバレッジ確認

#### 正常系テスト: 100%

すべての正常系テストが完了したら、以下のカバレッジが達成されます：

| カテゴリ | カバレッジ |
|---------|-----------|
| 予約管理 | 100% |
| カレンダー連携 | 100% |
| 出席管理 | 100% |
| 通知機能 | 100% |
| データ管理 | 100% |
| **合計** | **100%** |

#### 全体テストカバレッジ: 92%

- **正常系**: 100%
- **閾値・エッジケース・異常系**: 80%

---

### 📝 テスト実行後の確認事項

#### 1. テスト用データのクリーンアップ

テスト実行後、以下の確認を行ってください：

- テスト用イベントが正しく作成・更新・削除されているか
- テスト用email（`t_sato2@ga-tech.co.jp`）の状態が正しく更新されているか
- 実際の従業員データに影響がないか

#### 2. ログの保存

実行ログを保存して、テスト結果を記録してください。

---

## 📚 関連ドキュメント

- [テスト実行時の安全対策方針](TEST_SAFETY_POLICY.md)
- [テスト実行状況・サマリー](テスト実行状況・サマリー.md)

---

---

## Playwrightを使った自動テスト実行（詳細）

### 📋 概要

Playwrightを使用して、Google Apps Scriptのテストを自動実行するスクリプトです。  
手動でのテスト実行を自動化し、テストカバレッジ100%を目指します。

### 🚀 セットアップ

#### 1. 必要なパッケージのインストール

```bash
pip install playwright
playwright install chromium
```

#### 2. Chromeプロファイルの設定

初回実行時に、`~/.playwright_chrome_profile`が自動的に作成されます。  
このプロファイルでGoogleアカウントにログインする必要があります。

**手動でログインする場合**:
1. スクリプトを実行すると、Chromeブラウザが自動的に開きます
2. Googleアカウントでログインします
3. Apps Scriptエディタへのアクセス権限を許可します

### 📝 スクリプトの使用方法

#### `run_all_tests.py` - 全テストの自動実行

**用途**: すべてのテスト関数（33個）を自動実行し、カバレッジ100%を目指す

**実行方法**:
```bash
cd stock/projects/legal_department/legal_training_lms/documents/4_executing/development/prototypes
python3 scripts/run_all_tests.py
```

**実行時間**: 約30-60分（テストの実行時間により異なる）

**出力**:
- コンソール: 実行進捗とサマリー
- レポート: `logs/test_report_YYYYMMDD_HHMMSS.json`
- ログ: 各テストの実行ログが`logs/playwright_test_<関数名>_*.log`に保存

**レポートの確認**:
```bash
# 最新のレポートを確認
python3 -c "
import json, glob, os
report_files = glob.glob('logs/test_report_*.json')
if report_files:
    latest = max(report_files, key=os.path.getmtime)
    with open(latest, 'r') as f:
        data = json.load(f)
    print(f'成功: {data[\"summary\"][\"success\"]}/{data[\"summary\"][\"total\"]}')
    print(f'失敗: {data[\"summary\"][\"failure\"]}/{data[\"summary\"][\"total\"]}')
    print(f'カバレッジ: {data[\"summary\"][\"coverage_percentage\"]:.1f}%')
"
```

#### `run_failed_tests.py` - 失敗したテストのみ再実行

**用途**: 前回の実行で失敗したテストのみを再実行

**実行方法**:
```bash
python3 scripts/run_failed_tests.py
```

**実行時間**: 約10-20分（失敗したテストの数により異なる）

**出力**:
- コンソール: 実行進捗とサマリー
- レポート: `logs/failed_tests_report_YYYYMMDD_HHMMSS.json`

### 🔧 改善内容（2026年1月15日）

#### 長時間実行されるテストへの対応

以下のテストは実行に時間がかかるため、自動的に長い待機時間（90秒）が設定されます：
- `testRebuildDependencies`
- `testUpdateDashboardAfterReservation`
- `testAll`

#### ログ取得の改善

- 「読み込んでいます...」で終わっているログを検出
- 完了メッセージが含まれるまで自動的に待機
- リトライ回数を5回に増加

#### 完了メッセージの検出

以下のキーワードが含まれている場合、テストが完了したと判定します：
- `完了`
- `✅`
- `❌`
- `testRebuildDependencies: 完了`
- `testUpdateDashboardAfterReservation: 完了`

### ⚠️ 注意事項

1. **ブラウザの自動操作**
   - スクリプト実行中は、ブラウザを手動で操作しないでください
   - ブラウザウィンドウは自動的に開閉されます

2. **ネットワークエラー**
   - ネットワークエラーが発生した場合、自動的にリトライされます（最大3回）
   - それでも失敗する場合は、手動で再実行してください

3. **実行時間**
   - 全テストの実行には30-60分かかります
   - 長時間実行されるテストは、自動的に長い待機時間が設定されます

4. **ログの保存**
   - 各テストの実行ログは`logs/`ディレクトリに保存されます
   - ログファイル名: `playwright_test_<関数名>_YYYYMMDD_HHMMSS.log`

### 📊 テスト結果の確認

#### レポートの確認

```bash
# 最新のレポートを確認
python3 << 'EOF'
import json, glob, os
from datetime import datetime

report_files = glob.glob('logs/test_report_*.json')
if report_files:
    latest = max(report_files, key=os.path.getmtime)
    with open(latest, 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    print("="*60)
    print("📊 テスト実行結果サマリー")
    print("="*60)
    print(f"✅ 成功: {data['summary']['success']}/{data['summary']['total']}")
    print(f"❌ 失敗: {data['summary']['failure']}/{data['summary']['total']}")
    print(f"📈 カバレッジ: {data['summary']['coverage_percentage']:.1f}%")
    print("="*60)
    
    # 失敗したテスト
    failed = [r for r in data['results'] if r.get('success') != True]
    if failed:
        print(f"\n❌ 失敗したテスト ({len(failed)}個):")
        for r in failed:
            func = r.get('test_function', 'unknown')
            error = r.get('error', '')
            print(f"  - {func}: {error[:70]}")
    
    print(f"\n📝 詳細レポート: {latest}")
    print(f"   更新時刻: {datetime.fromtimestamp(os.path.getmtime(latest))}")
EOF
```

#### ログファイルの確認

```bash
# 特定のテストのログを確認
cat logs/playwright_test_testErrorHandling_*.log | tail -50
```

---

**作成者**: プロダクト企画チーム  
**最終更新**: 2026年1月15日

