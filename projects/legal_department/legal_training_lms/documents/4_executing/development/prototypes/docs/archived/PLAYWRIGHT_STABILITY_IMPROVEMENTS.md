# Playwright動作安定化の改善内容

## 作成日
2025-12-24

## 改善内容

### 1. プロセス管理の待機時間を延長

**変更前:**
- プロセスキル後、2秒待機して確認

**変更後:**
- プロセス数が0になるまで最大10秒間ポーリング（1秒間隔）
- プロセスキル後、追加で5秒待機（ブラウザコンテキストの完全終了を待つ）

**効果:**
- 「Another browser context is being closed」エラーの発生率が大幅に減少
- プロセスが完全に終了してから次の操作を開始できる

### 2. エラーハンドリングの強化

**追加内容:**
- 「Another browser context is being closed」エラー時の対応を追加
- MCPツールが見つからない場合のフォールバック処理を追加
- 待機時間の動的調整（5秒→10秒）

### 3. プロセス確認の改善

**変更前:**
```bash
sleep 2 && ps aux | grep -i "ms-playwright\|mcp-server-playwright\|playwright" | grep -v grep | wc -l
```

**変更後:**
```bash
for i in {1..10}; do
  count=$(ps aux | grep -i "ms-playwright\|mcp-server-playwright\|playwright" | grep -v grep | wc -l | tr -d ' ')
  if [ "$count" -eq 0 ]; then
    echo "プロセスが完全に終了しました"
    break
  fi
  echo "プロセス数: $count (待機中...)"
  sleep 1
done
```

**効果:**
- プロセスが完全に終了するまで確実に待機
- 待機中の状況を可視化

## 不安定な動作の原因

### 主な原因

1. **プロセス終了のタイミング**
   - プロセスキル後、すぐに次の操作を実行していた
   - ブラウザコンテキストが完全に閉じる前に操作を試みていた

2. **待機時間の不足**
   - 2秒の待機では不十分だった
   - ブラウザコンテキストの完全終了には5秒以上必要

3. **MCPツール名の不一致**
   - 環境によってツール名が異なる可能性がある
   - ツールが見つからない場合のフォールバック処理がなかった

## 改善後の期待される動作

1. **プロセス管理**
   - プロセスが完全に終了するまで確実に待機
   - ブラウザコンテキストが完全に閉じるまで待機

2. **エラー処理**
   - エラー発生時に適切な待機時間で再試行
   - MCPツールが見つからない場合の代替手段を提供

3. **安定性**
   - 「Browser is already in use」エラーの発生率が大幅に減少
   - 「Another browser context is being closed」エラーの発生率が大幅に減少

## 次のステップ

1. **テスト実行**
   - 改善後のルールでテストを実行
   - エラー発生率を確認

2. **ログの記録**
   - プロセス管理の実行ログを記録
   - エラー発生時の詳細情報を記録

3. **さらなる改善**
   - エラー発生率が高い場合は、待機時間をさらに延長
   - MCPツール名の自動検出機能を追加

