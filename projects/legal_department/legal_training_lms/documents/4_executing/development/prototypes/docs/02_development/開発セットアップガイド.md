# 開発セットアップガイド

**プロジェクト**: 法務研修LMSシステム  
**作成日**: 2026-01-06  
**最終更新**: 2026-01-06  

このドキュメントでは、開発環境のセットアップ手順を説明します。

---

## 📋 目次

1. [clasp開発環境セットアップ](#1-clasp開発環境セットアップ)
2. [clasp開発ワークフロー](#2-clasp開発ワークフロー)
3. [Google API設定](#3-google-api設定)
4. [MCP/Playwright設定](#4-mcpplaywright設定)
5. [Slack設定](#5-slack設定)

---

## 1. clasp開発環境セットアップ

### 1.1 概要

clasp（Command Line Apps Script Projects）を使用して、Google Apps Scriptプロジェクトをコマンドラインから管理できるようにします。

### 1.2 前提条件

- Node.js (v18以上推奨)
- npm
- Googleアカウント

### 1.3 セットアップ手順

#### Step 1: Node.jsとnpmの確認

```bash
# Node.jsのバージョン確認
node --version  # v18以上推奨

# npmのバージョン確認
npm --version
```

Node.jsがインストールされていない場合：[Node.js公式サイト](https://nodejs.org/)からインストール

#### Step 2: claspのインストール

```bash
# グローバルにインストール
npm install -g @google/clasp

# インストール確認
clasp --version
```

#### Step 3: Googleアカウントでログイン

```bash
# ログイン（ブラウザが開きます）
clasp login

# ログイン状態の確認
clasp login --status
```

#### Step 4: Apps Script APIの有効化

1. [Apps Script設定ページ](https://script.google.com/home/usersettings)にアクセス
2. 「Google Apps Script API」を有効化

**重要**: この設定がないとclaspが動作しません。

#### Step 5: プロジェクトのセットアップ

**既存のプロジェクトに接続する場合**:

```bash
cd stock/projects/legal_department/legal_training_lms/documents/4_executing/development/prototypes

# スクリプトIDを指定して接続
clasp clone <SCRIPT_ID>
```

スクリプトIDの取得方法：
1. [Google Apps Script](https://script.google.com/)にアクセス
2. プロジェクトを開く
3. プロジェクト設定（⚙️）→「スクリプトID」をコピー

**新規プロジェクトを作成する場合**:

```bash
cd stock/projects/legal_department/legal_training_lms/documents/4_executing/development/prototypes

# 新規プロジェクトを作成
clasp create --title "法務研修LMS" --type webapp --rootDir src
```

### 1.4 プロジェクトID

- **form.gs**: フォームID `1zdRfVLnbtfh0dxNLk8Cz5ItYDPuEqjbukGYpfsg5WQo`
- **LMSUtils.gs**: スクリプトID `1tjRFSbY1AuGmhEsKEgcBSLMJzaMYORdnIRApv6VhYkKOIswtD_EN9DtQ`
- **sheet.gs**: スプレッドシートID `1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE`（バインドスクリプト）

### 1.5 clasp logsでログ取得を有効化する方法

`clasp logs`コマンドで実行ログを取得するには、GCPプロジェクトIDの設定が必要です。

#### ステップ1: Google Cloudプロジェクトを作成

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. プロジェクトを作成または既存プロジェクトを選択

#### ステップ2: Apps Script APIを有効化

1. APIライブラリを開く: https://console.cloud.google.com/apis/library
2. 「Apps Script API」を検索して有効化

#### ステップ3: プロジェクトIDを確認

Google Cloud ConsoleでプロジェクトID（数字）をコピー

#### ステップ4: .clasp.jsonにprojectIdを追加

```json
{
  "scriptId": "1DiZUSkJU_Z4Yc0bBcNgOUH3iqHux8xnSS7qILL5YZMfKgw86QeMvx0S-",
  "rootDir": "",
  "projectId": "123456789012",
  ...
}
```

---

## 2. clasp開発ワークフロー

### 2.1 ワークフローの全体像

```
環境確認 → プロジェクト接続 → コード確認 → テスト実行 → デプロイ
```

### 2.2 初回セットアップ

```bash
cd stock/projects/legal_department/legal_training_lms/documents/4_executing/development/prototypes

# 環境確認
./scripts/check_clasp_env.sh

# プロジェクト接続設定
./scripts/setup_project_connections.sh
```

### 2.3 基本的な開発フロー

#### 1. コードの確認

```bash
# 最新コードを取得
./scripts/check_code.sh

# または手動で
clasp pull
clasp status
```

#### 2. コードの編集

ローカルでコードを編集します。

```bash
# エディタで編集
code form.gs
code sheet.gs
code LMSUtils.gs
```

#### 3. テスト実行（オプション）

```bash
# 関数をテスト実行
./scripts/run_tests.sh

# または手動で
clasp run rebuildTrainingForm
clasp logs
```

**注意**: テスト実行時には、通知がt_sato2にだけ送られるように設定してください。

#### 4. デプロイ

```bash
# デプロイ実行
./scripts/deploy.sh

# または手動で
clasp push
clasp deploy --description "説明"
```

### 2.4 プロジェクト別の操作

**form.gsを操作する場合**:

```bash
# プロジェクトを切り替え
cp .clasp.json.form .clasp.json

# コードを取得・編集・デプロイ
clasp pull
code form.gs
clasp push
clasp deploy
```

**LMSUtils.gsを操作する場合**:

```bash
# プロジェクトを切り替え（デフォルト）
cp .clasp.json.utils .clasp.json

# コードを取得・編集・デプロイ
clasp pull
code LMSUtils.gs
clasp push
clasp deploy
```

**sheet.gsを操作する場合**:

`sheet.gs`はスプレッドシートにバインドされたスクリプトのため、スプレッドシートから直接編集するか、スクリプトIDを取得してclaspで操作します。

### 2.5 よく使うコマンド一覧

| コマンド | 説明 |
|---------|------|
| `clasp push` | ローカルコードをGoogle Apps Scriptにアップロード |
| `clasp pull` | Google Apps Scriptからコードをダウンロード |
| `clasp deploy` | Webアプリとしてデプロイ |
| `clasp deployments` | デプロイ一覧を表示 |
| `clasp open` | ブラウザでプロジェクトを開く |
| `clasp logs` | ログを確認 |
| `clasp run <関数名>` | 関数を実行 |
| `clasp status` | 変更状況を確認 |

### 2.6 注意事項

**`.clasp.json`について**:
- `.clasp.json`ファイルは機密情報（スクリプトID）を含むため、Gitにコミットしないでください
- `.gitignore`に追加済みです

**スクリプトプロパティ**:
- スクリプトプロパティ（`SPREADSHEET_ID`など）は、claspでは管理されません
- Google Apps Scriptエディタで手動で設定する必要があります

**ファイル名の変換**:
- claspはファイル名を以下のように変換します：
  - `code.gs` → `Code.gs`（Google Apps Script側）
  - `form.gs` → `Form.gs`（Google Apps Script側）
- Google Apps Script側では大文字小文字が区別されます

---

## 3. Google API設定

### 3.1 概要

法務研修LMSシステムでは、以下のGoogle APIを使用します：

- **Google Sheets API**: スプレッドシートの読み書き
- **Google Forms API**: フォームの管理・操作
- **Google Calendar API**: カレンダーイベントの作成・管理
- **Google Drive API**: ファイルの管理
- **Gmail API**: メール送信（Phase 2以降）

### 3.2 有効化が必要なAPI

**必須API（Phase 1）**:
- Google Sheets API ✅ 必須
- Google Forms API ✅ 必須
- Google Calendar API ✅ 必須
- Google Drive API ✅ 必須

**オプションAPI（Phase 2以降）**:
- Gmail API ⚠️ Phase 2

### 3.3 Google API有効化手順（個人プロジェクト）

#### Step 1: Google Cloudプロジェクトの確認・作成

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 既存のプロジェクトを選択、または新しいプロジェクトを作成

#### Step 2-5: 各APIを有効化

1. 左メニュー「APIとサービス」→「ライブラリ」をクリック
2. 検索ボックスにAPI名を入力（例: 「Google Sheets API」）
3. APIを選択して「有効にする」ボタンをクリック
4. 有効化が完了するまで数秒待機

**有効化するAPI**:
- Google Sheets API
- Google Forms API
- Google Calendar API
- Google Drive API
- Gmail API（Phase 2以降）

### 3.4 Google Apps Scriptプロジェクトでの設定

1. [Google Apps Script](https://script.google.com/)にアクセス
2. プロジェクト設定（⚙️）を開く
3. 「Google Cloud Platform プロジェクト」セクションで「プロジェクトを変更」をクリック
4. 個人プロジェクトIDを入力（例: `ppap00`）
5. 設定を保存

**注意**: プロジェクトを変更した後は、Webアプリを再デプロイする必要があります。

### 3.5 必要なスコープ（appsscript.json）

```json
{
  "oauthScopes": [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/forms",
    "https://www.googleapis.com/auth/calendar",
    "https://www.googleapis.com/auth/drive",
    "https://www.googleapis.com/auth/gmail.send",
    "https://www.googleapis.com/auth/userinfo.email",
    "https://www.googleapis.com/auth/script.container.ui"
  ]
}
```

---

## 4. MCP/Playwright設定

### 4.1 現在の設定（`.cursor/mcp.json`）

```json
{
  "mcpServers": {
    "playwright": {
      "command": "npx",
      "args": [
        "-y",
        "@playwright/mcp@latest"
      ]
    }
  }
}
```

**設定状態**: ✅ 適切に設定されています

**サーバー名**: `"playwright"`

### 4.2 Playwright MCPツール

利用可能なツール：
- `browser_navigate`: URLに移動
- `browser_snapshot`: ページのスナップショットを取得
- `browser_click`: 要素をクリック
- `browser_type`: テキストを入力
- `browser_take_screenshot`: スクリーンショットを取得
- `browser_wait_for`: 特定の条件を待機
- `browser_hover`: 要素にホバー
- `browser_select_option`: ドロップダウンでオプション選択
- `browser_press_key`: キーを押す
- `browser_navigate_back`: 前のページに戻る
- `browser_resize`: ブラウザウィンドウをリサイズ
- `browser_console_messages`: コンソールメッセージを取得
- `browser_network_requests`: ネットワークリクエストを取得

### 4.3 トラブルシューティング

**MCPツールが認識されない場合**:

1. **Cursorの再起動**
   - Cursorを完全に終了（Cmd+Q）
   - 5秒待機
   - Cursorを再度起動

2. **MCPサーバーの接続確認**
   - Cursorの右下にMCPサーバーの接続状態が表示される
   - コマンドパレット (Cmd+Shift+P) → 'MCP' で検索
   - `playwright`サーバーが接続されているか確認

3. **プロセス管理**
   ```bash
   # プロセス確認
   ps aux | grep -i "ms-playwright\|mcp-server-playwright\|playwright" | grep -v grep
   
   # プロセスキル
   pkill -9 -f "ms-playwright" && pkill -9 -f "mcp-server-playwright"
   
   # プロセス数が0になるまで待機（最大10秒）
   for i in {1..10}; do
     count=$(ps aux | grep -i "ms-playwright\|mcp-server-playwright\|playwright" | grep -v grep | wc -l | tr -d ' ')
     if [ "$count" -eq 0 ]; then
       echo "プロセスが完全に終了しました"
       break
     fi
     sleep 1
   done
   
   # 追加待機
   sleep 5
   ```

**重複エントリの問題**:
- CursorのMCP設定画面で、Playwrightサーバーが2つ登録されている場合
- 編集・削除アイコンがある方のPlaywrightエントリを削除
- 1つのPlaywrightエントリだけを残してCursorを再起動

### 4.4 参考資料

- Playwright MCP公式ドキュメント: https://github.com/playwright-community/playwright-mcp
- `.agent/rules_config/master_rules.yaml` - SYS-003ルール（Playwrightプロセス管理）

---

## 5. Slack設定

### 5.1 チャンネル情報

**テスト環境**:
- **チャンネル名**: `#bpi-solution-public`（デフォルト）
- **チャンネルID**: `C068DD0619D` ⚠️ **テスト用**
- **用途**: 開発・テスト時の通知

**本番環境**:
- **チャンネル名**: スプレッドシート参照
- **チャンネルID**: スプレッドシート参照
- **用途**: 未予約者へのリマインド通知（本番）
- **設定場所**: [アベンジャーズ_継続研修スプレッドシート](https://docs.google.com/spreadsheets/d/1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE/edit?gid=1568150033#gid=1568150033)
  - シートID: `1568150033`
  - スプレッドシートID: `1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE`

### 5.2 スクリプトプロパティ設定

Google Apps Scriptのスクリプトプロパティに以下の設定を追加してください：

**テスト環境**:
```
SLACK_WEBHOOK_URL = [テスト用Webhook URL]
SLACK_CHANNEL = #bpi-solution-public
SLACK_CHANNEL_ID = C068DD0619D  # テスト用
SLACK_USERNAME = Googleセミナー・個別面談申込通知bot
```

**本番環境**（デプロイ時に更新）:
```
SLACK_WEBHOOK_URL = [本番用Webhook URL]
SLACK_CHANNEL = [本番チャンネル名]
SLACK_CHANNEL_ID = [本番チャンネルID]  # スプレッドシートの「グループ一覧」シート参照
SLACK_USERNAME = Googleセミナー・個別面談申込通知bot
```

### 5.3 設定方法

1. Google Apps Scriptプロジェクトを開く
2. 左メニュー「プロジェクトの設定」（⚙️）をクリック
3. 「スクリプトプロパティ」セクションで以下を追加：
   - `SLACK_CHANNEL_ID` = `C068DD0619D`（テスト用）

### 5.4 本番環境のSlack ID取得方法

**スプレッドシートURL**: https://docs.google.com/spreadsheets/d/1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE/edit?gid=1568150033#gid=1568150033

**取得手順**:
1. 上記URLにアクセス
2. 「グループ一覧」シートを開く
3. 「SlackチャンネルID」列から各グループのSlack IDを確認
4. スクリプトプロパティに設定

**グループ構成**:
- 1期生: 143名
- 2期生: 203名
- 3期生: 1名

### 5.5 テスト実行時の注意事項

**重要**: テスト実行時には、通知が**t_sato2にだけ**送られるようにしてください。

**推奨される設定方法**:

**方法1: テスト用チャンネルまたはDMを使用**
```
SLACK_CHANNEL = @t_sato2  # DMの場合
# または
SLACK_CHANNEL_ID = [t_sato2専用チャンネルID]
```

**方法2: テスト実行時には通知を無効化**
```
SLACK_WEBHOOK_URL = [空にするか削除]
```

**テスト実行後の確認**:
- テスト実行後は、必ず本番環境の設定に戻す

---

## 🔧 トラブルシューティング

### clasp関連

**エラー: "Apps Script API has not been used"**
- 原因: Apps Script APIが有効化されていない
- 解決策: [Apps Script設定ページ](https://script.google.com/home/usersettings)でAPIを有効化

**エラー: "Script ID not found"**
- 原因: `.clasp.json`のスクリプトIDが間違っている
- 解決策: Google Apps ScriptでスクリプトIDを確認して更新

**エラー: "Permission denied"**
- 原因: プロジェクトへのアクセス権限がない
- 解決策: プロジェクトの所有者に共有を依頼

### Google API関連

**エラー: "API has not been used in project before or it is disabled"**
- 原因: APIが有効化されていない
- 解決方法: Google Cloud ConsoleでAPIを有効化

**エラー: "Permission denied" または "Access denied"**
- 原因: 必要な権限（スコープ）が設定されていない
- 解決方法: `appsscript.json`の`oauthScopes`を確認

### MCP/Playwright関連

**MCPツールが認識されない場合**
- Cursorを再起動
- MCPサーバーの接続状態を確認
- プロセスをクリーンアップ（上記のプロセス管理手順を参照）

---

**作成者**: プロダクト企画チーム  
**最終更新**: 2026-01-06

