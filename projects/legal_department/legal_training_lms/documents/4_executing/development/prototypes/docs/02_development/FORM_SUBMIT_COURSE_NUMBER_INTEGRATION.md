# フォーム送信時のコース番号連携とダッシュボード更新

**作成日**: 2026-01-05

## 概要

フォーム送信時に、コース一覧シートの「番号」を参照して参加情報を更新し、ダッシュボードシートを自動更新する機能を実装しました。

## 実装内容

### 1. フォーム送信時の処理フロー

```
フォーム送信
  ↓
onFormSubmit()
  ↓
カレンダーにゲスト追加
  ↓
updateAttendeeStatus()
  ├─ 予約一覧シートからコースIDを取得
  ├─ コース一覧シートから「番号」を取得
  └─ 参加情報シートの「①」「②」などの列を更新
  ↓
updateDashboardAfterReservation()
  └─ ダッシュボードシートを更新
```

### 2. コース一覧シートの参照

- **スプレッドシートID**: `1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE`
- **シートGID**: `1504366156`
- **参照列**: `コースID` → `番号`

### 3. 参加情報シートの更新

- コース一覧シートの「番号」を取得
- 番号を「①」「②」「③」などの形式に変換
- 参加情報シートの対応する列（①、②、③...）を更新

### 4. ダッシュボードシートの更新

- **シートGID**: `644656396`
- **C列（対象者人数）**: SUM関数で自動計算（手動設定）
- **D列（予約済み人数）**: 参加情報シートから自動カウント
- **E列（予約率）**: `(予約済み人数 / 対象者人数) * 100` で自動計算
- **F列（セレクトボックス）**: リマインドトリガー用

### 5. リマインド時のSlack通知

- F列のセレクトボックスで「未予約者に対してリマインド」を選択
- 対象グループ・コースの未予約者にSlack通知を送信
- 通知内容:
  - グループ名とコース名
  - 未予約者のSlackメンション（@username形式）
  - LMSのURL

## 実装された関数

### `getCourseNumberFromCourseList(courseId)`

コース一覧シートからコースIDに対応する「番号」を取得します。

**パラメータ**:
- `courseId` (string): コースID（例: `FY26-01-01`）

**戻り値**:
- `number` (number): コース番号（1-12）または`null`

### `updateAttendeeStatus(email, eventId)`（更新版）

予約一覧シートからコースIDを取得し、コース一覧シートの「番号」を参照して参加情報を更新します。

**処理フロー**:
1. 予約一覧シートから`eventId`に対応する`courseId`を取得
2. コース一覧シートから`courseId`に対応する「番号」を取得
3. 番号を「①」「②」などの形式に変換
4. 参加情報シートの対応する列を更新
5. ダッシュボードを更新

### `updateReservationVisualization()`（更新版）

ダッシュボードシートの予約状況を更新します。

**更新内容**:
- **C列（対象者人数）**: SUM関数で自動計算されるため、更新しない
- **D列（予約済み人数）**: 参加情報シートから「済み」ステータスの人数をカウント
- **E列（予約率）**: `(予約済み人数 / 対象者人数) * 100` で自動計算

### `getReservedCountForGroupAndCourse(group, courseName, attendeesSheet)`（更新版）

参加情報シートから予約済み人数を取得します。

**処理**:
1. コース名でヘッダーを検索
2. 見つからない場合、コース一覧シートから番号を取得して「①」「②」形式で検索
3. 対象グループでフィルタリング
4. 「済み」ステータスの人数をカウント

### `onDashboardAction(e)`（更新版）

F列のセレクトボックスでリマインドを実行します。

**処理**:
1. F列に「未予約者に対してリマインド」が選択されたことを検知
2. 対象グループ・コースの未予約者を取得
3. Slack通知を送信（`utils.sendSlack()`を使用）
4. 実行日時（G列）を更新
5. トリガー（F列）をクリア

## データフロー

### フォーム送信時

```
フォーム回答
  ↓
eventId取得
  ↓
予約一覧シートからcourseId取得
  ↓
コース一覧シートから「番号」取得
  ↓
参加情報シートの「①」「②」列を更新
  ↓
ダッシュボードシートのD列・E列を更新
```

### リマインド実行時

```
F列で「未予約者に対してリマインド」選択
  ↓
参加情報シートから未予約者を取得
  ↓
Slack通知を送信
  ↓
実行日時（G列）を更新
  ↓
トリガー（F列）をクリア
```

## 注意事項

1. **C列（対象者人数）の設定**
   - C列にはSUM関数を手動で設定する必要があります
   - 例: `=SUMIF(参加情報!C:C, A2, 参加情報!D:D)`
   - この関数は自動更新されません

2. **コース番号のマッピング**
   - 番号1 → ①
   - 番号2 → ②
   - ...
   - 番号12 → ⑫

3. **フォールバック処理**
   - コース一覧シートから番号を取得できない場合、コース名で検索します
   - これにより、既存の動作との互換性を保ちます

4. **ダッシュボード更新のタイミング**
   - フォーム送信時: `updateDashboardAfterReservation()`が呼び出されます
   - 手動更新: `updateReservationVisualization()`を実行

## テスト方法

1. **フォーム送信のテスト**
   - フォームから予約を送信
   - 参加情報シートの対応する列が「済み」に更新されることを確認
   - ダッシュボードシートのD列・E列が更新されることを確認

2. **リマインドのテスト**
   - ダッシュボードシートのF列で「未予約者に対してリマインド」を選択
   - Slack通知が送信されることを確認
   - 実行日時（G列）が更新されることを確認

## 関連ファイル

- `form.gs` / `Code.gs`: `updateAttendeeStatus()`, `getCourseNumberFromCourseList()`
- `reservation_enhanced.gs`: `updateReservationVisualization()`, `getReservedCountForGroupAndCourse()`
- `handlers.gs`: `onDashboardAction()`



**作成日**: 2026-01-05

## 概要

フォーム送信時に、コース一覧シートの「番号」を参照して参加情報を更新し、ダッシュボードシートを自動更新する機能を実装しました。

## 実装内容

### 1. フォーム送信時の処理フロー

```
フォーム送信
  ↓
onFormSubmit()
  ↓
カレンダーにゲスト追加
  ↓
updateAttendeeStatus()
  ├─ 予約一覧シートからコースIDを取得
  ├─ コース一覧シートから「番号」を取得
  └─ 参加情報シートの「①」「②」などの列を更新
  ↓
updateDashboardAfterReservation()
  └─ ダッシュボードシートを更新
```

### 2. コース一覧シートの参照

- **スプレッドシートID**: `1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE`
- **シートGID**: `1504366156`
- **参照列**: `コースID` → `番号`

### 3. 参加情報シートの更新

- コース一覧シートの「番号」を取得
- 番号を「①」「②」「③」などの形式に変換
- 参加情報シートの対応する列（①、②、③...）を更新

### 4. ダッシュボードシートの更新

- **シートGID**: `644656396`
- **C列（対象者人数）**: SUM関数で自動計算（手動設定）
- **D列（予約済み人数）**: 参加情報シートから自動カウント
- **E列（予約率）**: `(予約済み人数 / 対象者人数) * 100` で自動計算
- **F列（セレクトボックス）**: リマインドトリガー用

### 5. リマインド時のSlack通知

- F列のセレクトボックスで「未予約者に対してリマインド」を選択
- 対象グループ・コースの未予約者にSlack通知を送信
- 通知内容:
  - グループ名とコース名
  - 未予約者のSlackメンション（@username形式）
  - LMSのURL

## 実装された関数

### `getCourseNumberFromCourseList(courseId)`

コース一覧シートからコースIDに対応する「番号」を取得します。

**パラメータ**:
- `courseId` (string): コースID（例: `FY26-01-01`）

**戻り値**:
- `number` (number): コース番号（1-12）または`null`

### `updateAttendeeStatus(email, eventId)`（更新版）

予約一覧シートからコースIDを取得し、コース一覧シートの「番号」を参照して参加情報を更新します。

**処理フロー**:
1. 予約一覧シートから`eventId`に対応する`courseId`を取得
2. コース一覧シートから`courseId`に対応する「番号」を取得
3. 番号を「①」「②」などの形式に変換
4. 参加情報シートの対応する列を更新
5. ダッシュボードを更新

### `updateReservationVisualization()`（更新版）

ダッシュボードシートの予約状況を更新します。

**更新内容**:
- **C列（対象者人数）**: SUM関数で自動計算されるため、更新しない
- **D列（予約済み人数）**: 参加情報シートから「済み」ステータスの人数をカウント
- **E列（予約率）**: `(予約済み人数 / 対象者人数) * 100` で自動計算

### `getReservedCountForGroupAndCourse(group, courseName, attendeesSheet)`（更新版）

参加情報シートから予約済み人数を取得します。

**処理**:
1. コース名でヘッダーを検索
2. 見つからない場合、コース一覧シートから番号を取得して「①」「②」形式で検索
3. 対象グループでフィルタリング
4. 「済み」ステータスの人数をカウント

### `onDashboardAction(e)`（更新版）

F列のセレクトボックスでリマインドを実行します。

**処理**:
1. F列に「未予約者に対してリマインド」が選択されたことを検知
2. 対象グループ・コースの未予約者を取得
3. Slack通知を送信（`utils.sendSlack()`を使用）
4. 実行日時（G列）を更新
5. トリガー（F列）をクリア

## データフロー

### フォーム送信時

```
フォーム回答
  ↓
eventId取得
  ↓
予約一覧シートからcourseId取得
  ↓
コース一覧シートから「番号」取得
  ↓
参加情報シートの「①」「②」列を更新
  ↓
ダッシュボードシートのD列・E列を更新
```

### リマインド実行時

```
F列で「未予約者に対してリマインド」選択
  ↓
参加情報シートから未予約者を取得
  ↓
Slack通知を送信
  ↓
実行日時（G列）を更新
  ↓
トリガー（F列）をクリア
```

## 注意事項

1. **C列（対象者人数）の設定**
   - C列にはSUM関数を手動で設定する必要があります
   - 例: `=SUMIF(参加情報!C:C, A2, 参加情報!D:D)`
   - この関数は自動更新されません

2. **コース番号のマッピング**
   - 番号1 → ①
   - 番号2 → ②
   - ...
   - 番号12 → ⑫

3. **フォールバック処理**
   - コース一覧シートから番号を取得できない場合、コース名で検索します
   - これにより、既存の動作との互換性を保ちます

4. **ダッシュボード更新のタイミング**
   - フォーム送信時: `updateDashboardAfterReservation()`が呼び出されます
   - 手動更新: `updateReservationVisualization()`を実行

## テスト方法

1. **フォーム送信のテスト**
   - フォームから予約を送信
   - 参加情報シートの対応する列が「済み」に更新されることを確認
   - ダッシュボードシートのD列・E列が更新されることを確認

2. **リマインドのテスト**
   - ダッシュボードシートのF列で「未予約者に対してリマインド」を選択
   - Slack通知が送信されることを確認
   - 実行日時（G列）が更新されることを確認

## 関連ファイル

- `form.gs` / `Code.gs`: `updateAttendeeStatus()`, `getCourseNumberFromCourseList()`
- `reservation_enhanced.gs`: `updateReservationVisualization()`, `getReservedCountForGroupAndCourse()`
- `handlers.gs`: `onDashboardAction()`


**作成日**: 2026-01-05

## 概要

フォーム送信時に、コース一覧シートの「番号」を参照して参加情報を更新し、ダッシュボードシートを自動更新する機能を実装しました。

## 実装内容

### 1. フォーム送信時の処理フロー

```
フォーム送信
  ↓
onFormSubmit()
  ↓
カレンダーにゲスト追加
  ↓
updateAttendeeStatus()
  ├─ 予約一覧シートからコースIDを取得
  ├─ コース一覧シートから「番号」を取得
  └─ 参加情報シートの「①」「②」などの列を更新
  ↓
updateDashboardAfterReservation()
  └─ ダッシュボードシートを更新
```

### 2. コース一覧シートの参照

- **スプレッドシートID**: `1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE`
- **シートGID**: `1504366156`
- **参照列**: `コースID` → `番号`

### 3. 参加情報シートの更新

- コース一覧シートの「番号」を取得
- 番号を「①」「②」「③」などの形式に変換
- 参加情報シートの対応する列（①、②、③...）を更新

### 4. ダッシュボードシートの更新

- **シートGID**: `644656396`
- **C列（対象者人数）**: SUM関数で自動計算（手動設定）
- **D列（予約済み人数）**: 参加情報シートから自動カウント
- **E列（予約率）**: `(予約済み人数 / 対象者人数) * 100` で自動計算
- **F列（セレクトボックス）**: リマインドトリガー用

### 5. リマインド時のSlack通知

- F列のセレクトボックスで「未予約者に対してリマインド」を選択
- 対象グループ・コースの未予約者にSlack通知を送信
- 通知内容:
  - グループ名とコース名
  - 未予約者のSlackメンション（@username形式）
  - LMSのURL

## 実装された関数

### `getCourseNumberFromCourseList(courseId)`

コース一覧シートからコースIDに対応する「番号」を取得します。

**パラメータ**:
- `courseId` (string): コースID（例: `FY26-01-01`）

**戻り値**:
- `number` (number): コース番号（1-12）または`null`

### `updateAttendeeStatus(email, eventId)`（更新版）

予約一覧シートからコースIDを取得し、コース一覧シートの「番号」を参照して参加情報を更新します。

**処理フロー**:
1. 予約一覧シートから`eventId`に対応する`courseId`を取得
2. コース一覧シートから`courseId`に対応する「番号」を取得
3. 番号を「①」「②」などの形式に変換
4. 参加情報シートの対応する列を更新
5. ダッシュボードを更新

### `updateReservationVisualization()`（更新版）

ダッシュボードシートの予約状況を更新します。

**更新内容**:
- **C列（対象者人数）**: SUM関数で自動計算されるため、更新しない
- **D列（予約済み人数）**: 参加情報シートから「済み」ステータスの人数をカウント
- **E列（予約率）**: `(予約済み人数 / 対象者人数) * 100` で自動計算

### `getReservedCountForGroupAndCourse(group, courseName, attendeesSheet)`（更新版）

参加情報シートから予約済み人数を取得します。

**処理**:
1. コース名でヘッダーを検索
2. 見つからない場合、コース一覧シートから番号を取得して「①」「②」形式で検索
3. 対象グループでフィルタリング
4. 「済み」ステータスの人数をカウント

### `onDashboardAction(e)`（更新版）

F列のセレクトボックスでリマインドを実行します。

**処理**:
1. F列に「未予約者に対してリマインド」が選択されたことを検知
2. 対象グループ・コースの未予約者を取得
3. Slack通知を送信（`utils.sendSlack()`を使用）
4. 実行日時（G列）を更新
5. トリガー（F列）をクリア

## データフロー

### フォーム送信時

```
フォーム回答
  ↓
eventId取得
  ↓
予約一覧シートからcourseId取得
  ↓
コース一覧シートから「番号」取得
  ↓
参加情報シートの「①」「②」列を更新
  ↓
ダッシュボードシートのD列・E列を更新
```

### リマインド実行時

```
F列で「未予約者に対してリマインド」選択
  ↓
参加情報シートから未予約者を取得
  ↓
Slack通知を送信
  ↓
実行日時（G列）を更新
  ↓
トリガー（F列）をクリア
```

## 注意事項

1. **C列（対象者人数）の設定**
   - C列にはSUM関数を手動で設定する必要があります
   - 例: `=SUMIF(参加情報!C:C, A2, 参加情報!D:D)`
   - この関数は自動更新されません

2. **コース番号のマッピング**
   - 番号1 → ①
   - 番号2 → ②
   - ...
   - 番号12 → ⑫

3. **フォールバック処理**
   - コース一覧シートから番号を取得できない場合、コース名で検索します
   - これにより、既存の動作との互換性を保ちます

4. **ダッシュボード更新のタイミング**
   - フォーム送信時: `updateDashboardAfterReservation()`が呼び出されます
   - 手動更新: `updateReservationVisualization()`を実行

## テスト方法

1. **フォーム送信のテスト**
   - フォームから予約を送信
   - 参加情報シートの対応する列が「済み」に更新されることを確認
   - ダッシュボードシートのD列・E列が更新されることを確認

2. **リマインドのテスト**
   - ダッシュボードシートのF列で「未予約者に対してリマインド」を選択
   - Slack通知が送信されることを確認
   - 実行日時（G列）が更新されることを確認

## 関連ファイル

- `form.gs` / `Code.gs`: `updateAttendeeStatus()`, `getCourseNumberFromCourseList()`
- `reservation_enhanced.gs`: `updateReservationVisualization()`, `getReservedCountForGroupAndCourse()`
- `handlers.gs`: `onDashboardAction()`



**作成日**: 2026-01-05

## 概要

フォーム送信時に、コース一覧シートの「番号」を参照して参加情報を更新し、ダッシュボードシートを自動更新する機能を実装しました。

## 実装内容

### 1. フォーム送信時の処理フロー

```
フォーム送信
  ↓
onFormSubmit()
  ↓
カレンダーにゲスト追加
  ↓
updateAttendeeStatus()
  ├─ 予約一覧シートからコースIDを取得
  ├─ コース一覧シートから「番号」を取得
  └─ 参加情報シートの「①」「②」などの列を更新
  ↓
updateDashboardAfterReservation()
  └─ ダッシュボードシートを更新
```

### 2. コース一覧シートの参照

- **スプレッドシートID**: `1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE`
- **シートGID**: `1504366156`
- **参照列**: `コースID` → `番号`

### 3. 参加情報シートの更新

- コース一覧シートの「番号」を取得
- 番号を「①」「②」「③」などの形式に変換
- 参加情報シートの対応する列（①、②、③...）を更新

### 4. ダッシュボードシートの更新

- **シートGID**: `644656396`
- **C列（対象者人数）**: SUM関数で自動計算（手動設定）
- **D列（予約済み人数）**: 参加情報シートから自動カウント
- **E列（予約率）**: `(予約済み人数 / 対象者人数) * 100` で自動計算
- **F列（セレクトボックス）**: リマインドトリガー用

### 5. リマインド時のSlack通知

- F列のセレクトボックスで「未予約者に対してリマインド」を選択
- 対象グループ・コースの未予約者にSlack通知を送信
- 通知内容:
  - グループ名とコース名
  - 未予約者のSlackメンション（@username形式）
  - LMSのURL

## 実装された関数

### `getCourseNumberFromCourseList(courseId)`

コース一覧シートからコースIDに対応する「番号」を取得します。

**パラメータ**:
- `courseId` (string): コースID（例: `FY26-01-01`）

**戻り値**:
- `number` (number): コース番号（1-12）または`null`

### `updateAttendeeStatus(email, eventId)`（更新版）

予約一覧シートからコースIDを取得し、コース一覧シートの「番号」を参照して参加情報を更新します。

**処理フロー**:
1. 予約一覧シートから`eventId`に対応する`courseId`を取得
2. コース一覧シートから`courseId`に対応する「番号」を取得
3. 番号を「①」「②」などの形式に変換
4. 参加情報シートの対応する列を更新
5. ダッシュボードを更新

### `updateReservationVisualization()`（更新版）

ダッシュボードシートの予約状況を更新します。

**更新内容**:
- **C列（対象者人数）**: SUM関数で自動計算されるため、更新しない
- **D列（予約済み人数）**: 参加情報シートから「済み」ステータスの人数をカウント
- **E列（予約率）**: `(予約済み人数 / 対象者人数) * 100` で自動計算

### `getReservedCountForGroupAndCourse(group, courseName, attendeesSheet)`（更新版）

参加情報シートから予約済み人数を取得します。

**処理**:
1. コース名でヘッダーを検索
2. 見つからない場合、コース一覧シートから番号を取得して「①」「②」形式で検索
3. 対象グループでフィルタリング
4. 「済み」ステータスの人数をカウント

### `onDashboardAction(e)`（更新版）

F列のセレクトボックスでリマインドを実行します。

**処理**:
1. F列に「未予約者に対してリマインド」が選択されたことを検知
2. 対象グループ・コースの未予約者を取得
3. Slack通知を送信（`utils.sendSlack()`を使用）
4. 実行日時（G列）を更新
5. トリガー（F列）をクリア

## データフロー

### フォーム送信時

```
フォーム回答
  ↓
eventId取得
  ↓
予約一覧シートからcourseId取得
  ↓
コース一覧シートから「番号」取得
  ↓
参加情報シートの「①」「②」列を更新
  ↓
ダッシュボードシートのD列・E列を更新
```

### リマインド実行時

```
F列で「未予約者に対してリマインド」選択
  ↓
参加情報シートから未予約者を取得
  ↓
Slack通知を送信
  ↓
実行日時（G列）を更新
  ↓
トリガー（F列）をクリア
```

## 注意事項

1. **C列（対象者人数）の設定**
   - C列にはSUM関数を手動で設定する必要があります
   - 例: `=SUMIF(参加情報!C:C, A2, 参加情報!D:D)`
   - この関数は自動更新されません

2. **コース番号のマッピング**
   - 番号1 → ①
   - 番号2 → ②
   - ...
   - 番号12 → ⑫

3. **フォールバック処理**
   - コース一覧シートから番号を取得できない場合、コース名で検索します
   - これにより、既存の動作との互換性を保ちます

4. **ダッシュボード更新のタイミング**
   - フォーム送信時: `updateDashboardAfterReservation()`が呼び出されます
   - 手動更新: `updateReservationVisualization()`を実行

## テスト方法

1. **フォーム送信のテスト**
   - フォームから予約を送信
   - 参加情報シートの対応する列が「済み」に更新されることを確認
   - ダッシュボードシートのD列・E列が更新されることを確認

2. **リマインドのテスト**
   - ダッシュボードシートのF列で「未予約者に対してリマインド」を選択
   - Slack通知が送信されることを確認
   - 実行日時（G列）が更新されることを確認

## 関連ファイル

- `form.gs` / `Code.gs`: `updateAttendeeStatus()`, `getCourseNumberFromCourseList()`
- `reservation_enhanced.gs`: `updateReservationVisualization()`, `getReservedCountForGroupAndCourse()`
- `handlers.gs`: `onDashboardAction()`

