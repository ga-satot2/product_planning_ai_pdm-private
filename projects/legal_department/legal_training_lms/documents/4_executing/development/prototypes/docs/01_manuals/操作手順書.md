# 操作手順書

**作成日**: 2025-12-26  
**最終更新**: 2026-01-05  
**プロジェクト**: 法務研修LMSシステム

---

## 📋 共通事項

### Apps Scriptエディタの開き方

**方法1: スプレッドシートから開く（推奨）**
1. スプレッドシートを開く: `https://docs.google.com/spreadsheets/d/1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE/edit`
2. メニュー「拡張機能」→「Apps Script」を選択

**方法2: URLから直接開く**
- URL: `https://script.google.com/d/1DiZUSkJU_Z4Yc0bBcNgOUH3iqHux8xnSS7qILL5YZMfKgw86QeMvx0S-/edit`

### 対象スプレッドシート

- **スプレッドシートID**: `1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE`
- **Apps ScriptプロジェクトID**: `1DiZUSkJU_Z4Yc0bBcNgOUH3iqHux8xnSS7qILL5YZMfKgw86QeMvx0S-`

---

## 1. データ操作

### 1.1 コース一覧から予約セッションを作成

**概要**: コース一覧シートから3期生のコースを取得し、予約一覧シートに予約セッションを作成します。

**対象シート**:
- **コース一覧シート**: gid=`1504366156`
- **予約一覧シート**: シート名=`予約一覧`

**実行手順**:

1. **Apps Scriptエディタを開く**（共通事項を参照）

2. **関数を実行**
   - 関数選択ドロップダウンから `createReservationsFromCourseList` を選択
   - 「実行」ボタンをクリック
   - 初回実行時は承認が必要な場合があります

3. **実行ログを確認**
   ```
   === createReservationsFromCourseList: 開始 ===
   ✅ コース一覧シートを取得しました: [シート名]
   ✅ 予約一覧シートを取得しました: 予約一覧
   📊 3期生のコース数: [件数]件
   ✅ [件数]件の予約セッションを作成しました
   ⚠️  注意: 日程・日時・イベントIDは後で設定してください
   ```

**作成されるデータ**:

| 列 | ヘッダー名 | 設定値 |
|----|-----------|--------|
| A | 予約ID | 自動採番（既存の最大ID + 1から開始） |
| B | コースID | コース一覧シートから取得 |
| C | 予約名 | コース一覧シートから取得（コース名） |
| D | コース案内 | コース一覧シートから取得 |
| E | 日程 | **空欄**（後で設定） |
| F | 開始日時 | **空欄**（後で設定） |
| G | 完了日時 | **空欄**（後で設定） |
| H | イベントID | **空欄**（後で設定） |
| I | 最大参加者数 | 999（デフォルト） |
| J | 現在の参加者数 | 0 |
| K | ステータス | 予約受付中 |
| L | 対象グループ | 3期生 |

**注意事項**:
- 日程・日時・イベントIDは後で設定する必要があります
- コース一覧シートの「所属グループ」列に「3期生」という値が含まれている必要があります
- 既存の予約セッションとの重複チェックは行いません

**トラブルシューティング**:
- **エラー: 「コース一覧シートが見つかりませんでした」**
  - スプレッドシートIDが正しいか確認
  - コース一覧シートのgid（`1504366156`）が正しいか確認
- **エラー: 「予約一覧シートが見つかりませんでした」**
  - 予約一覧シートの名前が「予約一覧」であることを確認
- **「3期生のコースが見つかりませんでした」**
  - コース一覧シートの「所属グループ」列に「3期生」という値が含まれているか確認

---

### 1.2 データインポート

**概要**: 第3期生の出欠予約データを最新化します。

**対象データ**:
- **ソーススプレッドシートID**: `1D3s2KQB4O5IeJMBxS0XCYMZCEDnAXjxrTgJlvhGGdps`
- **最新の月別シート名**: 例: `25年11月`（実行時に最新の月別シート名に更新）
- **社名シート名**: `Asset/acqu/神居/Apart`

**実行手順**:

1. **Apps Scriptエディタを開く**（共通事項を参照）

2. **import_reservation_data.gsを確認**
   - 左側のファイルリストから`import_reservation_data.gs`を選択
   - `importReservationData()`関数の設定を確認
   - **重要**: `monthlySheet`の値を最新の月別シート名に更新

3. **データインポートを実行**
   - 関数選択ドロップダウンから`importReservationData`を選択
   - 「実行」ボタン（▶️）をクリック
   - 初回実行時は権限の許可が必要な場合があります

4. **インポート結果の確認**
   - 参加情報シートを開く
   - 第3期生の参加者名が正しく記録されているか確認
   - コース別の参加状況が正しく反映されているか確認

**注意事項**:
- 既存の参加情報は上書きされます
- 日付・時間情報がない場合は「未」と記録されます
- 既存のステータスがある場合は保持されます

**トラブルシューティング**:
- **月別シート名がわからない**
  - スプレッドシート `1D3s2KQB4O5IeJMBxS0XCYMZCEDnAXjxrTgJlvhGGdps` を開く
  - シート一覧から最新の月別シート名を確認
- **社名シートが見つからない**
  - スプレッドシート `1D3s2KQB4O5IeJMBxS0XCYMZCEDnAXjxrTgJlvhGGdps` を開く
  - シート一覧から `Asset/acqu/神居/Apart` を探す
  - 見つからない場合は、`rosterSheet` を空文字列 `''` に設定

---

## 2. テスト実行

**概要**: Apps Scriptエディタで手動でテストを実行する手順です。

**実行手順**:

1. **Apps Scriptエディタを開く**（共通事項を参照）

2. **tests.gsファイルを選択**
   - 左側のファイルリストから`tests.gs`をクリックして選択

3. **testAllUntestedFunctionsを実行**
   - 上部の関数選択ドロップダウンを開く
   - `testAllUntestedFunctions`を選択
   - 「実行」ボタン（▶️）をクリック
   - 初回実行時は権限の許可が必要な場合があります

4. **実行ログを確認**
   - 「実行ログ」ボタンをクリックしてログパネルを開く
   - 以下のログが表示されることを確認：
     ```
     === testAllUntestedFunctions: 開始 ===
     testRefreshAttendeeStatus()を実行...
     testHandleReservationFormSubmit()を実行...
     testOnCreatingSchedule()を実行...
     testOnDashboardAction()を実行...
     testEditHandler()を実行...
     === testAllUntestedFunctions: 完了 ===
     ✅ すべての未テスト関数のテストが完了しました！
     ```

**実行されるテスト関数**:

1. **testRefreshAttendeeStatus()** - `refreshAttendeeStatus()`を直接呼び出し
2. **testHandleReservationFormSubmit()** - モックイベントを使用して`handleReservationFormSubmit()`をテスト
3. **testOnCreatingSchedule()** - モックイベントを使用して`onCreatingSchedule()`をテスト
4. **testOnDashboardAction()** - モックイベントを使用して`onDashboardAction()`をテスト
5. **testEditHandler()** - モックイベントを使用して`editHandler()`をテスト

**注意事項**:
- モックイベントを使用するテストは、実際のデータに影響を与えません
- 一部のテストは、実際のスプレッドシートデータに依存する場合があります
- エラーが発生した場合は、実行ログを確認して原因を特定してください

---

## 3. コード更新

**概要**: スプレッドシートにバインドされたスクリプトの手動更新手順です。

**注意**: スプレッドシートにバインドされたスクリプトは、`clasp push`では更新されません。関数を追加・更新する場合は、必ずApps Scriptエディタで手動で行ってください。

**手動追加手順**:

1. **Apps Scriptエディタを開く**（共通事項を参照）

2. **`Code.gs`ファイルの最後に追加する関数**

   #### `getTestData()`関数
   
   テスト用の実際のデータを取得する関数です。この関数を実行すると、テストに使えるeventIdとemailの一覧がログに出力されます。
   
   ```javascript
   /**
    * テスト用の実際のデータを取得する関数
    * この関数を実行すると、テストに使えるeventIdとemailの一覧がログに出力されます
    */
   function getTestData() {
     try {
       Logger.log('=== getTestData: 開始 ===');
       
       const utils = getUtils();
       const config = getConfig();
       const sheets = getSheets();
       
       // 予約一覧シートからeventIdを取得
       const eventsSheet = CustomUtils.getSheetByName(sheets.events.name);
       if (!eventsSheet) {
         Logger.log(`❌ シートが見つかりません: ${sheets.events.name}`);
         return null;
       }
       
       const lastRow = eventsSheet.getLastRow();
       Logger.log(`予約一覧シートの最終行: ${lastRow}`);
       
       const eventIds = [];
       for (let i = sheets.events.rows.FIRST; i <= lastRow; i++) {
         const eventUrl = eventsSheet.getRange(i, sheets.events.columns.EVENT_URL).getValue();
         if (eventUrl && typeof eventUrl === 'string' && eventUrl.indexOf('eid=') !== -1) {
           const eventId = utils.eventIdFromURL(eventUrl);
           const courseName = eventsSheet.getRange(i, sheets.events.columns.COURSE_NAME).getValue();
           eventIds.push({
             eventId: eventId,
             courseName: courseName,
             eventUrl: eventUrl
           });
         } else if (eventUrl && typeof eventUrl === 'string' && eventUrl.trim() !== '') {
           // eventIdが直接入っている場合
           const courseName = eventsSheet.getRange(i, sheets.events.columns.COURSE_NAME).getValue();
           eventIds.push({
             eventId: eventUrl.trim(),
             courseName: courseName,
             eventUrl: eventUrl
           });
         }
       }
       
       Logger.log(`\n取得したeventId一覧（${eventIds.length}件）:`);
       eventIds.forEach((item, index) => {
         Logger.log(`${index + 1}. eventId: ${item.eventId}`);
         Logger.log(`   コース名: ${item.courseName}`);
         Logger.log(`   URL: ${item.eventUrl}`);
       });
       
       // 参加情報シートからメールアドレスを取得
       const attendeesSheet = CustomUtils.getSheetByName(sheets.attendees.name);
       if (!attendeesSheet) {
         Logger.log(`❌ シートが見つかりません: ${sheets.attendees.name}`);
         return { eventIds: eventIds, emails: [] };
       }
       
       const attendeesLastRow = attendeesSheet.getLastRow();
       Logger.log(`\n参加情報シートの最終行: ${attendeesLastRow}`);
       
       const emails = [];
       for (let i = sheets.attendees.rows.FIRST; i <= attendeesLastRow; i++) {
         const email = attendeesSheet.getRange(i, sheets.attendees.columns.EMAIL).getValue();
         if (email && typeof email === 'string' && email.indexOf('@') !== -1) {
           emails.push(email.trim());
         }
       }
       
       Logger.log(`\n取得したメールアドレス一覧（${emails.length}件）:`);
       emails.forEach((email, index) => {
         Logger.log(`${index + 1}. ${email}`);
       });
       
       Logger.log('\n=== テスト用パラメータの使用例 ===');
       if (eventIds.length > 0 && emails.length > 0) {
         Logger.log(`// findEventInfoByEventId()のテスト`);
         Logger.log(`const utils = getUtils();`);
         Logger.log(`const eventInfo = findEventInfoByEventId('${eventIds[0].eventId}', utils);`);
         Logger.log(`\n// cancelReservation()のテスト`);
         Logger.log(`cancelReservation('${emails[0]}', '${eventIds[0].eventId}');`);
         Logger.log(`\n// changeReservation()のテスト（2つ以上のeventIdがある場合）`);
         if (eventIds.length > 1) {
           Logger.log(`changeReservation('${emails[0]}', '${eventIds[0].eventId}', '${eventIds[1].eventId}');`);
         }
       }
       
       Logger.log('\n=== getTestData: 完了 ===');
       
       return {
         eventIds: eventIds,
         emails: emails
       };
     } catch (error) {
       Logger.log(`❌ getTestData: エラーが発生しました`);
       Logger.log(`エラーメッセージ: ${error.toString()}`);
       Logger.log(`スタックトレース: ${error.stack}`);
       return null;
     }
   }
   ```

   #### 更新した`testAllSheetFunctions()`関数
   
   既存の`testAllSheetFunctions()`関数を以下のコードで置き換えてください：
   
   ```javascript
   /**
    * 全sheet.gs関数の統合テスト
    */
   function testAllSheetFunctions() {
     try {
       Logger.log('=== testAllSheetFunctions: 開始 ===');
       
       Logger.log('1. testSheetFunctions()を実行...');
       testSheetFunctions();
       
       Logger.log('\n2. getTestData()を実行してテスト用データを取得...');
       const testData = getTestData();
       if (testData && testData.eventIds.length > 0 && testData.emails.length > 0) {
         Logger.log('✅ テスト用データ取得成功');
         Logger.log(`   eventId: ${testData.eventIds[0].eventId}`);
         Logger.log(`   email: ${testData.emails[0]}`);
         
         Logger.log('\n3. findEventInfoByEventId()をテスト...');
         const utils = getUtils();
         const eventInfo = findEventInfoByEventId(testData.eventIds[0].eventId, utils);
         if (eventInfo) {
           Logger.log(`✅ findEventInfoByEventId()成功: ${JSON.stringify(eventInfo)}`);
         } else {
           Logger.log(`⚠️ findEventInfoByEventId()でイベントが見つかりませんでした: ${testData.eventIds[0].eventId}`);
         }
       } else {
         Logger.log('⚠️ テスト用データが取得できませんでした。手動でパラメータを設定してください。');
       }
       
       Logger.log('\n4. testCancelReservation()を実行...');
       testCancelReservation();
       
       Logger.log('\n5. testChangeReservation()を実行...');
       testChangeReservation();
       
       Logger.log('\n6. testMarkAttendeeAsReserved()を実行...');
       testMarkAttendeeAsReserved();
       
       Logger.log('\n7. testMarkAttendeeAsUnreserved()を実行...');
       testMarkAttendeeAsUnreserved();
       
       Logger.log('\n=== testAllSheetFunctions: 完了 ===');
     } catch (error) {
       Logger.log('❌ testAllSheetFunctions: エラーが発生しました');
       Logger.log('エラーメッセージ: ' + error.toString());
       Logger.log('スタックトレース: ' + error.stack);
     }
   }
   ```

3. **追加後の確認**
   - 関数選択ドロップダウンを確認
     - `getTestData`が表示されているか確認
     - `testAllSheetFunctions`が表示されているか確認
   - `getTestData()`を実行
     - 関数選択ドロップダウンから`getTestData`を選択
     - 「実行」ボタンをクリック
     - 実行ログで`eventId`と`email`の一覧を確認
   - `testAllSheetFunctions()`を実行
     - 関数選択ドロップダウンから`testAllSheetFunctions`を選択
     - 「実行」ボタンをクリック
     - 実行ログでテスト結果を確認

**注意事項**:
- スプレッドシートにバインドされたスクリプトは、`clasp push`では更新されません
- 関数を追加・更新する場合は、必ずApps Scriptエディタで手動で行ってください
- コードを追加した後は、必ず「保存」ボタンをクリックしてください

---

## 🔗 関連ドキュメント

- [関数リファレンス](../04_reference/function_reference.md)
- [スプレッドシート構造ドキュメント](../07_documentation/sheet_structure_documentation.md)

---

**作成者**: プロダクト企画チーム  
**最終更新**: 2026-01-05

