# テスト実行時の安全対策方針

**作成日**: 2025-12-25  
**目的**: テスト実行時に実際の従業員データに影響を与えないようにするための方針とルール

---

## 🎯 基本方針

**テスト実行時は、実際のスプレッドシートに記入されている従業員（テスト実行者以外）には影響を与えない**

### 原則

1. **テスト用データのみを使用**: テスト実行者のメールアドレス（`t_sato2@ga-tech.co.jp`）とテスト用イベントのみを使用
2. **実際の従業員データを読み取らない**: テスト実行時に実際の従業員のメールアドレスを取得しない
3. **通知を制御**: テスト実行時にはメール送信やSlack通知を制御する
4. **テスト用イベントの識別**: テスト用イベントはタイトルに「テスト」を含める

---

## 📋 安全対策の詳細

### 1. テスト用データの取得

#### `getTestData()`関数の安全対策

- **メールアドレス**: `t_sato2@ga-tech.co.jp`のみを返す
- **イベントID**: タイトルに「テスト」が含まれるイベントのみを取得
- **実際の従業員データ**: 取得しない、返さない

```javascript
// 安全な実装例
const TEST_EMAIL = 't_sato2@ga-tech.co.jp';
const emails = [TEST_EMAIL]; // テスト実行者のみ

// テスト用イベントのみを取得（タイトルに「テスト」が含まれるもの）
if (courseName && courseName.indexOf('テスト') !== -1) {
  // イベントを取得
}
```

### 2. テスト関数の安全な実行

#### 2.1. 予約関連のテスト

**影響範囲**: カレンダーイベントへのゲスト追加/削除、スプレッドシートへの書き込み

**安全対策**:
- テスト実行者のメールアドレスのみを使用
- テスト用イベント（`createTestEvent()`で作成）のみを使用
- 実際の従業員が予約しているイベントは使用しない

**対象関数**:
- `testCancelReservation()`
- `testChangeReservation()`
- `testMarkAttendeeAsReserved()`
- `testMarkAttendeeAsUnreserved()`

#### 2.2. ステータス更新のテスト

**影響範囲**: 全従業員のステータス更新（スプレッドシートへの書き込み）

**安全対策**:
- `testRefreshAttendeeStatus()`は実際のスプレッドシートに書き込むため、**テスト実行時は注意が必要**
- テスト実行時は、実際のデータに影響を与えないよう、テスト用のスプレッドシートを使用するか、実行後に手動で確認する

**対象関数**:
- `testRefreshAttendeeStatus()`

#### 2.3. フォーム送信のテスト

**影響範囲**: スプレッドシートへの書き込み、カレンダーイベントへのゲスト追加

**安全対策**:
- モックイベントを使用（実際のフォーム送信をシミュレート）
- テスト実行者のメールアドレスのみを使用
- テスト用イベントのみを使用

**対象関数**:
- `testHandleReservationFormSubmit()`

#### 2.4. スケジュール作成のテスト

**影響範囲**: カレンダーイベントの作成、スプレッドシートへの書き込み

**安全対策**:
- モックイベントを使用（実際のスプレッドシート編集をシミュレート）
- テスト実行時は実際のスプレッドシートに書き込まない

**対象関数**:
- `testOnCreatingSchedule()`

#### 2.5. ダッシュボードアクションのテスト

**影響範囲**: Slack通知の送信、スプレッドシートへの書き込み

**安全対策**:
- モックイベントを使用
- Slack通知はテスト実行時には無効化する（後述）

**対象関数**:
- `testOnDashboardAction()`

---

## 🔔 通知の制御

### メール送信の制御

**✅ テスト実行時のメール送信は問題ありません**

テスト実行時には、テスト実行者（`t_sato2@ga-tech.co.jp`）宛へのメール送信は許可されています。

**許可されるメール送信**:
- テスト実行者（`t_sato2@ga-tech.co.jp`）宛へのメール送信
- テスト用イベントに関するメール送信

**禁止されるメール送信**:
- テスト実行者以外の従業員宛へのメール送信

**現在の実装**:
- テスト関数は `t_sato2@ga-tech.co.jp` のみを使用するため、自動的にテスト実行者宛のみにメールが送信されます
- 追加の設定変更は不要です

### Slack通知の制御

**✅ テスト用チャンネルへの通知は問題ありません**

テスト実行時には、テスト用Slackチャンネル（`C068DD0619D`）への通知は許可されています。

**許可されるSlack通知**:
- テスト用チャンネル（`C068DD0619D`）への通知
- テスト実行者宛のDM通知

**禁止されるSlack通知**:
- 本番環境のSlackチャンネルへの通知
- テスト実行者以外の従業員が所属するチャンネルへの通知

**設定方法**:

1. **スクリプトプロパティでテスト用チャンネルを設定**:
   ```
   SLACK_CHANNEL_ID = C068DD0619D
   ```

2. **テスト実行前に設定を確認**:
   - Apps Scriptエディタ → プロジェクトの設定（⚙️）→ スクリプトプロパティ
   - `SLACK_CHANNEL_ID` が `C068DD0619D` に設定されていることを確認

3. **テスト実行後**:
   - テスト用チャンネル（`C068DD0619D`）への通知は継続して問題ありません
   - 本番環境のチャンネルに変更する必要はありません（テスト用チャンネルを継続使用可能）

---

## 🧪 テスト用イベントの作成

### `createTestEvent()`関数の使用

テスト用のカレンダーイベントを作成する際は、以下の点に注意：

1. **タイトルに「テスト」を含める**: `[テスト] 継続研修テストイベント`
2. **説明にテスト用であることを明記**: `これはテスト用のイベントです。削除しても問題ありません。`
3. **テスト実行者のみをゲストとして追加**: 実際の従業員は追加しない

```javascript
const eventTitle = '[テスト] 継続研修テストイベント';
const eventDescription = 'これはテスト用のイベントです。削除しても問題ありません。';
```

---

## ✅ テスト実行前のチェックリスト

テスト実行前に、以下の項目を確認してください：

- [ ] **スクリプトプロパティの確認**
  - [ ] `SLACK_CHANNEL_ID` が `C068DD0619D`（テスト用チャンネル）に設定されている
  - [ ] メール送信はテスト実行者（`t_sato2@ga-tech.co.jp`）宛のみ（自動的に制御される）

- [ ] **テスト用データの確認**
  - [ ] `getTestData()`を実行して、テスト用のemailとeventIdを確認
  - [ ] テスト用イベント（タイトルに「テスト」が含まれる）が存在する

- [ ] **実際の従業員データの確認**
  - [ ] テスト実行者が予約しているイベントのみを使用する
  - [ ] 実際の従業員が予約しているイベントは使用しない

---

## 🚨 注意事項

### 実行してはいけないテスト

以下のテストは、実際の従業員データに影響を与える可能性があるため、**注意が必要**です：

1. **`testRefreshAttendeeStatus()`**
   - 全従業員のステータスを更新するため、実行時は注意が必要
   - テスト実行後は、実際のデータが正しく更新されているか確認する

2. **`testOnDashboardAction()`**
   - Slack通知を送信するため、テスト実行前にSlack設定を確認する

3. **`testCalendarEnhancedFunctions()`内の`updateCalendarEvent()`と`handleCancellation()`**
   - 実際のカレンダーイベントを更新・キャンセルするため、テストコード内でコメントアウトされている
   - 実行する場合は、テスト用イベントのみを使用する

### テスト実行後の確認

テスト実行後は、以下の点を確認してください：

1. **スプレッドシートの確認**
   - テスト実行者以外の従業員のデータが変更されていないか確認
   - テスト実行者のデータのみが変更されているか確認

2. **カレンダーの確認**
   - テスト用イベントのみが作成・更新・削除されているか確認
   - 実際の従業員が予約しているイベントが変更されていないか確認

3. **通知の確認**
   - メールはテスト実行者（`t_sato2@ga-tech.co.jp`）宛のみに送信されているか確認
   - Slack通知はテスト用チャンネル（`C068DD0619D`）にのみ送信されているか確認
   - 本番環境のチャンネルやテスト実行者以外の従業員に通知が送信されていないか確認

---

## 📝 テスト関数の修正例

### `getTestData()`関数の修正

```javascript
/**
 * テスト用の実際のデータを取得する関数
 * ⚠️ 安全のため、テスト用のemail（t_sato2@ga-tech.co.jp）のみを返します
 * 実際の従業員データに影響を与えないようにするため、他の従業員のメールアドレスは返しません
 */
function getTestData() {
  // テスト用のemailのみを返す
  const TEST_EMAIL = 't_sato2@ga-tech.co.jp';
  const emails = [TEST_EMAIL];
  
  // テスト用イベント（タイトルに「テスト」が含まれるもの）のみを取得
  // ...
}
```

### テスト関数での安全な実行

```javascript
function testCancelReservation() {
  // テスト実行者のメールアドレスのみを使用
  const testEmail = 't_sato2@ga-tech.co.jp';
  
  // テスト用イベントのみを使用（createTestEvent()で作成）
  const testEventId = 'test_event_id_from_createTestEvent';
  
  // 実際の従業員が予約しているイベントは使用しない
  // ...
}
```

---

## 🔄 テスト実行フロー

### 1. テスト実行前の準備

```bash
# 1. コードをプッシュ
clasp push

# 2. Apps Scriptエディタでスクリプトプロパティを確認
# - SLACK_CHANNEL_ID をテスト用に設定
# - TEST_MODE を 'true' に設定（必要に応じて）
```

### 2. テスト用データの準備

```javascript
// Apps Scriptエディタで実行
// 1. テスト用イベントを作成
createTestEvent();

// 2. テスト用データを取得（t_sato2@ga-tech.co.jpのみ）
getTestData();
```

### 3. テストの実行

```javascript
// Apps Scriptエディタで実行
// 統合テストを実行
testAllUntestedFunctions();

// または個別のテストを実行
testCancelReservation();
testChangeReservation();
// ...
```

### 4. テスト実行後の確認

```javascript
// 1. 実行ログを確認
// 2. スプレッドシートを確認（テスト実行者以外のデータが変更されていないか）
// 3. カレンダーを確認（テスト用イベントのみが変更されているか）
// 4. 通知を確認（テスト実行者以外に通知が送信されていないか）
```

### 5. テスト実行後のクリーンアップ

```bash
# 1. スクリプトプロパティの確認
# - SLACK_CHANNEL_ID が C068DD0619D（テスト用チャンネル）のままでも問題ありません
# - メール送信はテスト実行者宛のみ（自動的に制御される）

# 2. テスト用イベントを削除（必要に応じて）
# - カレンダーから手動で削除
# - または、テスト用イベントは残しておいても問題ありません
```

---

## 📚 関連ドキュメント

- [テスト実行継続ガイド](TEST_EXECUTION_CONTINUATION.md) - テスト実行の手順
- [Slack設定ガイド](SLACK_CONFIG.md) - Slack通知の設定方法
- [テスト結果サマリー](TEST_RESULTS_SUMMARY.md) - テスト実行結果の記録方法

---

**最終更新**: 2025-12-25  
**作成者**: プロダクト企画チーム

