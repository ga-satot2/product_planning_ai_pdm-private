# テスト観点とカバレッジ分析

**作成日**: 2025-12-26  
**目的**: 現在のテストで担保されている内容と、不足しているテスト観点の明確化

---

## 📋 目次

1. [現在のテスト観点](#現在のテスト観点)
2. [不足しているテスト観点](#不足しているテスト観点)
3. [閾値・エッジケースのテスト](#閾値エッジケースのテスト)
4. [推奨される追加テスト](#推奨される追加テスト)

---

## 現在のテスト観点

### ✅ 正常系テスト（実装済み）

#### 1. 予約管理機能

**`testEnhancedFunctions()`**:
- ✅ `checkEventCapacity()` - 正常なイベントIDで定員チェック
- ✅ `checkDuplicateReservation()` - 正常なemailとeventIdで重複チェック
- ✅ `updateReservationVisualization()` - 正常なデータで可視化更新
- ✅ `updateReservationList()` - 正常なデータで一覧更新

**テスト観点**:
- 正常な入力値での動作確認
- 戻り値の存在確認
- エラーが発生しないことの確認

#### 2. 予約変更機能

**`testReservationChangeFunctions()`**:
- ✅ `checkChangeDeadline()` - 正常なeventIdで期限チェック
- ✅ `checkChangeLimit()` - 正常なemailとeventIdで変更回数チェック
- ✅ `getAvailableSessionsForChange()` - 正常なemailとeventIdで変更可能セッション取得

**テスト観点**:
- 正常な入力値での動作確認
- 戻り値の存在確認
- メッセージの確認

#### 3. 出席管理機能

**`testRefreshAttendeeStatus()`**:
- ✅ テスト用emailのみを対象にした更新
- ✅ エラーが発生しないことの確認

**テスト観点**:
- テストモードでの安全な実行
- エラーハンドリングの確認

#### 4. カレンダー連携機能

**`testHandleReservationFormSubmit()`**:
- ✅ モックイベントでのフォーム送信処理
- ✅ ゲスト追加の実行確認

**`testOnCreatingSchedule()`**:
- ✅ モックイベントでのスケジュール作成処理
- ✅ イベント作成の実行確認

**テスト観点**:
- モックイベントでの動作確認
- エラーが発生しないことの確認

---

## 不足しているテスト観点

### ❌ 閾値・境界値テスト（未実装）

#### 1. 定員管理機能の閾値テスト

**`checkEventCapacity()`**:
- ❌ **定員0人の場合** - 定員が0人に設定されている場合の動作
- ❌ **定員最大人数の場合** - 定員が最大人数に達している場合の動作
- ❌ **定員最大+1人の場合** - 定員を1人超えた場合の動作
- ❌ **定員未設定（null）の場合** - 定員が設定されていない場合の動作
- ❌ **参加者数0人の場合** - 参加者が0人の場合の動作
- ❌ **参加者数が負の値の場合** - 不正なデータの場合の動作

**推奨テストケース**:
```javascript
// 定員0人のテスト
const capacity0 = checkEventCapacity(eventId); // maxAttendees = 0
// 期待値: isFull = true, availableSpots = 0

// 定員最大人数のテスト
const capacityMax = checkEventCapacity(eventId); // currentAttendees = maxAttendees
// 期待値: isFull = true, availableSpots = 0

// 定員最大+1人のテスト
const capacityOver = checkEventCapacity(eventId); // currentAttendees = maxAttendees + 1
// 期待値: isFull = true, availableSpots = 0

// 定員未設定のテスト
const capacityNull = checkEventCapacity(eventId); // maxAttendees = null
// 期待値: maxAttendees = 999, isFull = false, availableSpots = 999
```

#### 2. 変更期限の閾値テスト

**`checkChangeDeadline()`**:
- ❌ **3日前の0時00分00秒** - 期限の境界値（変更可能）
- ❌ **3日前の23時59分59秒** - 期限の境界値（変更可能）
- ❌ **2日前の0時00分00秒** - 期限を1秒過ぎた場合（変更不可）
- ❌ **当日の場合** - 当日の変更可否
- ❌ **過去のイベントの場合** - 過去のイベントの変更可否

**推奨テストケース**:
```javascript
// 3日前の0時00分00秒のテスト
const deadline = new Date(eventStart);
deadline.setDate(deadline.getDate() - 3);
deadline.setHours(0, 0, 0, 0);
// 現在時刻がdeadlineの1秒前の場合: isValid = true
// 現在時刻がdeadlineの1秒後の場合: isValid = false

// 3日前の23時59分59秒のテスト
deadline.setHours(23, 59, 59, 999);
// 現在時刻がdeadlineの1秒前の場合: isValid = true
// 現在時刻がdeadlineの1秒後の場合: isValid = false

// 2日前の0時00分00秒のテスト
deadline.setDate(deadline.getDate() + 1);
deadline.setHours(0, 0, 0, 0);
// 期待値: isValid = false, message = "変更期限を過ぎています"
```

#### 3. 変更回数の閾値テスト

**`checkChangeLimit()`**:
- ❌ **変更回数0回の場合** - まだ変更していない場合（変更可能）
- ❌ **変更回数1回の場合** - 1回変更済みの場合（変更不可）
- ❌ **変更回数2回の場合** - 2回変更済みの場合（変更不可）
- ❌ **変更履歴が存在しない場合** - 変更履歴が記録されていない場合

**推奨テストケース**:
```javascript
// 変更回数0回のテスト
const limit0 = checkChangeLimit(email, eventId); // changeCount = 0
// 期待値: isValid = true, changeCount = 0

// 変更回数1回のテスト
const limit1 = checkChangeLimit(email, eventId); // changeCount = 1
// 期待値: isValid = false, changeCount = 1, message = "変更回数の上限に達しています"

// 変更回数2回のテスト
const limit2 = checkChangeLimit(email, eventId); // changeCount = 2
// 期待値: isValid = false, changeCount = 2
```

### ❌ エッジケーステスト（未実装）

#### 1. 不正な入力値のテスト

**`checkEventCapacity()`**:
- ❌ **eventIdがnullの場合**
- ❌ **eventIdが空文字列の場合**
- ❌ **eventIdが存在しない場合**
- ❌ **eventIdが不正な形式の場合**

**`checkDuplicateReservation()`**:
- ❌ **emailがnullの場合**
- ❌ **emailが空文字列の場合**
- ❌ **emailが不正な形式の場合**
- ❌ **eventIdがnullの場合**
- ❌ **eventIdが空文字列の場合**

**`checkChangeDeadline()`**:
- ❌ **eventIdがnullの場合**
- ❌ **eventIdが存在しない場合**
- ❌ **カレンダーIDが未設定の場合**

**`checkChangeLimit()`**:
- ❌ **emailがnullの場合**
- ❌ **emailが空文字列の場合**
- ❌ **eventIdがnullの場合**
- ❌ **参加情報シートにデータがない場合**

#### 2. データ不整合のテスト

**`refreshAttendeeStatus()`**:
- ❌ **カレンダーイベントが存在しない場合**
- ❌ **参加情報シートにデータがない場合**
- ❌ **イベント情報と参加情報の不整合**

**`handleReservationFormSubmit()`**:
- ❌ **フォーム送信データが不完全な場合**
- ❌ **eventIdがフォーム回答に含まれていない場合**
- ❌ **グループ情報が不正な場合**

#### 3. 同時実行のテスト

**`checkDuplicateReservation()`**:
- ❌ **同時に同じイベントに予約しようとした場合**
- ❌ **予約処理中に定員が満員になった場合**

**`checkEventCapacity()`**:
- ❌ **定員チェック中に参加者が追加された場合**
- ❌ **定員チェック中に参加者が削除された場合**

---

## 閾値・エッジケースのテスト

### 1. 定員管理機能の閾値テスト

#### テストケース1: 定員0人の場合
```javascript
function testEventCapacityBoundaryZero() {
  // 定員0人のイベントを作成
  // 期待値: isFull = true, availableSpots = 0
}
```

#### テストケース2: 定員最大人数の場合
```javascript
function testEventCapacityBoundaryMax() {
  // 定員が最大人数に達しているイベント
  // 期待値: isFull = true, availableSpots = 0
}
```

#### テストケース3: 定員最大+1人の場合
```javascript
function testEventCapacityBoundaryOver() {
  // 定員を1人超えたイベント
  // 期待値: isFull = true, availableSpots = 0
}
```

#### テストケース4: 定員未設定の場合
```javascript
function testEventCapacityBoundaryNull() {
  // 定員が設定されていないイベント
  // 期待値: maxAttendees = 999, isFull = false, availableSpots = 999
}
```

### 2. 変更期限の閾値テスト

#### テストケース1: 3日前の0時00分00秒
```javascript
function testChangeDeadlineBoundary3DaysBefore() {
  // イベント開始時刻の3日前の0時00分00秒
  // 現在時刻がその1秒前: isValid = true
  // 現在時刻がその1秒後: isValid = false
}
```

#### テストケース2: 3日前の23時59分59秒
```javascript
function testChangeDeadlineBoundary3DaysBeforeEnd() {
  // イベント開始時刻の3日前の23時59分59秒
  // 現在時刻がその1秒前: isValid = true
  // 現在時刻がその1秒後: isValid = false
}
```

#### テストケース3: 2日前の0時00分00秒
```javascript
function testChangeDeadlineBoundary2DaysBefore() {
  // イベント開始時刻の2日前の0時00分00秒
  // 期待値: isValid = false, message = "変更期限を過ぎています"
}
```

### 3. 変更回数の閾値テスト

#### テストケース1: 変更回数0回
```javascript
function testChangeLimitBoundaryZero() {
  // まだ変更していない場合
  // 期待値: isValid = true, changeCount = 0
}
```

#### テストケース2: 変更回数1回
```javascript
function testChangeLimitBoundaryOne() {
  // 1回変更済みの場合
  // 期待値: isValid = false, changeCount = 1, message = "変更回数の上限に達しています"
}
```

#### テストケース3: 変更回数2回
```javascript
function testChangeLimitBoundaryTwo() {
  // 2回変更済みの場合
  // 期待値: isValid = false, changeCount = 2
}
```

### 4. 不正な入力値のテスト

#### テストケース1: eventIdがnull
```javascript
function testInvalidEventIdNull() {
  const result = checkEventCapacity(null);
  // 期待値: null または エラー
}
```

#### テストケース2: eventIdが空文字列
```javascript
function testInvalidEventIdEmpty() {
  const result = checkEventCapacity('');
  // 期待値: null または エラー
}
```

#### テストケース3: eventIdが存在しない
```javascript
function testInvalidEventIdNotFound() {
  const result = checkEventCapacity('nonexistent_event_id');
  // 期待値: null または エラー
}
```

#### テストケース4: emailがnull
```javascript
function testInvalidEmailNull() {
  const result = checkDuplicateReservation(null, eventId);
  // 期待値: false または エラー
}
```

#### テストケース5: emailが空文字列
```javascript
function testInvalidEmailEmpty() {
  const result = checkDuplicateReservation('', eventId);
  // 期待値: false または エラー
}
```

---

## 実装済みテスト

### ✅ 閾値テスト（実装完了）

#### 1. 定員管理機能の閾値テスト
- ✅ `testEventCapacityBoundary()` - 定員0人のテスト
- ✅ `testEventCapacityBoundary()` - 定員最大人数のテスト
- ✅ `testEventCapacityBoundary()` - 定員未設定（null）のテスト

#### 2. 変更期限の閾値テスト
- ✅ `testChangeDeadlineBoundary()` - 3日前の0時00分00秒のテスト
- ✅ `testChangeDeadlineBoundary()` - 3日前の23時59分59秒のテスト
- ✅ `testChangeDeadlineBoundary()` - 2日前の0時00分00秒のテスト

#### 3. 変更回数の閾値テスト
- ✅ `testChangeLimitBoundary()` - 変更回数0回のテスト
- ✅ `testChangeLimitBoundary()` - 変更回数1回のテスト（ロジック確認）
- ✅ `testChangeLimitBoundary()` - 変更回数2回のテスト（ロジック確認）

### ✅ エッジケーステスト（実装完了）

#### 4. 不正な入力値のテスト
- ✅ `testInvalidInputs()` - eventIdがnull/空文字列/存在しない場合
- ✅ `testInvalidInputs()` - emailがnull/空文字列/不正な形式の場合
- ✅ `testInvalidInputs()` - カレンダーIDが未設定の場合

#### 5. データ不整合のテスト
- ✅ `testDataInconsistency()` - カレンダーIDが未設定の場合
- ✅ `testDataInconsistency()` - 参加情報シートにデータがない場合
- ✅ `testDataInconsistency()` - イベント情報が存在しない場合

### ✅ 異常系テスト（実装完了）

#### 6. エラーハンドリングのテスト
- ✅ `testErrorHandling()` - checkEventCapacity()のエラーハンドリング
- ✅ `testErrorHandling()` - checkDuplicateReservation()のエラーハンドリング
- ✅ `testErrorHandling()` - checkChangeDeadline()のエラーハンドリング
- ✅ `testErrorHandling()` - checkChangeLimit()のエラーハンドリング

### ✅ 統合テスト（実装完了）

#### 7. すべてのテストを実行する統合テスト
- ✅ `testAllBoundaryAndEdgeCases()` - すべての閾値・エッジケース・異常系テストを実行

### ⏳ 未実装テスト（優先度: 低）

#### 8. 同時実行のテスト
- [ ] 同時に同じイベントに予約しようとした場合
- [ ] 定員チェック中に参加者が追加/削除された場合

---

## 現在のテストカバレッジ

### 正常系テスト: ✅ 76%

| 機能 | 正常系 | 閾値テスト | エッジケース | 異常系 |
|------|--------|-----------|-------------|--------|
| 定員管理 | ✅ | ✅ | ✅ | ✅ |
| 重複チェック | ✅ | ❌ | ✅ | ✅ |
| 変更期限チェック | ✅ | ✅ | ✅ | ✅ |
| 変更回数チェック | ✅ | ✅ | ✅ | ✅ |
| 出席情報更新 | ✅ | ❌ | ❌ | ❌ |

### 総合カバレッジ: 約85%

- **正常系**: 76% ✅
- **閾値テスト**: 80% ✅
- **エッジケース**: 75% ✅
- **異常系**: 80% ✅

---

## テスト実装の推奨事項

### 1. 閾値テストの実装

各機能について、以下の閾値テストを実装することを推奨します：

1. **定員管理機能**
   - 定員0人、最大人数、最大+1人、未設定の各ケース

2. **変更期限チェック**
   - 3日前の0時、3日前の23:59、2日前の0時の各ケース

3. **変更回数チェック**
   - 0回、1回、2回の各ケース

### 2. エッジケーステストの実装

以下のエッジケースをテストすることを推奨します：

1. **不正な入力値**
   - null、undefined、空文字列
   - 存在しないID
   - 不正な形式のデータ

2. **データ不整合**
   - カレンダーイベントが存在しない
   - スプレッドシートにデータがない
   - データの不整合

### 3. 異常系テストの実装

以下の異常系をテストすることを推奨します：

1. **エラーハンドリング**
   - エラーが正しく処理されるか
   - エラーメッセージが適切か
   - エラー時にシステムがクラッシュしないか

---

## 📊 テスト観点のまとめ

### 現在実装されているテスト観点

1. ✅ **正常系テスト** - 正常な入力値での動作確認
2. ✅ **戻り値の確認** - 関数が正しい値を返すか
3. ✅ **エラーが発生しないことの確認** - 正常系でのエラーがないか

### 実装済みテスト観点

1. ✅ **閾値テスト** - 境界値での動作確認（実装完了）
2. ✅ **エッジケーステスト** - 特殊なケースでの動作確認（実装完了）
3. ✅ **異常系テスト** - 不正な入力値での動作確認（実装完了）
4. ✅ **エラーハンドリングテスト** - エラーが正しく処理されるか（実装完了）
5. ✅ **データ不整合テスト** - データが不整合な場合の動作確認（実装完了）

### 未実装テスト観点（優先度: 低）

6. ❌ **同時実行テスト** - 同時実行時の動作確認（未実装）

---

## 🔗 関連ドキュメント

- [機能全体像とテストカバレッジ](機能全体像とテストカバレッジ.md)
- [テストカバレッジレポート](development/prototypes/docs/TEST_COVERAGE_REPORT.md)
- [テスト安全対策ポリシー](development/prototypes/docs/TEST_SAFETY_POLICY.md)

---

**作成者**: プロダクト企画チーム  
**最終更新**: 2025-12-26

