# 現状システム設計書 - 法務研修LMS

**プロジェクト**: 法務研修LMSシステム  
**作成日**: 2025-11-14  
**最終更新**: 2025-11-14  
**対象システム**: Google Drive上の既存システム（アベンジャーズ継続研修）

---

## 📋 概要

このドキュメントは、Google Drive上で運用されている既存の法務研修LMSシステムの現状設計を記録したものです。

**Google Driveフォルダ**: https://drive.google.com/drive/folders/1rpazwIC2lqTig9reMsG9Akgx-eOgHX-e

---

## 🏗️ システムアーキテクチャ

### 全体構成

```
┌─────────────────────────────────────────────────────────┐
│              Google Workspace 統合システム               │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────┐      ┌──────────────┐               │
│  │ Google フォーム │      │ Google Calendar │           │
│  │ (予約フォーム)  │◄────►│  (研修イベント)  │           │
│  └──────┬───────┘      └──────┬───────┘               │
│         │                      │                        │
│         │                      │                        │
│         ▼                      ▼                        │
│  ┌──────────────────────────────────────┐              │
│  │  Google スプレッドシート              │              │
│  │  (アベンジャーズ_継続研修)             │              │
│  │  - グループ一覧                        │              │
│  │  - コース一覧                          │              │
│  │  - 予約一覧                            │              │
│  │  - 参加情報                            │              │
│  │  - ダッシュボード                      │              │
│  └──────┬───────────────────────────────┘              │
│         │                                                │
│         ▼                                                │
│  ┌──────────────┐      ┌──────────────┐                 │
│  │ Google Apps  │      │   Slack API  │                 │
│  │    Script    │─────►│  (通知機能)  │                 │
│  │              │      │              │                 │
│  │ - form.gs    │      └──────────────┘                 │
│  │ - LMSUtils.gs│                                        │
│  │ - sheet.gs   │                                        │
│  └──────────────┘                                        │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

---

## 📊 データ構造

### スプレッドシート構造

#### 1. グループ一覧シート

| 列名 | 説明 | データ型 |
|------|------|----------|
| グループ名 | グループ名（1期生、2期生、3期生） | 文字列 |
| 在籍メンバー数 | グループの在籍人数 | 数値 |
| SlackチャンネルID | Slack通知用チャンネルID | 文字列 |

**現在のデータ**:
- 1期生: 143名
- 2期生: 203名
- 3期生: 1名

#### 2. コース一覧シート

| 列名 | 説明 | データ型 |
|------|------|----------|
| 番号 | コース番号 | 数値 |
| 開催年度 | 年度（FY26など） | 文字列 |
| 所属グループ | 対象グループ（1期生、2期生、3期生） | 文字列 |
| コースID | 自動発行ID（FY26-XX-XX形式） | 文字列 |
| コース名 | コース名 | 文字列 |
| コース案内 | コース説明・URL | 文字列 |
| 授業時間（分） | 授業時間（分） | 数値 |

**コース構成**:
- **1期生**: 9コース（コンプライアンス総則、基礎クレーム、説明責任、守秘義務・個人情報、損害賠償責任、解除・取消し、サブリース物件、SOSについて）
- **2期生**: 12コース（コンプライアンス＆会社ルールについて、契約＆契約手続きについて、お客様対応について、契約の解約・解除＆損害賠償請求について、個人情報について、クレーム対応の極意について、クレーム対応の文書/メール作成について、販売契約＆売買取引トラブル＆実需仲介について、仕入れ契約＆仕入れについて、マスターリース・サブリース＆トラブルについて、管理委託＆賃貸借契約、賃貸借トラブル対応、賃貸借トラブル対応）
- **3期生**: 12コース（2期生と同じ構成）

#### 3. 予約一覧シート

| 列名 | 説明 | データ型 | 備考 |
|------|------|----------|------|
| 予約ID | 予約の一意識別子 | 数値 | 自動採番 |
| コースID | コース一覧との関連 | 文字列 | FY26-XX-XX形式 |
| 予約名 | コース名 | 文字列 | |
| コース案内 | コース説明 | 文字列 | |
| 日程 | 開催日 | 日付 | |
| 開始日時 | 開始時刻 | 時刻 | |
| 完了日時 | 終了時刻 | 時刻 | |
| イベントID | Google CalendarイベントID | 文字列 | カレンダー作成時に自動設定 |
| 予約状況 | 予約状況 | 文字列 | 「設定する」「設定済み」「設定不可」など |
| TARGET_GROUP | 対象グループ | 文字列 | 「1期生」「2期生」「3期生」「All」 |

**予約状況の値**:
- `設定する`: カレンダーイベント作成トリガー
- `設定済み`: カレンダーイベント作成完了
- `設定不可`: エラー発生時
- `日時問題`: 日時データが不正な場合
- `設定不可`: その他のエラー

#### 4. 参加情報シート

| 列名 | 説明 | データ型 | 備考 |
|------|------|----------|------|
| 対象者 | 受講者名 | 文字列 | A列 |
| メールアドレス | 受講者メールアドレス | 文字列 | B列 |
| 所属グループ | 所属グループ | 文字列 | C列 |
| [コース1] | コンプライアンス＆会社ルールについて | 文字列 | D列 |
| [コース2] | 契約＆契約手続きについて | 文字列 | E列 |
| [コース3] | お客様対応について | 文字列 | F列 |
| [コース4] | 契約の解約・解除＆損害賠償請求について | 文字列 | G列 |
| [コース5] | 個人情報について | 文字列 | H列 |
| [コース6] | クレーム対応の極意について | 文字列 | I列 |
| [コース7] | クレーム対応の文書/メール作成について | 文字列 | J列 |
| [コース8] | 販売契約＆売買取引トラブル＆実需仲介について | 文字列 | K列 |
| [コース9] | 仕入れ契約＆仕入れについて | 文字列 | L列 |
| [コース10] | マスターリース・サブリース＆トラブルについて | 文字列 | M列 |
| [コース11] | 管理委託＆賃貸借契約、賃貸借トラブル対応 | 文字列 | N列 |
| [コース12] | 賃貸借トラブル対応 | 文字列 | O列 |

**ステータス値**:
- `未`: 未予約
- `済み`: 予約済み

**現在のデータ**: 約500名の受講者データ

#### 5. ダッシュボードシート

| 列名 | 説明 | データ型 | 備考 |
|------|------|----------|------|
| グループ | グループ名 | 文字列 | A列 |
| コース名 | コース名 | 文字列 | B列 |
| 対象者人数 | 対象者数 | 数値 | C列 |
| 予約済み | 予約済み人数 | 数値 | D列 |
| 予約率 | 予約率（%） | 数値 | E列 |
| アクション | リマインドトリガー | 文字列 | F列 |
| 最後のリマインド | 最終リマインド日時 | 日時 | G列 |

**アクション値**:
- `未予約者へリマインド`: Slackリマインド送信トリガー
- （空）: トリガーなし

---

## 🔄 処理フロー

### 1. 研修枠作成フロー

```
1. 管理者が「予約一覧」シートに研修枠を追加
   ↓
2. 「予約状況」列（H列）に「設定する」と入力
   ↓
3. editHandler() が onCreatingSchedule() を呼び出し
   ↓
4. Google Calendarにイベントを作成
   ↓
5. 「予約状況」を「設定済み」に更新
   ↓
6. 「イベントID」列（G列）にイベントIDを保存
```

### 2. 予約フロー

```
1. 受講者がGoogleフォームにアクセス
   ↓
2. STEP 1: 受講者情報を入力（氏名、所属グループ、備考）
   ↓
3. STEP 2: 所属グループに応じたページで研修枠を選択
   ↓
4. フォーム送信
   ↓
5. onFormSubmit() が実行される
   ↓
6. Google Calendarイベントにゲストとして追加
   ↓
7. 「参加情報」シートの該当コース列を「済み」に更新
```

### 3. フォーム自動再構築フロー

```
1. 時間ベーストリガー（毎時間）が autoRebuildFormOnSchedule() を実行
   ↓
2. 「予約一覧」シートから最新の研修枠を取得
   ↓
3. フォームを2ステップ構成で再構築
   ↓
4. グループ別にページ分けして研修枠を表示
```

### 4. 履修状況更新フロー

```
1. 管理者が refreshAttendeeStatus() を実行（手動またはトリガー）
   ↓
2. 「予約一覧」シートから全研修枠を取得
   ↓
3. Google Calendarから全イベントを取得
   ↓
4. イベントのゲストリストを確認
   ↓
5. 「参加情報」シートの履修状況を更新
   ↓
6. 「済み」/「未」のステータスを反映
```

### 5. リマインドフロー

```
1. 管理者が「ダッシュボード」シートの「アクション」列に「未予約者へリマインド」と入力
   ↓
2. editHandler() が onDashboardAction() を呼び出し
   ↓
3. refreshAttendeeStatus() で履修状況を最新化
   ↓
4. 対象グループ・コースの未予約者を抽出
   ↓
5. Slackにリマインドメッセージを送信
   ↓
6. 「最後のリマインド」列に実行日時を記録
   ↓
7. 「アクション」列をクリア
```

---

## 📝 Google フォーム構造

### フォーム設定

- **タイトル**: 継続研修 参加予約フォーム
- **説明**: このフォームでは継続研修の参加枠を予約します。メールアドレスは自動的に収集されます。
- **確認メッセージ**: 送信ありがとうございます。Google カレンダーの招待メールをご確認ください。
- **メール収集**: 有効
- **ログイン必須**: 有効（社内アカウントのみ）
- **1ユーザー1回答**: 有効

### STEP 1: 受講者情報の確認

| 項目 | タイプ | 必須 | 説明 |
|------|--------|------|------|
| 氏名 | テキスト | ✅ | 例）山田 太郎 |
| 所属グループを選択してください | 複数選択 | ✅ | 1期生/2期生/3期生（次のページへの分岐） |
| 備考（任意） | 段落テキスト | ❌ | 連絡事項があれば入力 |

### STEP 2: 参加希望日の選択

**グループ別にページ分け**:
- **1期生のページ**: 1期生向けの研修枠を表示
- **2期生のページ**: 2期生向けの研修枠を表示
- **3期生のページ**: 3期生向けの研修枠を表示

**各ページの設問**:
- **タイトル**: 「[グループ名] の研修枠を選択してください」
- **タイプ**: 複数選択
- **選択肢**: 「予約一覧」シートから動的に生成
  - 形式: `YYYY/MM/DD (E) HH:mm〜HH:mm [コース名]（[グループ]向け）\n場所: [場所]\n(id: [イベントID])`

---

## 🔧 Google Apps Script構造

### ファイル構成

#### 1. form.gs（フォーム側スクリプト）

**主な機能**:
- `rebuildTrainingForm()`: フォームを2ステップ構成で再生成
- `onFormSubmit(e)`: フォーム送信時の処理
  - 選択されたイベントに回答者をゲスト追加
  - 参加情報シートのステータスを更新
- `autoRebuildFormOnSchedule()`: 定期フォーム更新（時間ベーストリガー）
- `getScheduledCourses()`: 「予約一覧」シートから研修枠を取得

**依存関係**:
- `LMSUtils.gs`（共通ユーティリティ）を参照

#### 2. LMSUtils.gs（共通ユーティリティ）

**クラス**: `LMSUtils`

**主な機能**:
- `getConfig()`: 設定値の取得
- `getFormConfig()`: フォーム設定の取得
- `getCalendarId()`: カレンダーIDの取得
- `addGuestToCalendarEvent()`: カレンダーイベントにゲスト追加
- `extractIdFromQuestionString()`: フォーム回答からイベントIDを抽出
- `sendSlack()`: Slack通知送信

**設定値**:
- シート名: `参加情報`, `予約一覧`, `ダッシュボード`
- ステータス値: `済み`, `未`
- グループ: `['1期生', '2期生', '3期生']`

#### 3. sheet.gs（スプレッドシート側スクリプト）

**主な機能**:
- `handleReservationFormSubmit(e)`: フォーム送信時の処理（スプレッドシート側）
- `onCreatingSchedule(e)`: 「予約一覧」シート編集時の処理
  - 「予約状況」列に「設定する」と入力すると、カレンダーイベントを作成
- `refreshAttendeeStatus()`: 履修状況をカレンダーから更新
- `onDashboardAction(e)`: 「ダッシュボード」シート編集時の処理
  - 「アクション」列に「未予約者へリマインド」と入力すると、Slackリマインドを送信
- `editHandler(e)`: 編集トリガーの振り分け

**トリガー**:
- **フォーム送信トリガー**: `handleReservationFormSubmit()`
- **編集トリガー**: `editHandler()` → `onCreatingSchedule()` / `onDashboardAction()`
- **時間ベーストリガー**: `refreshAttendeeStatus()`（オプション）

---

## 🔗 外部連携

### Google Calendar連携

**機能**:
- 研修枠のカレンダーイベント作成
- 予約時にゲストとして追加
- 履修状況の同期

**イベント形式**:
- **タイトル**: `[グループ名] コース名`
- **開始時刻**: 予約一覧シートの「開始日時」
- **終了時刻**: 予約一覧シートの「完了日時」
- **説明**: コース案内

**イベントID管理**:
- イベント作成時に短いID（`@`より前の部分）を「予約一覧」シートの「イベントID」列に保存
- フォーム回答からイベントIDを抽出してゲスト追加

### Slack連携

**機能**:
- 未予約者へのリマインド通知

**メッセージ形式**:
```
[グループ名 / コース名] 以下の皆さんはこのコースが未予約です。LMSを確認して予約してください。
@username1
@username2
...

[サイトURL]
```

**設定**:
- Webhook URL: スクリプトプロパティ `SLACK_WEBHOOK_URL`
- チャンネル: スクリプトプロパティ `SLACK_CHANNEL`（デフォルト: `#bpi-solution-public`）
- チャンネルID（テスト用）: `C068DD0619D`
- チャンネルID（本番用）: スプレッドシートの「グループ一覧」シート参照（[リンク](https://docs.google.com/spreadsheets/d/1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE/edit?gid=1568150033#gid=1568150033)）
- ユーザー名: スクリプトプロパティ `SLACK_USERNAME`（デフォルト: `Googleセミナー・個別面談申込通知bot`）

**本番環境のSlack ID設定場所**:
- スプレッドシート: [アベンジャーズ_継続研修](https://docs.google.com/spreadsheets/d/1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE/edit?gid=1568150033#gid=1568150033)
- シート: 「グループ一覧」（gid=1568150033）
- 列: 「SlackチャンネルID」列
- 注意: チーム（グループ）ごとに異なるSlack IDが設定されている可能性があります

---

## ⚙️ 設定値（スクリプトプロパティ）

| プロパティ名 | 説明 | 必須 |
|------------|------|------|
| `SPREADSHEET_ID` | スプレッドシートID | ✅ |
| `SPREADSHEET_URL` | スプレッドシートURL（代替） | ❌ |
| `CALENDAR_ID` | Google Calendar ID | ✅ |
| `RESPONDENT_DOMAIN` | 回答者ドメイン（例: `@ga-tech.co.jp`） | ❌ |
| `SLACK_WEBHOOK_URL` | Slack Webhook URL | ❌ |
| `SLACK_CHANNEL` | Slackチャンネル（デフォルト: `#bpi-solution-public`） | ❌ |
| `SLACK_CHANNEL_ID` | SlackチャンネルID（テスト用: `C068DD0619D`、本番用: スプレッドシート参照） | ❌ |
| `SLACK_CHANNEL_ID_1期生` | 1期生用SlackチャンネルID（スプレッドシート参照） | ❌ |
| `SLACK_CHANNEL_ID_2期生` | 2期生用SlackチャンネルID（スプレッドシート参照） | ❌ |
| `SLACK_CHANNEL_ID_3期生` | 3期生用SlackチャンネルID（スプレッドシート参照） | ❌ |
| `SLACK_USERNAME` | Slack通知ユーザー名（デフォルト: `Googleセミナー・個別面談申込通知bot`） | ❌ |
| `SITE_URL` | LMSサイトURL | ❌ |

---

## 📈 データフロー図

### 研修枠作成から予約完了まで

```
管理者
  │
  ├─► [予約一覧シート] 研修枠追加
  │         │
  │         ├─► [予約状況] = "設定する"
  │         │         │
  │         │         ▼
  │         │   [sheet.gs] onCreatingSchedule()
  │         │         │
  │         │         ├─► Google Calendar イベント作成
  │         │         │         │
  │         │         │         └─► イベントID取得
  │         │         │
  │         │         └─► [予約状況] = "設定済み"
  │         │         └─► [イベントID] = eventId
  │         │
  │         ▼
  │   [form.gs] rebuildTrainingForm()
  │         │
  │         └─► Google フォーム再構築
  │                   │
  │                   └─► グループ別ページに研修枠を表示
  │
  ▼
受講者
  │
  ├─► Google フォームにアクセス
  │         │
  │         ├─► STEP 1: 受講者情報入力
  │         │         │
  │         │         └─► 所属グループ選択
  │         │
  │         ├─► STEP 2: 研修枠選択（グループ別ページ）
  │         │         │
  │         │         └─► 希望枠を選択
  │         │
  │         ▼
  │   フォーム送信
  │         │
  │         ├─► [form.gs] onFormSubmit()
  │         │         │
  │         │         ├─► Google Calendar イベントにゲスト追加
  │         │         │
  │         │         └─► [参加情報シート] ステータス更新
  │         │                   │
  │         │                   └─► [コース列] = "済み"
  │         │
  │         └─► [sheet.gs] handleReservationFormSubmit()
  │                   │
  │                   └─► カレンダーゲスト追加（二重チェック）
  │
  ▼
完了
```

---

## 🔍 主要な処理ロジック

### 1. 研修枠のグループ判定

```javascript
function isSessionAvailableForGroup(session, groupName) {
  // targetGroup が指定されている場合は一致するグループのみ表示
  if (session.targetGroup) {
    return session.targetGroup === groupName;
  }
  
  // targetGroup が空の場合はコースIDからグループを判定
  // FY26-XX-XX のXX部分を取得
  if (courseCode.startsWith('FY26-')) {
    const groupCode = courseCode.split('-')[1];
    switch (groupCode) {
      case '01': return groupName === '1期生';
      case '02': return groupName === '2期生';
      case '03': return groupName === '3期生';
    }
  }
  
  // それ以外の場合は全てのグループで表示
  return true;
}
```

### 2. イベントIDの抽出

```javascript
// フォーム回答からイベントIDを抽出
// 形式: "YYYY/MM/DD (E) HH:mm〜HH:mm [コース名]\n場所: [場所]\n(id: [イベントID])"
function extractIdFromQuestionString(string) {
  const regex = /\(id:\s*([^)]+)\)$/;
  const match = string.match(regex);
  return match && match[1] ? match[1] : "";
}
```

### 3. 履修状況の同期

```javascript
function refreshAttendeeStatus() {
  // 1. 予約一覧から全研修枠を取得
  // 2. Google Calendarから全イベントを取得
  // 3. イベントのゲストリストを確認
  // 4. 参加情報シートの履修状況を更新
  //    - ゲストに含まれている → "済み"
  //    - ゲストに含まれていない → "未"
}
```

---

## 📊 データ整合性

### データソースの優先順位

1. **Google Calendar**: 真実の源（実際の予約状況）
2. **参加情報シート**: Calendarから同期された履修状況
3. **予約一覧シート**: 研修枠の定義

### 同期タイミング

- **リアルタイム**: フォーム送信時（`onFormSubmit()`）
- **定期同期**: `refreshAttendeeStatus()` を手動実行
- **リマインド前**: `onDashboardAction()` 内で自動実行

---

## 🚨 制約事項・注意点

### 1. フォームの自動更新

- 時間ベーストリガーで毎時間フォームを再構築
- 「予約一覧」シートの変更がフォームに反映されるまで最大1時間

### 2. グループ判定

- コースID（`FY26-XX-XX`）の2番目の数字でグループを判定
- `TARGET_GROUP`列が空の場合は、コースIDから自動判定

### 3. イベントID管理

- イベントIDは短い形式（`@`より前の部分）を使用
- Google Calendar URLから抽出する場合は `eid=` パラメータをデコード

### 4. ステータス値

- `未`: 未予約
- `済み`: 予約済み（カレンダーにゲストとして追加済み）

### 5. エラーハンドリング

- カレンダーイベント作成失敗時: `予約状況` = `設定不可` または `日時問題`
- フォーム送信失敗時: ログに記録（エラーは表示されない）

---

## 🔗 関連ファイル

- **Google Driveフォルダ**: https://drive.google.com/drive/folders/1rpazwIC2lqTig9reMsG9Akgx-eOgHX-e
- **スプレッドシート**: https://docs.google.com/spreadsheets/d/1ln9GGhT7wbhhsWPIeATGkAnfAkXFvH8CfUeuZqmgqpE/edit
- **予約フォーム**: https://docs.google.com/forms/d/1zdRfVLnbtfh0dxNLk8Cz5ItYDPuEqjbukGYpfsg5WQo/edit
- **LMS Shared Utilities**: https://script.google.com/d/1tjRFSbY1AuGmhEsKEgcBSLMJzaMYORdnIRApv6VhYkKOIswtD_EN9DtQ/edit

---

## 📝 コードファイル

- `prototypes/form.gs` - フォーム側スクリプト
- `prototypes/LMSUtils.gs` - 共通ユーティリティ
- `prototypes/sheet.gs` - スプレッドシート側スクリプト

---

**作成者**: プロダクト企画チーム  
**最終更新**: 2025-11-14

