# 認証機能の整理 - 法務研修LMS

**プロジェクト**: 法務研修LMSシステム  
**作成日**: 2025-11-14  
**最終更新**: 2025-11-14  
**目的**: Google Workspace内のWebアプリにおける認証機能の整理

---

## ✅ 認証機能は既に実装済み

### Google Workspace内のWebアプリの特徴

Google Apps Scriptで作成したWebアプリケーションは、Google Workspace内で動作するため、**Googleアカウントでログインしているユーザーは自動的に認証されます**。

### 現状の実装

プロトタイプの`code.gs`では、以下のようにユーザー識別を実装しています：

```javascript
// doGet関数内
const user = Session.getActiveUser().getEmail();

// doPost関数内
const user = Session.getActiveUser().getEmail();
```

**`Session.getActiveUser().getEmail()`** により：
- ✅ 現在ログインしているユーザーのメールアドレスを取得可能
- ✅ 社内アカウント（`@ga-tech.co.jp`）のみがアクセス可能（Google Workspace設定）
- ✅ 追加のOAuth 2.0実装は不要

### 既存システム（Google フォーム）の設定

現状システムのGoogle フォームでは：
- **ログイン必須**: 有効
- **1ユーザー1回答**: 有効
- **メール収集**: 自動的に収集

これにより、社内アカウントのみがアクセス可能で、ユーザー識別も自動的に行われています。

---

## 🔧 必要な実装：管理者権限判定

### 実装が必要な機能

認証機能自体は不要ですが、**管理者権限の判定**は必要です。

#### 1. 管理者権限判定関数

```javascript
/**
 * 管理者権限を判定
 * @param {string} email - ユーザーのメールアドレス
 * @return {boolean} 管理者の場合true
 */
function isAdmin(email) {
  // 方法1: スクリプトプロパティで管理者リストを管理
  const adminEmails = PropertiesService.getScriptProperties()
    .getProperty('ADMIN_EMAILS')
    .split(',');
  return adminEmails.includes(email);
  
  // 方法2: スプレッドシートの管理者リストから判定
  // const sheet = getSheet('config');
  // const admins = sheet.getRange('A2:A').getValues().flat();
  // return admins.includes(email);
  
  // 方法3: Google Groupsのメンバーシップで判定
  // const groupEmail = 'lms-admins@ga-tech.co.jp';
  // return AdminDirectory.Groups.get(groupEmail).members.includes(email);
}
```

#### 2. 管理者専用ページのアクセス制御

```javascript
/**
 * 管理者ページのレンダリング（アクセス制御付き）
 */
function renderAdminPage(user) {
  // 管理者権限チェック
  if (!isAdmin(user)) {
    return renderErrorPage('管理者権限が必要です');
  }
  
  // 管理者ページをレンダリング
  return HtmlService.createTemplateFromFile('admin')
    .evaluate()
    .setTitle('管理者ダッシュボード')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```

#### 3. 管理者リストの設定方法

**方法1: スクリプトプロパティで管理（推奨）**

```javascript
// スクリプトプロパティに設定
// ADMIN_EMAILS = "admin1@ga-tech.co.jp,admin2@ga-tech.co.jp"
```

**方法2: スプレッドシートのconfigシートで管理**

```
configシート
A列: 管理者メールアドレス
admin1@ga-tech.co.jp
admin2@ga-tech.co.jp
```

**方法3: Google Groupsで管理（推奨）**

- Google Groupsに `lms-admins@ga-tech.co.jp` を作成
- 管理者をグループに追加
- Admin Directory APIでメンバーシップを確認

---

## 📋 実装チェックリスト

### ✅ 既に実装済み
- [x] ユーザー識別（`Session.getActiveUser().getEmail()`）
- [x] 社内アカウントのみアクセス可能（Google Workspace設定）

### ⚠️ 実装が必要
- [ ] 管理者権限判定関数（`isAdmin()`）
- [ ] 管理者リストの設定（スクリプトプロパティまたはスプレッドシート）
- [ ] 管理者専用ページのアクセス制御
- [ ] エラーメッセージの表示（権限不足時）

---

## 🔍 既存システムとの比較

### 既存システム（Google フォーム）
- ✅ ログイン必須設定で自動認証
- ✅ メールアドレス自動収集
- ⚠️ 管理者権限の判定は不要（管理者のみがフォームを編集可能）

### プロトタイプ（Webアプリ）
- ✅ `Session.getActiveUser()`で自動認証
- ✅ ユーザー識別可能
- ⚠️ 管理者権限判定が必要（管理者ページへのアクセス制御）

---

## 🎯 次のアクション

1. **管理者権限判定関数の実装**
   - `isAdmin()`関数を作成
   - 管理者リストの設定方法を決定（スクリプトプロパティ推奨）

2. **管理者専用ページのアクセス制御**
   - `renderAdminPage()`に権限チェックを追加
   - 権限不足時のエラーページ表示

3. **受講者情報の取得**
   - `Session.getActiveUser().getEmail()`で取得したメールアドレスから受講者情報を取得
   - 参加情報シートとの紐付け

---

## 📚 参考資料

- [Google Apps Script - Session.getActiveUser()](https://developers.google.com/apps-script/reference/base/session#getactiveuser)
- [Google Workspace - アクセス制御](https://support.google.com/a/answer/172177)
- [Google Groups API](https://developers.google.com/admin-sdk/directory/v1/guides/manage-groups)

---

**作成者**: プロダクト企画チーム  
**最終更新**: 2025-11-14

