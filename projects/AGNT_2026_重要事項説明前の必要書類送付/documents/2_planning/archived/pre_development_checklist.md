# 開発着手前確認事項チェックリスト

## プロジェクト情報
- **プロジェクト名**: AGNT 2026 重要事項説明前の必要書類送付
- **作成日**: 2025-11-21
- **目的**: 開発着手前に確認すべき事項を整理

## 重要な前提条件

**オペレーション変更で耐えようとすると負荷が高い**

### 処理件数の増加
- **FY25**: 月間583件
- **FY28**: 月間1,050件（約1.8倍に増加予定）
- サブリース比率が下がっても処理件数は変わらないため、業務負荷は継続的に増加する見込み

### 業務プロセス確認資料（2025/10/09）の懸念事項
- 「業務が回らなくなる」「やるがQCDに問題あり」という懸念が指摘されている
- 「1件あたりどれくらい工数かかるか？は明らかにしておきたい。必要に応じてリソース確保や業務効率化が必要。」
- 「カツカツの状態で今回を凌ぐのは危険だと思う」

### 運用プロセスを変更して対応しようとすると、以下の理由により運用負荷が高くなりすぎる：
- 契約ごとに手動でメール送信が必要（月間1,050件以上）
- 送付漏れのリスクが高い（人的ミスの可能性）
- エラー時の対応が非効率（個別対応が必要）
- 書類改変時の再送付が手動対応になる（都度対応が必要）
- 監査証跡の管理が困難（手動記録が必要）

そのため、**システム的な自動化が必須**である。

## 📋 確認事項

### 1. 要件・仕様確認

#### 1.1 SUP連携タイミング
- [ ] SUPからAGNTへの契約書情報連携のタイミングを確認
- [ ] 契約書類準備完了（contract_preparation）の状態遷移タイミングを確認
- [ ] **確認先**: Supply Chain事業部Process Managementチーム、**SUPPLIER開発チーム**
- [ ] **確認方法**: 会議・メール・ドキュメント確認
- [ ] **確認期限**: 開発着手前（11/26まで推奨）
- [ ] **重要**: SUPPLIER開発チームへの展開が必要（SUP側の変更も必要）

#### 1.1.1 SUPPLIER開発チームへの展開確認
- [ ] SUPPLIER側で必要な変更内容を確認
- [ ] SUPからAGNTへの契約書情報連携APIの仕様確認
- [ ] contract_preparation状態の設定タイミング確認
- [ ] SUPPLIER側の開発スケジュール確認
- [ ] **確認先**: SUPPLIER開発チーム
- [ ] **確認方法**: 会議・メール・ドキュメント確認
- [ ] **確認期限**: 開発着手前（11/26まで推奨）
- [ ] **詳細**: [SUPPLIER開発チームへの展開要件](./supplier_development_requirements.md) を参照

#### 1.2 RENOSYアカウントメール取得
- [ ] 契約に紐づく案件（opportunity）からRENOSYアカウントのメールアドレスを取得する方法を確認
- [ ] メールアドレスが存在しない場合の処理方法を確認
- [ ] **確認先**: AGNT開発チーム
- [ ] **確認方法**: コードレビュー・ドキュメント確認
- [ ] **確認期限**: 開発着手前（11/26まで推奨）

#### 1.4 サブリース契約書の送付タイミング
- [x] **送付タイミング**: 契約書連携時（重要事項説明書と同じタイミング）で確定（2025-11-12会議で決定）
- [ ] **送付内容の確認**: 
  - サブリース契約書（サブリースの場合）
  - 売買契約書の重要事項説明書
  - 賃貸借契約書の重要事項説明書
  - 賃貸管理契約の重要事項説明書
- [ ] **例外ケースの処理**: サブリース契約書が先に連携された場合の処理方法を確認
- [ ] **SUPPLIER開発チーム**: サブリース契約書のシステム対応を調整（12月頃）
- [ ] **確認先**: SUPPLIER開発チーム、Supply Chain事業部Process Managementチーム
- [ ] **確認方法**: 会議・メール・ドキュメント確認
- [ ] **確認期限**: 開発着手前（11/26まで推奨）
- [ ] **参考**: [meeting_minutes_2025-11-12_docusign_contract_change.md](../2_research/meetings/meeting_minutes_2025-11-12_docusign_contract_change.md)

#### 1.3 サブリース契約書判定・格納場所
- [ ] 特定賃貸借物件の判定ロジックを確認
- [ ] コントラクトチーム格納ファイルの判定方法を確認
- [ ] **確認先**: Acquisition事業部Contractチーム
- [ ] **確認方法**: 会議・メール・ドキュメント確認
- [ ] **確認期限**: 開発着手前（11/26まで推奨）

#### 1.3.1 サブリース契約書の格納場所（送信専用の箱）
- [x] **送信専用の箱の新設**: 確定（2025-11-04会議で決定）
- [ ] **SUPPLIER内部での対応確認**: 新規で箱を作るのか、既存の箱を利用するのかを相談して決定
- [ ] **既存ファイルの整理タイミング**: Acquisition事業部Contractチームと整理タイミングを検討
- [ ] **サブリース判定ロジックの実装方法**: 物件情報ベース or ファイル存在ベースの決定
- [ ] **送信専用の箱からファイルを取得する実装**: 開発チームで実装を追加
- [ ] **確認先**: Acquisition事業部Contractチーム、SUPPLIER開発チーム
- [ ] **確認方法**: 会議・メール・ドキュメント確認
- [ ] **確認期限**: 開発着手前（11/26まで推奨）
- [ ] **参考**: [meeting_minutes_2025-11-04_sublease_contract_storage.md](../2_research/meetings/meeting_minutes_2025-11-04_sublease_contract_storage.md)

### 2. DocuSign仕様確認

#### 2.1 DocuSignマニュアル確認
- [x] DocuSign eSignature管理者ガイドを確認
  - 保存場所: `documents/2_research/DocuSign eSignature管理者ガイド.pdf`
  - 確認箇所: 法定開示（151-156ページ）、文書表示条件（36-38ページ）
  - **文字起こし**: [docusign_admin_guide_excerpt.md](../2_research/docusign_admin_guide_excerpt.md)
- [x] DocuSign eSignatureユーザーガイドを確認
  - 保存場所: `documents/2_research/DocuSign eSignatureユーザーガイド.pdf`
  - 確認箇所: 文書の表示条件（36-38ページ）
  - **文字起こし**: [docusign_user_guide_excerpt.md](../2_research/docusign_user_guide_excerpt.md)

#### 2.2 DocuSign API仕様確認
- [ ] Composite TemplatesのAPI仕様を確認
- [ ] Pre-delivery機能のAPI仕様を確認
- [ ] エラーハンドリングのベストプラクティスを確認
- [ ] **確認先**: DocuSign APIドキュメント、開発チーム
- [ ] **確認期限**: 設計フェーズ開始前

#### 2.3 DocuSignテンプレート作成準備
- [x] **DocuSignテンプレート作成作業手順書の確認**（2025-11-21完了）
  - 保存場所: `documents/3_planning/docusign_template_creation_guide.md`
  - 作業手順の理解 ✅
  - 必要な設定項目の確認 ✅
  - 送信内容の明確化（売買・管理委託・サブリースの3種類） ✅
  - Pre-delivery機能とワークフローの設定手順の確認 ✅
- [x] **参照資料の存在確認**（2025-11-21完了）
  - 改正宅建業法のポイント.pdf ✅
  - DocuSign eSignature管理者ガイド.pdf ✅
  - DocuSign eSignatureユーザーガイド.pdf ✅
  - 管理者ガイド・ユーザーガイドの抜粋 ✅
- [ ] **改正宅建業法のポイント.pdfの内容確認**
  - 保存場所: `documents/2_research/改正宅建業法のポイント.pdf`
  - 重要事項説明書の必須記載事項を確認
  - サブリース契約書に関する記載事項を確認
  - テンプレートに含めるべき項目の抽出
- [ ] **DocuSign管理画面へのアクセス確認**
  - エンタープライズプランへの切り替え完了確認（12/1まで）
  - 管理画面へのログイン確認
  - **［送信設定］で「文書の表示条件」オプションの有効化確認**（35条書面と37条書面を別々のタイミングで提供するために必要）
  - **［法定開示］で「電子記録および電子署名の開示についての同意を署名者に求める」を選択**（電磁的提供についての"承諾"の取得のために必要）
- [ ] **確認期限**: テンプレート作成開始前（12/1まで）

#### 2.4 DocuSign契約変更・予算確認
- [x] **予算承認前提で進める**: やる前提で承認を取りに行く（2025-11-12会議で決定）
- [ ] **正式見積もりの取得**: 2025-11-21までに取得
- [ ] **技術サポートの打ち合わせ**: 2025-11-13に実施（10時間 or 20時間チケットを検討）
- [ ] **契約開始タイミングの確認**: 1月中旬 or 2月1日以降の確認
- [ ] **プラン変更による既存契約書の扱い**: エクスポート可能だが、タイムスタンプの有効期限の問題を確認
- [ ] **確認先**: DocuSign営業担当、社内予算承認者
- [ ] **確認方法**: 会議・メール・ドキュメント確認
- [ ] **確認期限**: 開発着手前（12/1まで推奨）
- [ ] **参考**: [meeting_minutes_2025-11-12_docusign_contract_change.md](../2_research/meetings/meeting_minutes_2025-11-12_docusign_contract_change.md)

### 3. 技術調査

#### 3.1 既存コード分析
- [x] `repositories/backend/verdandi/lib/document_sign/envelope.rb` の分析完了
- [x] `repositories/backend/verdandi/app/models/contract.rb` の分析完了
- [ ] DocumentSignFileクラスの詳細分析
- [ ] 既存テストファイルの確認
- [ ] **確認期限**: 設計フェーズ開始前

#### 3.2 依存関係確認
- [ ] DocuSign APIクライアントのバージョン確認
- [ ] Rollbar連携の実装方法確認
- [ ] 通知機能の実装方法確認
- [ ] **確認期限**: 設計フェーズ開始前

### 4. 環境・設定確認

#### 4.1 開発環境
- [ ] verdandi開発環境のセットアップ確認
- [ ] DocuSignテスト環境へのアクセス確認
- [ ] テスト用アカウントの準備
- [ ] **確認期限**: 実装フェーズ開始前

#### 4.2 設定ファイル
- [ ] DocuSign設定ファイルの確認
- [ ] 環境変数の確認
- [ ] ブランド設定の確認
- [ ] **確認期限**: 実装フェーズ開始前

### 5. プロジェクト体制確認

#### 5.1 チーム体制
- [x] プロジェクトマネージャー: 佐藤達也
- [x] 開発PM: 赤間滉一
- [x] サーバ開発: 小松亮汰
- [x] QA担当: 野原慎弥、原萌葵、松村拓人
- [x] セキュリティ担当: 時任達也、山田拓人

#### 5.2 コミュニケーション体制
- [ ] 定例会議のスケジュール確認
- [ ] 進捗報告の方法確認
- [ ] エスカレーションルール確認
- [ ] **確認期限**: プロジェクト開始時

### 6. セキュリティ・プライバシー対策

#### 6.1 文書の整合性確保
- [ ] **DocuSign連携前チェックの実装方針確認**
  - ファイルハッシュ値の比較などの検証方法を確認
  - DocuSign APIに連携する前の最終的な文書ファイル群に対して、改変が行われていないこと、および正しいバージョンのファイルが使用されていることを検証する自動化されたチェックを実装
  - **現状**: 未実装（`DocumentSignFile.hashes_for_envelope(contract)`でファイルを取得しているが、ハッシュ値の比較や整合性チェックはなし）
  - **確認先**: AGNT開発チーム
  - **確認期限**: 設計フェーズ開始前
- [ ] **サブリース契約書格納場所の管理**
  - 送付対象となるファイルの明確な識別ロジック（格納日時、ステータスフラグなど）を厳格に定義・実装
  - **現状**: 未実装（サブリース関連のファイル処理はあるが、格納場所の管理やファイル識別ロジックはなし。`contract.docusign_file_url`でURLを取得しているが、ファイルの識別ロジックは不明）
  - **確認先**: AGNT開発チーム、SUPPLIER開発チーム
  - **確認期限**: 設計フェーズ開始前

#### 6.2 誤送信防止
- [ ] **送信前最終確認の実装方針確認**
  - DocuSignへの送信処理を開始する直前に、対象の契約案件とRENOSYアカウントに紐づく顧客氏名をログに出力し、想定される受信者名と照合する二重チェックの仕組みを実装
  - **現状**: 未実装（`DocumentSign::Envelope#send`メソッドに送信前のログ出力なし）
  - **確認先**: AGNT開発チーム
  - **確認期限**: 設計フェーズ開始前
- [ ] **メールテンプレートの注意喚起追加**
  - メール本文テンプレートに誤送信時の注意書きを追加（「このメールに心当たりのない場合は、開封せずに破棄してください」）
  - **現状**: 未実装（既存の`email_blurb`には注意書きなし）
  - **確認先**: AGNT開発チーム
  - **確認期限**: 実装フェーズ開始前

#### 6.3 プライバシー保護
- [ ] **顧客IDの非連携化の実装方針確認**
  - DocuSignへの連携時に、顧客IDそのものではなく、DocuSignで完結する一時的なユニークな識別子（外部サービスごとに異なるUUID）を生成してDocuSignの受信者情報として使用
  - 社内システムとDocuSignの連携は、UUIDと社内顧客IDのマッピングテーブルを介して行うことで、社内ガイドラインを遵守
  - **現状**: 未実装（`clientUserId: envelope.contract.customer_id`で顧客IDを直接連携している。UUID生成やマッピングテーブルはなし）
  - **確認先**: AGNT開発チーム、セキュリティ担当
  - **確認期限**: 設計フェーズ開始前

#### 6.4 エラーハンドリングと情報保護
- [ ] **自動リトライ処理の実装方針確認**
  - DocuSign APIの利用量制限などの一時的なエラーに対して、指数バックオフを用いた自動リトライ処理を実装
  - **現状**: 未実装（`DocumentSign::Envelope#send`メソッドはエラー時に`nil`を返すのみ、リトライ処理なし）
  - **確認先**: AGNT開発チーム
  - **確認期限**: 設計フェーズ開始前
- [ ] **Rollbar情報制限の実装方針確認**
  - Rollbarなどのエラー監視ツールに送信するログから、顧客のメールアドレス、氏名、契約内容などの個人情報や機微情報を匿名化または除去する処理を実装
  - **現状**: Rollbarの設定で`scrub_fields = :scrub_all`が設定されているが、`e.response_body`に含まれる個人情報（メールアドレス、氏名など）はスクラブされない可能性がある
  - **確認先**: AGNT開発チーム、セキュリティ担当
  - **確認期限**: 設計フェーズ開始前
- [ ] **自動通知とエスカレーションの実装方針確認**
  - メールバウンスなどの対応が必要なエラーについては、担当営業への連携をSlackなどのプライベートチャンネルへ自動通知する仕組みを構築
  - **現状**: 未実装（`Notifier.ping_warning(e)`でRollbarに通知しているが、Slackへの自動通知はなし。`contract.rb`には`SlackApp.ping_message`の使用例があるが、DocuSignエラー時の自動通知はなし）
  - **確認先**: AGNT開発チーム
  - **確認期限**: 設計フェーズ開始前

#### 6.5 監査証跡の充実
- [ ] **ダウンロードタイムスタンプの取得の実装方針確認**
  - 顧客によるダウンロードのタイムスタンプやDocuSign上の操作ログをシステム側で確実に取得・保管
  - **現状**: 未実装（`get_envelope`や`get_document`でエンベロープやドキュメントを取得できるが、ダウンロードタイムスタンプの取得処理はなし）
  - **実現可能性**: DocuSign APIのログ取得機能に依存
  - **確認先**: AGNT開発チーム
  - **確認期限**: 設計フェーズ開始前

### 7. リスク管理

#### 7.1 高リスク項目
- [ ] SUP連携タイミングの遅延リスク対策
- [ ] RENOSYアカウントメール取得の不確実性対策
- [ ] サブリース判定ロジックの複雑さ対策
- [ ] **確認期限**: 設計フェーズ開始前

#### 7.2 品質管理
- [ ] コードレビュープロセスの確認
- [ ] テストカバレッジ目標の確認（80%以上）
- [ ] エラーハンドリング方針の確認
- [ ] **確認期限**: 実装フェーズ開始前

### 8. 追加機能要件（議事録より）

#### 8.1 送付日時の記録機能
- [ ] 契約書連携で何日に送ったかを記録する機能を追加
- [ ] マイページで送付日時を確認できる機能を追加
- [ ] **確認先**: AGNT開発チーム
- [ ] **確認方法**: 要件定義・設計レビュー
- [ ] **確認期限**: 設計フェーズ開始前
- [ ] **参考**: [meeting_minutes_2025-11-12_docusign_contract_change.md](../2_research/meetings/meeting_minutes_2025-11-12_docusign_contract_change.md)

#### 8.2 マイページでの事前送付書類確認機能
- [ ] 事前送付された書類をマイページで確認できる機能を追加
- [ ] そのまま契約画面に進める機能を追加
- [ ] **確認先**: AGNT開発チーム
- [ ] **確認方法**: 要件定義・設計レビュー
- [ ] **確認期限**: 設計フェーズ開始前
- [ ] **参考**: [meeting_minutes_2025-11-12_docusign_contract_change.md](../2_research/meetings/meeting_minutes_2025-11-12_docusign_contract_change.md)

## 📅 スケジュール

### 確認期限
- **11/26（水）まで**: SUP連携、RENOSYアカウント、サブリース判定の確認
- **12/1（月）まで**: DocuSign API仕様、技術調査の完了
- **開発着手前**: 環境・設定、プロジェクト体制の確認

## 📝 確認結果記録

### 確認済み事項
- [x] DocuSignマニュアルの保存場所確認
- [x] プロジェクト構造の整備
- [x] WBSの作成
- [x] 関連ファイル一覧の作成

### 確認待ち事項
- [ ] SUP連携タイミングの確認（**SUPPLIER開発チーム含む**）
- [ ] SUPPLIER開発チームへの展開内容確認
- [ ] RENOSYアカウントメール取得方法の確認
- [ ] サブリース判定ロジックの確認
- [ ] サブリース契約書の格納場所（送信専用の箱）の確認
- [ ] SUPPLIER内部での対応（新規で箱を作るのか）の相談
- [ ] DocuSign API仕様の確認
- [ ] DocuSign契約変更・予算確認（正式見積もり取得、技術サポート打ち合わせ）
- [ ] 送付日時の記録機能の要件確認
- [ ] マイページでの事前送付書類確認機能の要件確認

## 🎯 次のアクション

### 即座に実行
1. **SUP連携タイミングの確認依頼**
   - Supply Chain事業部Process Managementチームに連絡
   - **SUPPLIER開発チームに連絡**（**重要**: SUP側の変更も必要）
   - 契約書類準備完了の状態遷移タイミングを確認
   - SUPPLIER側で必要な変更内容を確認

2. **RENOSYアカウントメール取得方法の確認依頼**
   - AGNT開発チームに連絡
   - Opportunityモデルからメールアドレス取得方法を確認

3. **サブリース判定ロジックの確認依頼**
   - Acquisition事業部Contractチームに連絡
   - 特定賃貸借物件の判定方法を確認

### 開発着手前
1. **DocuSign API仕様の確認**
   - Composite Templatesの詳細仕様確認
   - Pre-delivery機能のAPI仕様確認

2. **技術調査の完了**
   - DocumentSignFileクラスの詳細分析
   - 既存テストファイルの確認

3. **環境・設定の確認**
   - 開発環境のセットアップ
   - DocuSignテスト環境へのアクセス確認

4. **セキュリティ・プライバシー対策の実装方針確認**
   - [ ] DocuSign連携前チェックの実装方針確認
   - [ ] 送信前最終確認の実装方針確認
   - [ ] 顧客IDの非連携化の実装方針確認
   - [ ] 自動リトライ処理の実装方針確認
   - [ ] Rollbar情報制限の実装方針確認
   - [ ] 自動通知とエスカレーションの実装方針確認

---
*作成日: 2025-11-21*
*作成者: t_sato2@ga-tech.co.jp*
*最終更新: 2025-11-21（project_overview.mdの最新内容反映、セキュリティ・プライバシー対策追加）*
