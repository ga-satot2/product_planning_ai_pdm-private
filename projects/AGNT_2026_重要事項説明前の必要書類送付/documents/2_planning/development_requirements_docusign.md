# DocuSign改修部分の開発要件定義書

**プロジェクト名**: AGNT 2026 重要事項説明前の必要書類送付  
**ドキュメント種別**: 開発要件定義書  
**対象機能**: DocuSign改修部分  
**作成者**: 小松亮汰  
**作成日**: 2025-12-11  
**最終更新**: 2025-12-11  
**バージョン**: v1.0

---

## 概要

重要事項説明書を重要事項説明の実施前に顧客へ事前交付するため、DocuSignのPre-delivery機能を使用してメール送信を行う。

追加要件については[追加要件定義書](./additional_requirements_2025-12-18.md)を参照してください。

---

## ドキュサイン連携部分

| 機能 | トリガー | 技術的内容・補足 |
| :--- | :--- | :--- |
| **事前送付 (重説のみ)** | SUPでの契約準備完了 | ・この段階ですべてのドキュメントを設定してドキュサインに連携する。<br>・ワークフロー機能によって本送付を一時停止した状態にする。 |
| **本送付 (重説以外すべて)** | AGNT契約詳細から<br>「マイページ契約」押下 | ・一時停止したワークフローを停止解除することで契約書などが送信される。 |
| **顧客が重説を閲覧していないと契約ボタンを押せないようにする** | 契約詳細ページを開いた時 | ・このAPIを使ってRecipientsのステータスを確認する。<br>`listRecipients REST API`<br>・`completed` じゃなければNGにする処理を追加。 |
| **重説の署名印字を削除する** | SUPでの契約準備完了 → ドキュサインへ連携している処理の中で行なっている | ・AGNT側で座標指定で印字を行なっており、該当コードを削除する。 |

---

## 仕様調査

### 現状のDocuSign実装

* 既存の`DocumentSign::Envelope`クラスでDocuSignエンベロープを作成している
* 署名欄ありのテンプレートを使用して、顧客にサインを依頼している
* `Contract`モデルで契約状態を管理している

### DocuSign Pre-delivery機能

* Pre-delivery機能により、署名欄なしで文書を送信可能
* 「文書の表示条件」オプションの有効化が必要
* 「電子記録および電子署名の開示についての同意を署名者に求める」の選択が必要
* Composite Templatesを使用して複数のテンプレートを1つのエンベロープに組み合わせ可能

---

## 実装方針

### DocuSign連携の実装

* SUPでの契約準備完了時に、すべてのドキュメントを設定してDocuSignに連携
* ワークフロー機能によって本送付を一時停止した状態にする
* 署名欄なしのテンプレートを使用（Pre-delivery機能）
* 「マイページ契約」ボタン押下時に、一時停止したワークフローを停止解除して送信

### Contractモデル拡張

* **重要**: `contract_preparation`状態遷移時に**自動送信は行わない**
  * SUPでの契約準備完了時にDocuSignに連携するが、**自動送信ではなく、ワークフローを一時停止した状態にする**
  * 実際の送信は「マイページ契約」ボタン押下時にワークフローを解除して行う方式です
  * 追加要件により「事前交付ボタン」を追加し、重説担当者が手動で押下して送信する方式に変更（詳細は[追加要件定義書](./additional_requirements_2025-12-18.md)を参照）
* RENOSYアカウントのメールアドレス取得メソッドを追加

### 送信対象書類

* 売買契約書の重要事項説明書
* 賃貸管理委託契約書の重要事項説明書（プランごと）

### 送信対象外の書類

現状DocuSignで表示しているが、今回のPJでは事前送付しない書類：

* 売買契約書
* 賃貸管理委託契約書
* クーリングオフ制度の説明
* 個人情報の取り扱いに関する説明
* 領収書

---

## 実装詳細

### DocuSign連携の実装

* SUPでの契約準備完了時に、すべてのドキュメントを設定してDocuSignに連携
* ワークフロー機能によって本送付を一時停止した状態にする
* エンベロープ定義の作成（ワークフロー一時停止状態）
* 受信者の設定（「確認」役割で設定）
* Composite Templatesの構築（売買重説と管理重説を1つのエンベロープに組み合わせ）
* 「マイページ契約」ボタン押下時に、一時停止したワークフローを停止解除して送信

### Contractモデル拡張

* **重要**: `after_update`コールバックで`contract_preparation`状態遷移時に**自動送信は行わない**
  * ワークフローを一時停止した状態にするのみ
  * 実際の送信は「事前交付ボタン」押下時または「マイページ契約」ボタン押下時に実行
* `renosy_account_email`メソッド: RENOSYアカウントのメールアドレス取得

### DocuSign API仕様

* **エンベロープ定義**: `status: 'sent'`で送信
* **受信者設定**: 署名者ではなく「確認」役割で設定
* **テンプレート使用**: 署名欄なしのテンプレートを使用
* **Composite Templates**: 売買重説と管理重説を1つのエンベロープに組み合わせ

---

## エラーハンドリング

### エラー発生時の処理

* Rollbar連携: エラー発生時にRollbarにログ記録
* 担当営業への通知: エラー発生時に担当営業へ通知
* リトライ処理: 一時的なエラーの場合はリトライ処理を実施

### エラーパターン

* DocuSign APIエラー
* メールアドレス不存在エラー
* テンプレート不存在エラー
* ネットワークエラー

---

## リスク管理

### 高リスク

* DocuSign APIの制約による送信失敗
* テンプレート設定の誤りによる送信失敗

### 中リスク

* RENOSYアカウントのメールアドレス不存在
* ネットワークエラーによる送信失敗

---

## テスト要件

### 単体テスト

* Contractモデルテスト: コールバックトリガーテスト、メール取得メソッドテスト
* DocuSign連携テスト: 署名欄除外の確認、ワークフロー一時停止・解除処理テスト、エッジケーステスト

### 統合テスト

* SUPPLIER連携テスト: 契約書連携時の動作確認
* DocuSign連携テスト: Pre-delivery機能の動作確認

### QAテスト

* 機能テスト: 既存の契約締結前ユーザに対して、変更時にメール送信される
* リグレッションテスト: 反響〜契約〜決済
* 探索的テスト: 想定外のタイミングでの送信がないか等

---

## 運用要件

### 監視要件

* 送信履歴の記録: 送信日時、送信先、送信内容を記録
* エラー監視: Rollbar連携によるエラー監視

### 運用プロセス

* エラー発生時: 担当営業への通知、ログ確認
* 再送付: 電子証明書変更時の再送付処理

---

## 制約条件

### DocuSign契約要件

* プラン: Enterprise Pro エディション
* 契約期間: 2025/12/1 - 2027/11/30（2年間）
* エンベロープ数: 8,000通/年（合計16,000通）

### テンプレート作成要件

**注意**: テンプレート作成は開発作業とは別の作業として実施されます。開発者は、テンプレート作成担当者と連携し、作成されたテンプレートIDを実装に反映してください。

* 自社作成: DocuSign側では供与機能がないため、自社で作成が必要
* 設定要件: 「文書の表示条件」オプションの有効化、「電子記録および電子署名の開示についての同意を署名者に求める」の選択

### その他の制約

* リリース以前の契約: リリース以前に契約締結された書類については、改めて交付しない
* マイページ制約: マイページの制約を取っ払う（個人認証のタイミングを変更する）よりも、DocuSignによる直接メール送信という別ルートで対応

---

## 参考資料

* [プロジェクト概要書](https://ga-tech.atlassian.net/wiki/spaces/AGNT/pages/5102862362/AGNT+2026)
* [プロジェクト憲章](https://ga-tech.atlassian.net/wiki/spaces/AGNT/pages/5123407918)
* [ソリューション定義書](https://ga-tech.atlassian.net/wiki/spaces/AGNT/pages/5228036152)
* AGNT-AGNT 2026 重要事項説明前の必要書類送付 要件定義-111225-031756.pdf
