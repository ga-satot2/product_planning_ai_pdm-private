# サブリース物件向け販売促進機能 影響範囲分析

**作成日**: 2026-01-29  
**作成者**: AI Assistant  
**バージョン**: v1.0

---

## 概要

AGNTでサブリース物件に対して販売促進を行うための機能を実現する際に、変更が必要な機能とその影響範囲を分析したドキュメントです。

---

## 1. 現状のサブリース物件関連機能

### 1.1 サブリース物件の判定方法

**AGNT（verdandi）システム**:
- **モデル**: `Article` (`repositories/backend/verdandi/app/models/article.rb`)
- **判定メソッド**: `supplier_sublease?` (line 345)
- **データソース**: SUPPLIERシステムから取得した`is_sublease`フラグ

**データベース構造**:
- `articles`テーブルに以下のカラムが存在:
  - `sublease_contract_months` (integer): サブリース標準契約期間
  - `sublease_contract_price` (integer): サブリース標準家賃
  - `supplier_article_id` (integer): SUPPLIERシステムとの連携キー

### 1.2 既存のサブリース物件関連機能

1. **サブリース契約書の自動送信機能**
   - **実装箇所**: `Contracts::SubleaseContractEmailSender` (`repositories/backend/verdandi/app/models/contracts/sublease_contract_email_sender.rb`)
   - **トリガー**: 契約承認時 (`Entry::ApproveService`)
   - **機能**: サブリース物件の契約承認時に、顧客にサブリース契約書を自動送信

2. **サブリース物件の通知機能**
   - **実装箇所**: Google Apps Script (`development/gas_automation_sublease/notify_sublease_application.gs`)
   - **機能**: サブリース物件の申込があった場合、Slack通知を送信

3. **物件表示ロジック**
   - **実装箇所**: `Articles::Renderer` (`repositories/backend/verdandi/app/models/articles/renderer.rb`)
   - **機能**: サブリース物件の表示制御

---

## 2. 変更が必要な機能領域

### 2.1 INSIGHT（物件提案システム）側

**対象システム**: `agnt_rda` (INSIGHT Backend)

#### 2.1.1 物件検索・フィルタリング機能

**変更内容**:
- サブリース物件を条件として検索・フィルタリングできる機能を追加
- サブリース物件のみを表示するフィルタオプションの追加

**影響範囲**:
- **API**: 物件検索API
- **フロントエンド**: 物件一覧画面、検索フォーム
- **データベース**: 検索クエリに`is_sublease`条件を追加

**実装イメージ**:
```ruby
# 検索条件にサブリース物件フィルタを追加
if params[:sublease_only].present?
  articles = articles.where(is_sublease: true)
end
```

#### 2.1.2 物件表示・強調表示機能

**変更内容**:
- サブリース物件を視覚的に強調表示（バッジ、アイコンなど）
- サブリース物件のメリット・デメリットを表示

**影響範囲**:
- **フロントエンド**: 物件カード、物件詳細画面
- **API**: 物件詳細API（サブリース情報を含める）

#### 2.1.3 キャンペーン連携機能

**変更内容**:
- サブリース物件を対象としたキャンペーン設定機能
- サブリース物件に特典・割引を適用する機能

**影響範囲**:
- **データベース**: キャンペーンマスターテーブルにサブリース物件条件を追加
- **API**: キャンペーン適用ロジック
- **フロントエンド**: キャンペーン表示、特典表示

---

### 2.2 AGNT（verdandi）側

**対象システム**: `verdandi` (AGNT Backend)

#### 2.2.1 物件管理機能

**変更内容**:
- 物件一覧画面にサブリース物件フィルタを追加
- サブリース物件の検索・絞り込み機能

**影響範囲**:
- **コントローラー**: `ArticlesController`
- **ビュー**: 物件一覧画面 (`app/views/articles/index.html.erb`)
- **モデル**: `Article`モデルのスコープ追加

**実装イメージ**:
```ruby
# Articleモデルにスコープ追加
scope :sublease_only, -> { where(is_sublease: true) }

# コントローラーで使用
@articles = Article.sublease_only if params[:sublease_only].present?
```

#### 2.2.2 キャンペーン管理機能

**変更内容**:
- キャンペーンマスターにサブリース物件条件を追加
- サブリース物件向けキャンペーンの設定・管理機能

**影響範囲**:
- **データベース**: キャンペーンテーブルに`target_sublease_only`フラグを追加
- **モデル**: `Campaign`モデル（存在する場合）
- **コントローラー**: キャンペーン管理画面

#### 2.2.3 営業支援機能

**変更内容**:
- サブリース物件の提案時に、営業担当者向けのサブリース物件向け販売促進情報を表示
- サブリース物件のメリット・デメリットを営業担当者に提示

**影響範囲**:
- **ビュー**: 物件詳細画面、案件詳細画面
- **モデル**: `Article`モデルにサブリース物件向け情報取得メソッドを追加

---

### 2.3 SUPPLIER（仕入れ管理システム）側

**対象システム**: `supplier-article` (SUPPLIER Backend)

#### 2.3.1 データ連携機能

**変更内容**:
- サブリース物件の判定フラグ（`is_sublease`）が確実にAGNTに連携されることを確認
- サブリース物件の販売促進に必要な情報（家賃保証期間、契約期間など）をAGNTに連携

**影響範囲**:
- **API**: SUPPLIER → AGNT のデータ連携API
- **データベース**: SUPPLIER側のサブリース物件情報の管理

---

### 2.4 マーケティング・キャンペーン機能

**対象システム**: TechMarketing (Mktg by RENOSY)

#### 2.4.1 キャンペーン設定機能

**変更内容**:
- サブリース物件を対象としたキャンペーン設定機能
- サブリース物件に特典・割引を適用する機能

**影響範囲**:
- **データベース**: キャンペーンマスターテーブル
- **API**: キャンペーン適用ロジック
- **フロントエンド**: キャンペーン管理画面

**参考**: `knowledge/research/campaign_decision_checklist.md`にキャンペーン管理の論点が記載されています。

---

## 3. 影響範囲の詳細

### 3.1 データベース変更

#### 3.1.1 AGNT（verdandi）データベース

**追加が必要なカラム**:
- `campaigns`テーブル（存在する場合）:
  - `target_sublease_only` (boolean): サブリース物件のみを対象とするフラグ
  - `sublease_campaign_description` (text): サブリース物件向けキャンペーン説明

**既存カラムの活用**:
- `articles.sublease_contract_months`: サブリース標準契約期間
- `articles.sublease_contract_price`: サブリース標準家賃
- `articles.supplier_article_id`: SUPPLIERシステムとの連携キー

#### 3.1.2 INSIGHT（agnt_rda）データベース

**確認が必要な項目**:
- サブリース物件の判定フラグがAGNTから正しく連携されているか
- 物件検索・フィルタリング機能でサブリース物件を条件として使用できるか

---

### 3.2 API変更

#### 3.2.1 AGNT（verdandi）API

**変更が必要なAPI**:
1. **物件一覧API** (`/api/articles`)
   - クエリパラメータに`sublease_only`を追加
   - レスポンスにサブリース物件フラグを含める

2. **物件詳細API** (`/api/articles/:id`)
   - レスポンスにサブリース物件情報を追加
   - サブリース物件向けキャンペーン情報を含める

3. **キャンペーン適用API** (存在する場合)
   - サブリース物件条件を追加

#### 3.2.2 INSIGHT（agnt_rda）API

**変更が必要なAPI**:
1. **物件検索API**
   - サブリース物件フィルタを追加
   - サブリース物件の強調表示情報を追加

2. **物件詳細API**
   - サブリース物件情報を追加
   - サブリース物件向けキャンペーン情報を含める

---

### 3.3 フロントエンド変更

#### 3.3.1 AGNT（verdandi）フロントエンド

**変更が必要な画面**:
1. **物件一覧画面**
   - サブリース物件フィルタの追加
   - サブリース物件のバッジ表示

2. **物件詳細画面**
   - サブリース物件情報の表示
   - サブリース物件向けキャンペーン情報の表示

3. **キャンペーン管理画面** (存在する場合)
   - サブリース物件条件の設定UI

#### 3.3.2 INSIGHT（agnt_rda）フロントエンド

**変更が必要な画面**:
1. **物件一覧画面**
   - サブリース物件フィルタの追加
   - サブリース物件のバッジ・強調表示

2. **物件詳細画面**
   - サブリース物件情報の表示
   - サブリース物件向けキャンペーン情報の表示

3. **検索画面**
   - サブリース物件検索オプションの追加

---

### 3.4 バッチ処理・自動化機能

#### 3.4.1 サブリース物件向け自動通知機能

**変更内容**:
- サブリース物件の新規登録時に、営業担当者に自動通知
- サブリース物件向けキャンペーンの開始時に、対象顧客に自動通知

**影響範囲**:
- **バッチ処理**: 定期実行バッチ
- **通知機能**: Slack通知、メール通知

---

## 4. 実装優先度

### 4.1 Phase 1: 基本機能（高優先度）

1. **サブリース物件の判定機能の確認・強化**
   - `Article#supplier_sublease?`メソッドの動作確認
   - SUPPLIERシステムからのデータ連携確認

2. **INSIGHT側の物件検索・フィルタリング機能**
   - サブリース物件フィルタの追加
   - サブリース物件の強調表示

3. **AGNT側の物件一覧画面の改善**
   - サブリース物件フィルタの追加
   - サブリース物件のバッジ表示

### 4.2 Phase 2: キャンペーン機能（中優先度）

1. **キャンペーンマスターへのサブリース物件条件追加**
   - データベーススキーマ変更
   - キャンペーン設定UIの変更

2. **サブリース物件向けキャンペーンの適用ロジック**
   - キャンペーン適用APIの変更
   - フロントエンドでのキャンペーン表示

### 4.3 Phase 3: 高度な機能（低優先度）

1. **サブリース物件向け自動通知機能**
   - バッチ処理の追加
   - 通知機能の実装

2. **サブリース物件向け分析機能**
   - サブリース物件の成約率分析
   - サブリース物件向けキャンペーンの効果測定

---

## 5. リスクと注意事項

### 5.1 データ整合性リスク

- **リスク**: SUPPLIERシステムとAGNTシステム間でサブリース物件の判定が一致しない可能性
- **対策**: データ連携の確認、整合性チェック機能の実装

### 5.2 パフォーマンスリスク

- **リスク**: サブリース物件フィルタの追加により、検索クエリのパフォーマンスが低下する可能性
- **対策**: インデックスの追加、クエリの最適化

### 5.3 ユーザー体験リスク

- **リスク**: サブリース物件の強調表示が過度になり、ユーザー体験が悪化する可能性
- **対策**: UI/UXの検討、A/Bテストの実施

---

## 6. 参考資料

- [サブリース物件販売改善ウィッシュリスト](./wishlist_sublease_sales_improvement.md)
- [サブリース契約書連携の実装方針検討](./development_requirements_sublease.md)
- [物件詳細画面の全項目表示ロジック](../../knowledge/technical/specifications/article_detail_all_items_display_logic.md)
- [キャンペーン予実管理 重要論点・意思決定チェックリスト](../../knowledge/research/campaign_decision_checklist.md)

---

## 7. 次のステップ

1. **要件定義の詳細化**
   - サブリース物件向け販売促進機能の具体的な要件を定義
   - キャンペーン内容、特典、期間などを決定

2. **技術調査**
   - 各システムの実装状況を詳細に調査
   - API仕様の確認

3. **プロトタイプ作成**
   - Phase 1の機能をプロトタイプとして実装
   - ユーザーテストの実施

4. **本番実装**
   - Phase 1 → Phase 2 → Phase 3の順で実装
   - 各フェーズでテスト・リリースを実施
