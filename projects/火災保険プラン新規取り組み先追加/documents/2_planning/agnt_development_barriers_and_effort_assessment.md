# AGNT開発における障壁と改善の難易度評価

**作成日**: 2026-02-06  
**目的**: Outboundオペレーションの業務・課題ヒアリング実施前の前提知識整理  
**対象**: AGNT（verdandi）システムの開発における障壁と改善の難易度

---

## 📋 概要

本ドキュメントは、AGNTシステムの開発における障壁と、改善の難易度（工数）を評価したものです。Outboundオペレーションの皆さまへのヒアリング実施前に、以下の観点で整理しています：

- **どういった改善だと難しいのか**（高工数・複雑）
- **どういう改善であれば比較的軽い工数で実行できるのか**（低工数・簡単）
- **他システムとの連携を加味した評価**

---

## 🔴 難しい改善（高工数・複雑）

> **💡 Outboundオペレーションの皆さまへのヒアリング前に特に重要な情報**
> 
> 稟議・契約モデルの変更は、AGNTシステムの中核をなす機能であり、**最も影響範囲が広く、難易度が高い**改善です。Outboundオペレーションの業務改善を検討する際は、まずこのセクションを確認してください。

### 1. 稟議・契約モデルの変更

> **⚠️ 最重要**: 稟議（Entry）と契約（Contract）モデルは、AGNTシステムの中核機能です。これらの変更は、複数のシステムに影響し、非常に高い難易度となります。

#### 1.1 ステータス遷移の変更
**難易度**: ⭐⭐⭐⭐⭐（非常に高い）  
**工数目安**: 3-6ヶ月以上

**具体的な課題**:

1. **Contractモデルのステータス遷移**
   - **ステータス定義**: `applied` → `contract_preparation` → `loan_preparation` → `loan_judgment` → `payment_process` → `paid`
   - **不可逆な遷移**: `applied`以降のステータスは変更不可（`consul_after_applied_statuses`に含まれる）
   - **複数の定数定義**: `NOT_CONTRACTED_STATUS`, `CONTRACTED_STATUS`, `NEGATIVE_STATUS`, `POSITIVE_STATUS`, `CLOSABLE_STATUS`, `FIXED_STATUS`など

2. **Entryモデル（稟議）のステータス遷移**
   - **ステータス定義**: `confirm`（稟議承認待ち）、`remand`（稟議依頼差し戻し）、`closer_unconfirm`（稟議依頼待ち）など
   - **修正稟議の処理**: `update_approve`フラグによる修正稟議の管理
   - **承認フローの複雑さ**: 複数の承認者、差し戻し、取下げなどの処理

**具体的な障壁**:

- **コールバック処理の複雑さ**:
  - `after_update`, `before_save`などのコールバックが多数存在
  - 状態遷移のトリガーが複数ある（SUPPLIER連携、手動操作、決済完了など）
  - コールバック内で他のモデルも更新する（例: `deposit_confirmed`の更新）
  
- **データ整合性の確保**:
  - ContractとEntryの同期が必要（修正稟議が申請中の場合、値が異なる可能性）
  - 既存データへの影響（ステータス変更により既存データが無効になる可能性）
  - 修正稟議の処理が複雑（`last_unapproved_update_approve_entry`の判定など）

- **複数システムへの影響**:
  - **MANAGE（tech_after）**: 稟議システム（`agreement_approvals`）、管理契約データ（`rental_management_contracts`）、送金計算システム（`remittances`）
  - **FLOW**: 決済完了後の会計処理システム連携
  - **SUPPLIER**: 契約書作成API連携、`contract_preparation`状態遷移の検知
  - **DocuSign**: 書類連携処理のトリガー

**実装が必要な項目**:
- [ ] ステータス遷移ロジックの変更
- [ ] コールバック処理の追加・修正
- [ ] ContractとEntryの同期処理
- [ ] 修正稟議の処理ロジック
- [ ] 既存データのマイグレーション
- [ ] 複数システムへの影響範囲の確認・修正
- [ ] エラーハンドリング・ロールバック処理

---

#### 1.2 データベーススキーマ変更
**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-4ヶ月

**具体的な課題**:

1. **Contractモデルのカラム追加・変更**
   - **例**: 管理プラン割引オプション追加時
     ```sql
     ALTER TABLE rental_management_contracts 
     ADD COLUMN discount_option_id INTEGER,
     ADD COLUMN discount_rate DECIMAL(5,2),
     ADD COLUMN discount_amount INTEGER,
     ADD COLUMN discount_start_date DATE,
     ADD COLUMN discount_end_date DATE;
     ```

2. **Entryモデル（稟議）のカラム追加・変更**
   - 稟議種類の追加、稟議内容の拡張

**具体的な障壁**:

- **既存データへの影響**:
  - 既存データとの整合性確保が必要
  - デフォルト値の設定、NULL値の扱い
  - データマイグレーションの複雑さ

- **後続システムへの影響**:
  - **MANAGE**: 稟議システム、料金計算システム、送金計算システム
  - **OWNR**: 管理契約API連携、顧客データ同期
  - **データ分析システム**: DBTプラットフォーム、レポート生成システム
  - **フロントエンド**: 顧客向けアプリ、管理画面

- **料金計算ロジックへの影響**:
  - 管理手数料計算ロジックの変更（割引適用後の計算）
  - 送金明細の変更（割引項目の追加）
  - 月次送金計算の変更（割引期間中の計算ロジック）

**実装が必要な項目**:
- [ ] データベーススキーマ変更
- [ ] 既存データのマイグレーション
- [ ] デフォルト値の設定
- [ ] バリデーションルールの追加
- [ ] 料金計算ロジックの更新
- [ ] API連携の更新
- [ ] フロントエンドの対応

---

#### 1.3 コールバック処理の追加・変更
**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-3ヶ月

**具体的な課題**:

1. **Contractモデルのコールバック**
   - **例**: `contract_preparation`状態遷移時の事前送付処理
     ```ruby
     after_update :send_pre_delivery_documents, if: :contract_preparation?
     
     def send_pre_delivery_documents
       return unless saved_change_to_status? && contract_preparation?
       PreDeliveryEnvelopeService.new(self).execute
     end
     ```

2. **Entryモデル（稟議）のコールバック**
   - 稟議承認時の処理、修正稟議作成時の処理

**具体的な障壁**:

- **コールバックの実行順序**:
  - 複数のコールバックが存在する場合、実行順序の制御が困難
  - コールバック間の依存関係の管理

- **エラーハンドリング**:
  - コールバック内でエラーが発生した場合のロールバック処理
  - トランザクション管理の複雑さ

- **パフォーマンス**:
  - コールバックが重い処理を実行する場合のパフォーマンス影響
  - N+1クエリの問題

- **テストの複雑さ**:
  - コールバックのテストが困難
  - モック・スタブの設定が複雑

**実装が必要な項目**:
- [ ] コールバック処理の設計
- [ ] 実行順序の制御
- [ ] エラーハンドリング・ロールバック処理
- [ ] トランザクション管理
- [ ] パフォーマンス最適化
- [ ] テストコードの作成

---

#### 1.4 修正稟議の処理
**難易度**: ⭐⭐⭐⭐⭐（非常に高い）  
**工数目安**: 3-4ヶ月

**具体的な課題**:

1. **修正稟議の判定ロジック**
   - `update_approve`フラグによる修正稟議の識別
   - `last_unapproved_update_approve_entry`の取得
   - 修正稟議の手付金変更チェック

2. **修正稟議と既存処理の統合**
   - 交付後の修正稟議制限の実装
   - 修正稟議作成時のエンベロープ無効化処理
   - 修正稟議承認後の契約書再連携

**具体的な障壁**:

- **複雑な判定ロジック**:
  - 修正稟議の作成可能判定（`can_add_approve?`）
  - 修正稟議の取下げ可能判定（`can_be_withdrawn_by?`）
  - 修正稟議と通常ENTRYの区別

- **データ整合性**:
  - ContractとEntryの値の同期（修正稟議が申請中の場合、値が異なる）
  - 修正稟議承認後の値の反映

- **DocuSign連携への影響**:
  - 修正稟議作成時のエンベロープ無効化処理
  - 修正稟議承認後の契約書再連携
  - 顧客・担当者への通知処理

**実装が必要な項目**:
- [ ] 修正稟議の判定ロジック
- [ ] 修正稟議の作成・編集・承認処理
- [ ] 修正稟議と既存処理の統合
- [ ] DocuSign連携への影響対応
- [ ] データ整合性の確保
- [ ] エラーハンドリング・ロールバック処理

---

### 2. システム間連携・統合

#### 1.1 Salesforce連携（PPL → AGNT → Salesforce）
**難易度**: ⭐⭐⭐⭐⭐（非常に高い）  
**工数目安**: 3-6ヶ月以上

**具体的な連携内容**:
- **データフロー**: PPL（顧客マスタ）→ AGNT（営業支援）→ Salesforce（CRM）
- **同期対象データ**: 顧客情報（年収・資産・借入・連絡先・氏名）、タイムライン情報
- **更新トリガー**: 特定の行動（商談・ヒアリング電話）発生時
- **技術スタック**: Snowflake（データウェアハウス）、torocco（データ連携ツール）

**具体的な障壁**:
- **SnowflakeのSLA懸念**: パフォーマンス要件が満たせない可能性があり、事前確認が必要
- **データ責任分担の複雑さ**: 顧客マスタはPPL、タイムライン管理はSalesforceと分離されているため、更新タイミングの調整が困難
- **検索機能の制約**: Salesforceでは検索ができなくなるため、「参照だけ」という方針は取れない
- **差分更新の実装**: 全件同期ではなく差分更新が必要だが、変更検知ロジックの実装が複雑

**実装が必要な項目**:
- PPL-AGNT間のデータ連携API/バッチ
- AGNT-Salesforce間のデータ同期機能（Snowflake経由）
- 更新トリガー条件の詳細設計
- エラーハンドリング・リトライ機能
- データ整合性チェック機能

---

#### 1.2 Reco統合（二重管理解消）
**難易度**: ⭐⭐⭐⭐⭐（非常に高い）  
**工数目安**: 3-4ヶ月

**具体的な連携内容**:
- **課題**: Recoで扱っているAGNT由来のリードが二重管理になっている
- **データ構造の違い**:
  - **AGNT**: ホーム → 取引先(取引先責任者) → N:交渉(アポ以降) → 1:契約
  - **Reco**: 事務管理 → 物件（一棟） → 部屋（複数）
- **統合対象**: フェーズ管理（進捗・ステータス）、項目管理（データ項目・属性）

**具体的な障壁**:
- **データ構造の不一致**: AGNTは顧客中心、Recoは物件中心の構造で、マッピングが複雑
- **重複レコードの特定・統合**: 同じ顧客・物件が両システムに存在する場合の統合ロジックが必要
- **フェーズ管理の統一**: AGNTの「交渉」とRecoの「物件管理」フェーズのマッピングが必要
- **リアルタイム同期 vs バッチ同期**: どちらを採用するかで実装複雑度が大きく変わる

**実装が必要な項目**:
- AGNT・Recoのデータマッピング・変換機能
- 重複レコードの特定・統合機能
- 統一フェーズ定義・マッピング機能
- 進捗同期・更新機能
- ステータス変更の自動反映機能

---

#### 1.3 SUPPLIER連携（契約書作成・DocuSign連携）
**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-3ヶ月

**具体的な連携内容**:
- **SUPPLIER → AGNT**: 契約書作成API連携
  - SUPPLIER側で契約書作成完了 → AGNTに`contract_preparation`状態遷移を通知
  - AGNTがSUPPLIER S3から契約書を取得
  - AGNTの契約情報を差し込んで保存
- **AGNT → DocuSign**: 書類連携処理
  - `contract_preparation`状態遷移を検知
  - 契約に紐づくRENOSYアカウントからメールアドレス取得
  - サブリース物件判定（特定賃貸借物件の場合、SUPPLIER S3からサブリース契約書を取得）
  - DocuSignに契約書類を連携（ワークフローを一時停止した状態）
  - 顧客がマイページ契約ボタン押下時にワークフロー解除・送信

**具体的な障壁**:
- **複雑な状態遷移管理**: `contract_preparation`状態遷移の検知と、ワークフローの一時停止・解除の実装
- **S3からのファイル取得**: SUPPLIER S3から契約書ファイルを取得する処理
- **サブリース物件の条件分岐**: 特定賃貸借物件の場合のみ追加書類を取得するロジック
- **DocuSign API連携**: ワークフロー一時停止、書類送信、署名完了通知のコールバック処理
- **エラーハンドリング**: バリデーションエラー時の処理（サブリース賃契が格納されていない場合など）

**実装が必要な項目**:
- SUPPLIER → AGNT 契約書作成API連携
- AGNT → SUPPLIER S3 契約書取得機能
- AGNT → DocuSign 書類連携機能（ワークフロー一時停止含む）
- DocuSign コールバック処理（署名完了通知）
- サブリース物件判定ロジック
- バリデーション機能

---

#### 1.4 FLOW連携（決済完了後の会計処理）
**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-3ヶ月

**具体的な連携内容**:
- **AGNT → FLOW**: 決済完了後の会計処理システム連携
- **連携トリガー**: 契約ステータス遷移時、決済完了時、契約書アップロード時（要確認）
- **連携データ**: 契約情報、決済情報、物件情報
- **FLOW側の処理**: AGNTで決済日設定 → FLOWで日時監視 → 17時到達 → 決済実行

**具体的な障壁**:
- **連携トリガーの特定**: どのタイミングで連携するかが不明確（契約ステータス遷移？決済完了？契約書アップロード？）
- **手作業アップロード時の処理**: クラウドサインで締結した契約書を手作業でAGNTにアップロードした場合の連携条件が不明
- **データ形式の不一致**: AGNTとFLOWで異なるデータ構造・フォーマットの可能性
- **決済タイミングの制御**: FLOW側で17時到達を監視して決済実行する処理の実装

**実装が必要な項目**（要確認）:
- AGNT側の連携処理実装箇所の特定
- FLOW側のデータ受信処理実装箇所の特定
- 連携データ形式の定義
- 連携トリガー条件の明確化
- エラーハンドリング・リトライ機能

---

#### 1.5 MANAGE連携（顧客マスタ同期）
**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-3ヶ月

**具体的な連携内容**:
- **MANAGE → AGNT**: 管理手数料請求データの連携
  - MANAGE側で「誰に／いくら」の請求を確定
  - 請求データをAGNTに渡す
  - AGNT既存のGMO決済機能で決済URL発行・送信
- **AGNT → MANAGE**: 決済完了通知の連携
  - 決済完了データをMANAGEに連携
  - 送金計算への反映

**具体的な障壁**:
- **既存機能の活用**: AGNT既存のGMO決済機能を活用する必要があるが、管理手数料決済用のモデル追加が必要
- **データ連携方法の選択**: API連携、バッチ連携、ファイル連携のどれを採用するか
- **決済タイミングの制御**: 月次決済の場合、決済URLの有効期限設定が必要
- **決済失敗時のリトライ**: 決済失敗時のリトライ機能の実装

**実装が必要な項目**:
- MANAGE → AGNT 請求データ連携API/バッチ
- AGNT側の管理手数料決済用モデル追加（`ManagementFeePayment`）
- AGNT → MANAGE 決済完了通知機能
- 決済URL有効期限設定機能
- 決済失敗時のリトライ機能

---

### 3. データ整合性・監査機能の実装

#### 2.1 タイムライン監査システム
**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-4ヶ月

**具体的な課題**:
- **現状の問題**: タイムラインの編集によって、自分に不利益なデータを隠蔽することが可能
  - 失敗した営業活動の記録削除
  - 顧客との重要なやり取りの改ざん
  - 実績数値の操作
  - 責任回避のための証拠隠滅
- **監査の困難性**: いつ・だれが・どういう内容を変更したか、気づいたり調査することが難しい

**具体的な実装内容**:

1. **編集権限の分離**
   - **編集不可データ（イミュータブル）**:
     - 顧客との実際のやり取り内容
     - 面談日時・場所
     - 提案内容・条件
     - 顧客の回答・反応
     - 重要な決定事項
   - **編集可能データ**:
     - 追加コメント・補足情報
     - タグ・カテゴリ分類
     - 個人メモ・所感

2. **編集証跡システム**
   - **編集履歴テーブル設計**:
     ```sql
     CREATE TABLE timeline_edit_history (
         id BIGINT PRIMARY KEY,
         timeline_id BIGINT,
         editor_user_id BIGINT,
         edit_timestamp TIMESTAMP,
         content_before TEXT,
         content_after TEXT,
         edit_reason VARCHAR(500),
         created_at TIMESTAMP
     );
     ```
   - **編集理由の必須入力**: 編集時に理由入力を必須化
   - **編集マーク表示**: 編集されたエントリには明確な「編集済み」表示
   - **履歴表示**: 「編集履歴を見る」リンクで詳細表示
   - **差分表示**: Before/After形式での変更内容表示

**具体的な障壁**:
- **データベース設計**: 編集履歴テーブルの設計・実装、既存タイムラインテーブルとの関連付け
- **パフォーマンス**: 履歴データの蓄積による性能影響、履歴検索・表示の処理負荷
- **ストレージ容量**: 編集履歴データの保存容量増加（長期的な影響）
- **UI/UX設計**: 編集マーク表示、履歴表示、差分表示の実装、編集プロセスの複雑化によるユーザビリティへの影響
- **権限管理**: 本人 + 管理者のみ編集可能という権限管理の実装
- **削除禁止**: 編集履歴の削除は不可という制約の実装

**実装が必要な項目**:
- [ ] 編集可能/不可データの分類定義
- [ ] 編集履歴テーブルの設計・実装
- [ ] 編集マーク表示機能
- [ ] 編集履歴表示UI
- [ ] 差分表示機能
- [ ] 編集理由入力機能（必須化）
- [ ] 権限管理の実装
- [ ] 監査ログ機能
- [ ] データバックアップ・復旧機能

---

### 4. 既存システムの大規模変更

#### 3.1 AGNT乗り換え検討（PMI統合時）
**難易度**: ⭐⭐⭐⭐⭐（非常に高い）  
**工数目安**: 6ヶ月以上

**具体的な背景**:
- **PMI統合**: 企業統合（M&A）に伴うシステム統合の検討
- **検討事項**: AGNT乗り換えが統合の初手として検討された
- **目的**: 顧客管理システムの統合、データ基盤の統一、業務プロセスの標準化

**具体的な障壁**:

1. **データ移行コスト**
   - **既存データの統合・変換**: AGNTに蓄積された大量の顧客データ・案件データの移行
   - **データ品質の確保**: 移行プロセス中のデータ欠損・破損のリスク
   - **データマッピング**: 異なるシステム間でのデータ構造のマッピング・変換

2. **プロセス変更のコスト**
   - **業務フロー・手順の統一**: 複数部署で異なる業務プロセスの統一
   - **ユーザー教育**: 新システムへの移行に伴う教育・トレーニングコスト
   - **運用プロセスの変更**: 既存の運用プロセスを新システムに合わせて変更

3. **影響範囲の広さ**
   - **複数部署への影響**: 営業部門、CS部門、OLC部門など複数部署がAGNTを利用
   - **他システムへの影響**: AGNTと連携している他システム（Salesforce、Reco、SUPPLIER、FLOWなど）への影響
   - **顧客への影響**: システム変更に伴う顧客体験への影響

4. **業務継続性**
   - **統合期間中の業務停止リスク**: システム移行期間中の業務停止・影響リスク
   - **段階的移行の複雑さ**: 全システムを一度に移行するのは困難で、段階的移行が必要だが複雑
   - **ロールバック計画**: 移行失敗時のロールバック計画の策定

**詳細検討要項目**:
- [ ] データ移行の技術的複雑性・工数
- [ ] 業務プロセス変更の影響範囲・教育コスト
- [ ] システム統合による効率化効果
- [ ] ROI・ペイバック期間の算出
- [ ] 統合期間中の業務継続計画
- [ ] リスク対策・コンティンジェンシープラン

**参考**: PMI統合時の検討では、AGNT乗り換えのコスト詳細試算が短期優先項目として挙げられていた

---

### 5. 外部サービス連携の実装

#### 4.1 GMOクレジットカード決済（Link Plus）連携
**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-3ヶ月

**具体的な連携内容**:
- **サービス**: GMOペイメントゲートウェイの「Link Plus」サービス
- **利用シーン**:
  1. **手付金決済** (`DepositPayment`): 物件購入時の手付金をクレジットカードで決済
  2. **諸費用決済** (`CreditSettlement`): 諸費用（火災保険料など）をクレジットカードで決済

**システム構成**:
```
AGNT (verdandi)
  └─ PaymentGateway::MailLinkPlus
      └─ GMO Link Plus API
          └─ 決済URL生成 → 顧客にメール送信
              └─ コールバックAPI → AGNTに決済完了通知
```

**実装ファイル**:
- **決済URL生成**: `app/models/payment_gateway/mail_link_plus.rb`
- **決済キャンセル**: `app/models/payment_gateway/cancel_mail_link_plus.rb`
- **ベースクラス**: `app/models/payment_gateway/base.rb`
- **コールバック受信**: `app/controllers/payment_gateway_api/v1/mail_link/settlements_controller.rb`
- **モデル**: `app/models/deposit_payment.rb` (手付金), `app/models/credit_settlement.rb` (諸費用)

**具体的な障壁**:
- **GMO API仕様の理解**: Link Plus APIの仕様・制約の把握
- **決済URL生成**: 決済URLの有効期限設定（手付金は発行日の翌日まで、諸費用は対象月の末日まで）
- **コールバック処理**: GMOからコールバックAPIに通知 → `SettlementsController#create` で受信 → ステータス更新
- **決済キャンセル**: 必要時の決済URL無効化処理
- **ConfigID管理**: `agntbyrenosy` というConfigIDの管理
- **セキュリティ**: 決済情報・個人情報の取り扱い、PCI DSS準拠

**実装が必要な項目**:
- [ ] GMO Link Plus API連携機能
- [ ] 決済URL生成機能
- [ ] コールバックAPI実装
- [ ] 決済キャンセル機能
- [ ] 決済履歴管理機能
- [ ] エラーハンドリング・リトライ機能

---

#### 4.2 DocuSign連携（重要事項説明書送付）
**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-3ヶ月

**具体的な連携内容**:
- **目的**: 重要事項説明前の必要書類送付
- **ワークフロー**:
  1. **事前連携（ワークフロー一時停止）**: SUPPLIERから契約書準備完了通知 → AGNTがDocuSignに書類連携（送信せず一時停止）
  2. **書類送付**: 顧客がマイページ契約ボタン押下 → ワークフロー解除 → DocuSignから顧客へメール送信
  3. **署名処理**: 顧客がDocuSignで署名 → コールバックAPIでAGNTに通知 → 署名済み契約書を保存

**具体的な実装内容**:
- **DocuSign API連携**: `DocumentSign::Envelope.new.send()` でエンベロープ作成
- **ワークフロー一時停止**: DocuSignに連携するが送信しない状態を実現
- **メールアドレス取得**: 契約に紐づくRENOSYアカウントからメールアドレス取得
- **サブリース物件判定**: 特定賃貸借物件の場合、SUPPLIER S3からサブリース契約書を取得して追加
- **コールバック処理**: 署名完了通知をDocuSignから受信 → 署名済み契約書をS3に保存

**具体的な障壁**:
- **ワークフロー一時停止の実装**: DocuSign APIで「送信せずに連携」する状態の実現方法
- **状態遷移管理**: `contract_preparation`状態遷移の検知と、ワークフローの一時停止・解除の実装
- **認証レベル**: A（2要素認証）が必要で、セキュリティ要件が高い
- **コールバック処理**: 署名完了通知の受信・処理、エラーハンドリング
- **ファイル管理**: SUPPLIER S3からの契約書取得、AGNT S3への署名済み契約書保存

**実装が必要な項目**:
- [ ] DocuSign API連携機能（エンベロープ作成）
- [ ] ワークフロー一時停止機能
- [ ] ワークフロー解除機能（マイページ契約ボタン押下時）
- [ ] DocuSignコールバック処理（署名完了通知）
- [ ] 署名済み契約書保存機能
- [ ] サブリース物件判定ロジック
- [ ] エラーハンドリング・リトライ機能

---

#### 4.3 保険会社システム連携（東京海上日動、日新火災）
**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-3ヶ月

**具体的な連携内容**:
- **東京海上日動**: 現行の保険申込システム
  - **課題**: 部分修正が不可能で、日付変更のたびに全工程のやり直しが必要
  - **制約**: 計上前の始期日変更は、メールか電話で契約者に確認することが必須
- **日新火災**: Web完結フローを持つ保険会社
  - **特徴**: 顧客がWebから直接申込・クレジットカード登録が可能
  - **メリット**: PTNSの介入を排除し、事務作業の約85%を保険会社側へ移管

**具体的な障壁**:
- **東京海上日動の仕様制約**: システム上で「1日ずらすだけ」の処理は認められず、都度「人力を介した確認と再手続き」が必要
- **日新火災への移行**: 新規契約・更新を日新火災へ移行する場合、システム連携の実装が必要
- **データ移行**: 既存の東京海上日動の契約データを日新火災へ移行する必要がある場合の対応
- **Web完結フローの実装**: 日新火災のWeb見積・申込サイトとの連携

**実装が必要な項目**（日新火災移行時）:
- [ ] 日新火災Webサイトとの連携API
- [ ] 顧客情報の連携機能
- [ ] 申込データの連携機能
- [ ] 決済情報の連携機能
- [ ] エラーハンドリング・リトライ機能

---

### 5. 稟議・契約モデルの変更

#### 5.1 ステータス遷移の変更
**難易度**: ⭐⭐⭐⭐⭐（非常に高い）  
**工数目安**: 3-6ヶ月以上

**具体的な課題**:

1. **Contractモデルのステータス遷移**
   - **ステータス定義**: `applied` → `contract_preparation` → `loan_preparation` → `loan_judgment` → `payment_process` → `paid`
   - **不可逆な遷移**: `applied`以降のステータスは変更不可（`consul_after_applied_statuses`に含まれる）
   - **複数の定数定義**: `NOT_CONTRACTED_STATUS`, `CONTRACTED_STATUS`, `NEGATIVE_STATUS`, `POSITIVE_STATUS`, `CLOSABLE_STATUS`, `FIXED_STATUS`など

2. **Entryモデル（稟議）のステータス遷移**
   - **ステータス定義**: `confirm`（稟議承認待ち）、`remand`（稟議依頼差し戻し）、`closer_unconfirm`（稟議依頼待ち）など
   - **修正稟議の処理**: `update_approve`フラグによる修正稟議の管理
   - **承認フローの複雑さ**: 複数の承認者、差し戻し、取下げなどの処理

**具体的な障壁**:

- **コールバック処理の複雑さ**:
  - `after_update`, `before_save`などのコールバックが多数存在
  - 状態遷移のトリガーが複数ある（SUPPLIER連携、手動操作、決済完了など）
  - コールバック内で他のモデルも更新する（例: `deposit_confirmed`の更新）
  
- **データ整合性の確保**:
  - ContractとEntryの同期が必要（修正稟議が申請中の場合、値が異なる可能性）
  - 既存データへの影響（ステータス変更により既存データが無効になる可能性）
  - 修正稟議の処理が複雑（`last_unapproved_update_approve_entry`の判定など）

- **複数システムへの影響**:
  - **MANAGE（tech_after）**: 稟議システム（`agreement_approvals`）、管理契約データ（`rental_management_contracts`）、送金計算システム（`remittances`）
  - **FLOW**: 決済完了後の会計処理システム連携
  - **SUPPLIER**: 契約書作成API連携、`contract_preparation`状態遷移の検知
  - **DocuSign**: 書類連携処理のトリガー

**実装が必要な項目**:
- [ ] ステータス遷移ロジックの変更
- [ ] コールバック処理の追加・修正
- [ ] ContractとEntryの同期処理
- [ ] 修正稟議の処理ロジック
- [ ] 既存データのマイグレーション
- [ ] 複数システムへの影響範囲の確認・修正
- [ ] エラーハンドリング・ロールバック処理

---

#### 5.2 データベーススキーマ変更
**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-4ヶ月

**具体的な課題**:

1. **Contractモデルのカラム追加・変更**
   - **例**: 管理プラン割引オプション追加時
     ```sql
     ALTER TABLE rental_management_contracts 
     ADD COLUMN discount_option_id INTEGER,
     ADD COLUMN discount_rate DECIMAL(5,2),
     ADD COLUMN discount_amount INTEGER,
     ADD COLUMN discount_start_date DATE,
     ADD COLUMN discount_end_date DATE;
     ```

2. **Entryモデル（稟議）のカラム追加・変更**
   - 稟議種類の追加、稟議内容の拡張

**具体的な障壁**:

- **既存データへの影響**:
  - 既存データとの整合性確保が必要
  - デフォルト値の設定、NULL値の扱い
  - データマイグレーションの複雑さ

- **後続システムへの影響**:
  - **MANAGE**: 稟議システム、料金計算システム、送金計算システム
  - **OWNR**: 管理契約API連携、顧客データ同期
  - **データ分析システム**: DBTプラットフォーム、レポート生成システム
  - **フロントエンド**: 顧客向けアプリ、管理画面

- **料金計算ロジックへの影響**:
  - 管理手数料計算ロジックの変更（割引適用後の計算）
  - 送金明細の変更（割引項目の追加）
  - 月次送金計算の変更（割引期間中の計算ロジック）

**実装が必要な項目**:
- [ ] データベーススキーマ変更
- [ ] 既存データのマイグレーション
- [ ] デフォルト値の設定
- [ ] バリデーションルールの追加
- [ ] 料金計算ロジックの更新
- [ ] API連携の更新
- [ ] フロントエンドの対応

---

#### 5.3 コールバック処理の追加・変更
**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-3ヶ月

**具体的な課題**:

1. **Contractモデルのコールバック**
   - **例**: `contract_preparation`状態遷移時の事前送付処理
     ```ruby
     after_update :send_pre_delivery_documents, if: :contract_preparation?
     
     def send_pre_delivery_documents
       return unless saved_change_to_status? && contract_preparation?
       PreDeliveryEnvelopeService.new(self).execute
     end
     ```

2. **Entryモデル（稟議）のコールバック**
   - 稟議承認時の処理、修正稟議作成時の処理

**具体的な障壁**:

- **コールバックの実行順序**:
  - 複数のコールバックが存在する場合、実行順序の制御が困難
  - コールバック間の依存関係の管理

- **エラーハンドリング**:
  - コールバック内でエラーが発生した場合のロールバック処理
  - トランザクション管理の複雑さ

- **パフォーマンス**:
  - コールバックが重い処理を実行する場合のパフォーマンス影響
  - N+1クエリの問題

- **テストの複雑さ**:
  - コールバックのテストが困難
  - モック・スタブの設定が複雑

**実装が必要な項目**:
- [ ] コールバック処理の設計
- [ ] 実行順序の制御
- [ ] エラーハンドリング・ロールバック処理
- [ ] トランザクション管理
- [ ] パフォーマンス最適化
- [ ] テストコードの作成

---

#### 5.4 修正稟議の処理
**難易度**: ⭐⭐⭐⭐⭐（非常に高い）  
**工数目安**: 3-4ヶ月

**具体的な課題**:

1. **修正稟議の判定ロジック**
   - `update_approve`フラグによる修正稟議の識別
   - `last_unapproved_update_approve_entry`の取得
   - 修正稟議の手付金変更チェック

2. **修正稟議と既存処理の統合**
   - 交付後の修正稟議制限の実装
   - 修正稟議作成時のエンベロープ無効化処理
   - 修正稟議承認後の契約書再連携

**具体的な障壁**:

- **複雑な判定ロジック**:
  - 修正稟議の作成可能判定（`can_add_approve?`）
  - 修正稟議の取下げ可能判定（`can_be_withdrawn_by?`）
  - 修正稟議と通常ENTRYの区別

- **データ整合性**:
  - ContractとEntryの値の同期（修正稟議が申請中の場合、値が異なる）
  - 修正稟議承認後の値の反映

- **DocuSign連携への影響**:
  - 修正稟議作成時のエンベロープ無効化処理
  - 修正稟議承認後の契約書再連携
  - 顧客・担当者への通知処理

**実装が必要な項目**:
- [ ] 修正稟議の判定ロジック
- [ ] 修正稟議の作成・編集・承認処理
- [ ] 修正稟議と既存処理の統合
- [ ] DocuSign連携への影響対応
- [ ] データ整合性の確保
- [ ] エラーハンドリング・ロールバック処理

---

## 🟢 比較的軽い工数で実行できる改善（低工数・簡単）

### 1. UI/UX改善

#### 1.1 画面表示の改善
**難易度**: ⭐⭐（低い）  
**工数目安**: 1-2週間

**具体例**:
- 画面レイアウトの調整
- フォーム入力項目の追加・削除
- ボタン配置の変更
- 表示項目の追加・削除

**比較的簡単な理由**:
- **単一システム内の変更**: AGNTシステム内のみの変更で完結
- **他システムへの影響なし**: データ構造の変更が不要
- **既存機能の拡張**: 新規機能開発ではなく、既存機能の改善

---

#### 1.2 画面仕様の検証・管理
**難易度**: ⭐（非常に低い）  
**工数目安**: 数日〜1週間

**具体例**:
- 画面仕様書の自動検証
- 画面スナップショットの取得・管理
- 画面仕様のドキュメント化

**参考事例**:
- AGNT画面仕様管理ツール: 約80画面以上の自動検証が可能

---

### 2. 既存機能の拡張

#### 2.1 既存機能への項目追加
**難易度**: ⭐⭐（低い）  
**工数目安**: 1-3週間

**具体例**:
- 顧客情報への項目追加
- タイムラインへの項目追加
- 検索条件の追加
- レポート項目の追加

**比較的簡単な理由**:
- **データベース変更が最小限**: 既存テーブルへのカラム追加程度
- **既存ロジックの再利用**: 新規ロジック開発が不要
- **影響範囲が限定的**: 特定機能への影響のみ

---

#### 2.2 バリデーション・入力チェックの追加
**難易度**: ⭐⭐（低い）  
**工数目安**: 1-2週間

**具体例**:
- 必須項目チェックの追加
- 入力形式チェック（メールアドレス、電話番号など）
- 数値範囲チェック

**比較的簡単な理由**:
- **フロントエンド/バックエンドの単純な追加**: 既存バリデーションロジックの拡張
- **他システムへの影響なし**: AGNTシステム内のみの変更

---

### 3. レポート・出力機能の追加

#### 3.1 既存データの出力形式変更
**難易度**: ⭐⭐（低い）  
**工数目安**: 1-2週間

**具体例**:
- CSV出力形式の変更
- PDF出力レイアウトの調整
- エクスポート項目の追加・削除

**比較的簡単な理由**:
- **既存データの活用**: 新規データ取得が不要
- **出力処理のみの変更**: データ処理ロジックへの影響が少ない

---

### 4. 通知・アラート機能の追加

#### 4.1 メール通知の追加
**難易度**: ⭐⭐（低い）  
**工数目安**: 1-2週間

**具体例**:
- 特定条件時のメール通知追加
- Slack通知の追加
- 通知タイミングの調整

**比較的簡単な理由**:
- **既存通知機能の拡張**: 新規通知システムの構築が不要
- **トリガー条件の追加**: 既存イベントへの通知追加のみ

**参考事例**:
- Slack通知機能: AGNT契約詳細からSlack通知を送信する機能は比較的簡単に実装可能

---

## 📊 改善の難易度評価マトリックス

| 改善タイプ | 難易度 | 工数目安 | 主な障壁 |
|-----------|--------|----------|----------|
| **稟議・契約モデル変更** | ⭐⭐⭐⭐⭐ | 3-6ヶ月以上 | ステータス遷移の複雑さ、コールバック処理、複数システムへの影響 |
| **システム間連携** | ⭐⭐⭐⭐⭐ | 3-6ヶ月以上 | データ構造不一致、同期タイミング、整合性確保 |
| **データ整合性・監査** | ⭐⭐⭐⭐ | 2-4ヶ月 | データベース設計、パフォーマンス、ストレージ |
| **大規模アーキテクチャ変更** | ⭐⭐⭐⭐⭐ | 6ヶ月以上 | データ移行、プロセス変更、影響範囲 |
| **外部サービス連携** | ⭐⭐⭐⭐ | 2-3ヶ月 | API仕様理解、コールバック処理、セキュリティ |
| **UI/UX改善** | ⭐⭐ | 1-2週間 | 単一システム内の変更、影響範囲が限定的 |
| **既存機能拡張** | ⭐⭐ | 1-3週間 | データベース変更が最小限、既存ロジック再利用 |
| **レポート・出力** | ⭐⭐ | 1-2週間 | 既存データの活用、出力処理のみの変更 |
| **通知・アラート** | ⭐⭐ | 1-2週間 | 既存通知機能の拡張、トリガー条件の追加 |

---

## ⚠️ 他システム連携を加味した評価

### 連携が必要な場合の工数増加

**基本原則**: 他システムとの連携が必要な改善は、**必ず工数が増加する**

#### 工数増加の要因

1. **要件定義・仕様調整**
   - 連携先システムの担当者との調整
   - データ形式・連携タイミングの合意形成
   - **追加工数**: 1-2週間

2. **技術調査・検証**
   - 連携先システムのAPI仕様調査
   - 接続テスト・動作確認
   - **追加工数**: 1-2週間

3. **エラーハンドリング・運用設計**
   - 連携エラー時の対応フロー設計
   - 監視・アラート機能の実装
   - **追加工数**: 1週間

4. **テスト・検証**
   - 連携テストの実施
   - データ整合性の確認
   - **追加工数**: 1-2週間

**合計追加工数**: **約1-2ヶ月**

---

### 連携が必要な改善例

#### 例1: 火災保険業務の改善
**改善内容**: 決済日の「見える化」、情報取得方法の改善

**連携が必要なシステム**:
- AGNT（顧客情報、契約情報）
- ファイナンスシート（決済情報）
- 保険会社システム（東京海上日動、日新火災）

**難易度**: ⭐⭐⭐⭐（高い）  
**工数目安**: 2-3ヶ月

**理由**:
- 複数システムからのデータ取得が必要
- データ形式の統一・変換が必要
- リアルタイム同期 vs バッチ同期の選択が必要

---

#### 例2: 顧客情報の一元管理
**改善内容**: AGNT、Salesforce、PPL間の顧客情報同期

**連携が必要なシステム**:
- AGNT（営業支援システム）
- Salesforce（CRM）
- PPL（顧客マスタ）
- Snowflake（データウェアハウス）

**難易度**: ⭐⭐⭐⭐⭐（非常に高い）  
**工数目安**: 3-6ヶ月以上

**理由**:
- 複数システム間のデータフロー構築が必要
- データ整合性の確保が複雑
- SnowflakeのSLA要件への対応が必要

---

## 💡 ヒアリング時の評価ポイント

### 改善の難易度を判断するための質問

**🔴 最重要チェック項目（稟議・契約モデル関連）**:

0. **稟議・契約モデルの変更は必要か？**
   - 必要 → **難易度が非常に高い（+3-6ヶ月）**。複数システムへの影響を必ず確認
   - ステータス遷移の変更 → 不可逆な遷移があるため、既存データへの影響が大きい
   - 修正稟議の処理 → 最も複雑で、DocuSign連携への影響も大きい
   - 不要 → 他のチェック項目に進む

**その他のチェック項目**:

1. **他システムとの連携は必要か？**
   - 必要 → 難易度が上がる（+1-2ヶ月）
   - 不要 → AGNT単体の変更で完結（比較的簡単）

2. **データ構造の変更は必要か？**
   - 必要 → データベース変更が必要（難易度が上がる）
   - 不要 → 既存データの活用のみ（比較的簡単）

3. **既存機能の拡張か、新規機能開発か？**
   - 既存機能の拡張 → 比較的簡単
   - 新規機能開発 → 難易度が上がる

4. **リアルタイム処理が必要か？**
   - 必要 → 同期処理の実装が必要（難易度が上がる）
   - 不要 → バッチ処理で対応可能（比較的簡単）

5. **外部サービス連携は必要か？**
   - 必要 → API仕様理解、コールバック処理が必要（難易度が上がる）
   - 不要 → AGNTシステム内のみの変更（比較的簡単）

---

## 📚 参考資料

### 関連ドキュメント

1. **システム統合関連**
   - `knowledge/technical/system_integration/2025-01-28_salesforce_customer_master_sync_strategy.md`
   - `knowledge/real_estate/property_management/2025-01-21_reco_property_integration_challenges.md`

2. **データ整合性関連**
   - `knowledge/technical/troubleshooting/2025-01-21_agnt_timeline_audit_system.md`
   - `knowledge/technical/troubleshooting/2025-01-21_agnt_timeline_data_integrity_solution.md`

3. **外部サービス連携関連**
   - `knowledge/technical/specifications/gmo_credit_card_payment_specification.md`
   - `private/projects/AGNT_2026_重要事項説明前の必要書類送付/documents/2_planning/discovery/solution_definition.md`

4. **プロジェクト管理関連**
   - `knowledge/project_management/lessons_learned/2025-01-21_pmi_integration_challenges.md`

---

## 🔄 更新履歴

| 日付 | 更新内容 | 更新者 |
|------|----------|--------|
| 2026-02-06 | 稟議・契約モデルの変更セクションを最上部に移動、構成を整理 | 佐藤 |
| 2026-02-06 | 稟議・契約モデルの変更に関する詳細を追加（ステータス遷移、データベーススキーマ、コールバック、修正稟議） | 佐藤 |
| 2026-02-06 | 初回作成（AGNT開発障壁と改善難易度評価） | 佐藤 |

---

**キーワード**: AGNT, 開発障壁, 改善難易度, システム連携, 工数評価, Outboundオペレーション
